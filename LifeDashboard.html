<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Life Dashboard â€” Fitness OS v6</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg0:#08080a;--bg1:#0e0e12;--bg2:#141418;--bg3:#1a1a20;--bg4:#222228;--b1:#1e1e24;--t0:#f4f4f6;--t1:#c8c8d0;--t2:#8888a0;--t3:#55556a;--lime:#b8f000;--blue:#5b9df5;--orange:#f5a623;--red:#f55353;--green:#34d399;--purple:#a78bfa;--cyan:#22d3ee;--pink:#f472b6}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg0);color:var(--t0);min-height:100vh;overflow-x:hidden}
#root{min-height:100vh}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg1)}::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
textarea{font-family:inherit;resize:vertical}select{-webkit-appearance:none;appearance:none}
input[type=number]::-webkit-inner-spin-button{opacity:1}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.sidebar{width:210px;min-height:100vh;background:var(--bg1);border-right:1px solid var(--b1);padding:20px 0;display:flex;flex-direction:column;position:fixed;left:0;top:0;bottom:0;z-index:10}
.main{margin-left:210px;flex:1;padding:24px 28px;min-height:100vh}
.mob-bar{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg1);border-top:1px solid var(--b1);z-index:20;padding:6px 0 max(6px,env(safe-area-inset-bottom))}
.mob-btn{display:none;position:fixed;top:14px;left:14px;z-index:15;background:var(--bg1);border:1px solid var(--b1);border-radius:8px;padding:8px 12px;color:var(--t0);font-size:1.1rem;cursor:pointer}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9}
@media(max-width:768px){
.sidebar{transform:translateX(-100%);transition:transform 0.3s ease;z-index:20}
.sidebar.open{transform:translateX(0)}
.sidebar-overlay.open{display:block;z-index:19}
.main{margin-left:0;padding:16px 12px;padding-bottom:80px;padding-top:56px}
.mob-bar{display:flex;justify-content:space-around;align-items:center}
.mob-btn{display:block}
.mob-login-banner{display:flex!important}
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
/* === FIREBASE CONFIG === */
/* INSTRUCCIONES: Reemplaza estos valores con los de tu proyecto Firebase
   1. Ve a https://console.firebase.google.com
   2. Crea un proyecto nuevo (o usa uno existente)
   3. En Project Settings > General, copia tu firebaseConfig
   4. En Authentication > Sign-in method, habilita Google
   5. En Firestore Database, crea una base de datos en modo producciÃ³n
   6. En Firestore > Rules, usa estas reglas:
      rules_version = '2';
      service cloud.firestore {
        match /databases/{database}/documents {
          match /users/{userId}/{document=**} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
          }
        }
      }
*/
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAE-sXFg0BAQgjJC6lUZuPtiw4M_8xmPpw",
  authDomain: "seguimiento-8de40.firebaseapp.com",
  projectId: "seguimiento-8de40",
  storageBucket: "seguimiento-8de40.firebasestorage.app",
  messagingSenderId: "673781980665",
  appId: "1:673781980665:web:0c6f31a34c3044b8a2f128",
  measurementId: "G-VB2JEDJEL3"
};

let fbApp, fbAuth, fbDb;
try {
  fbApp = firebase.initializeApp(FIREBASE_CONFIG);
  fbAuth = firebase.auth();
  fbDb = firebase.firestore();
  fbDb.enablePersistence({synchronizeTabs:true}).catch(()=>{});
} catch(e) { console.warn("Firebase init error:",e); }

const{useState,useEffect,useCallback,useRef}=React;
const uid=()=>"_"+Math.random().toString(36).slice(2,8);
const fmtD=d=>d.toISOString().split("T")[0];
const todayS=()=>fmtD(new Date());
const DOWS=["Lun","Mar","MiÃ©","Jue","Vie","SÃ¡b","Dom"];
const KEY="life-dashboard";
/* Migrate from old versioned keys */
(()=>{if(!localStorage.getItem("life-dashboard")){for(const k of["life-dashboard-v6","life-dashboard-v5","life-dashboard-v4"]){const d=localStorage.getItem(k);if(d){localStorage.setItem("life-dashboard",d);break}}}})();

/* === DEFAULTS === */
const DEF_DT=[
{id:"dt1",name:"Descanso",emoji:"ðŸ˜´",color:"#a78bfa",cal:2250,prot:170,carbs:220,fat:65,sugar:40,fiber:25,calMin:2250,calMax:2350},
{id:"dt2",name:"Pesas",emoji:"ðŸ‹ï¸",color:"#b8f000",cal:2250,prot:180,carbs:260,fat:65,sugar:40,fiber:25,calMin:2250,calMax:2350},
{id:"dt3",name:"Tenis/Padel",emoji:"ðŸŽ¾",color:"#5b9df5",cal:2250,prot:170,carbs:260,fat:65,sugar:40,fiber:25,calMin:2250,calMax:2350},
{id:"dt4",name:"Golf",emoji:"â›³",color:"#34d399",cal:2250,prot:160,carbs:240,fat:65,sugar:40,fiber:25,calMin:2250,calMax:2350},
{id:"dt5",name:"Pesas+Tenis/Padel",emoji:"ðŸ’ªðŸŽ¾",color:"#22d3ee",cal:2500,prot:180,carbs:280,fat:70,sugar:40,fiber:30,calMin:2500,calMax:2600},
{id:"dt6",name:"Pesas+Golf",emoji:"ðŸ’ªâ›³",color:"#f5a623",cal:2750,prot:180,carbs:300,fat:70,sugar:40,fiber:30,calMin:2750,calMax:2850}];

const DEF_GOALS=[
{id:"cut",name:"Cutting",cal:2250,prot:170,fat:65,carbs:220,sugar:40,fiber:25,trainingPerWeek:5},
{id:"bulk",name:"Bulking",cal:3000,prot:180,fat:80,carbs:350,sugar:50,fiber:30,trainingPerWeek:5},
{id:"mantenimiento",name:"Mantenimiento",cal:2500,prot:170,fat:70,carbs:280,sugar:45,fiber:25,trainingPerWeek:4},
{id:"personalizado",name:"Personalizado",cal:2250,prot:170,fat:65,carbs:220,sugar:40,fiber:25,trainingPerWeek:5}];

/* === BUILT-IN FOOD REFERENCE TABLE (per 100g) === */
const FOOD_DB=[
/* ===== COMIDA COLOMBIANA TÃPICA (por 100g) ===== */
/* -- Arepas y masas -- */
{"alimento":"Arepa blanca maÃ­z","estado":"Natural","kcal":218,"proteina_g":5,"grasas_g":2,"grasas_saturadas_g":0.4,"carbs_g":45,"azucar_g":1,"fibra_g":2,"sodio_mg":350,"colesterol_mg":0},
{"alimento":"Arepa de choclo","estado":"Natural","kcal":250,"proteina_g":5,"grasas_g":7,"grasas_saturadas_g":3,"carbs_g":42,"azucar_g":8,"fibra_g":2,"sodio_mg":280,"colesterol_mg":10},
{"alimento":"Arepa de queso","estado":"Natural","kcal":270,"proteina_g":8,"grasas_g":9,"grasas_saturadas_g":4,"carbs_g":40,"azucar_g":2,"fibra_g":2,"sodio_mg":450,"colesterol_mg":15},
{"alimento":"Arepa de huevo","estado":"Frita","kcal":310,"proteina_g":9,"grasas_g":15,"grasas_saturadas_g":4,"carbs_g":35,"azucar_g":1,"fibra_g":2,"sodio_mg":380,"colesterol_mg":95},
{"alimento":"Empanada colombiana","estado":"Frita","kcal":210,"proteina_g":5,"grasas_g":10,"grasas_saturadas_g":3,"carbs_g":25,"azucar_g":1,"fibra_g":2,"sodio_mg":320,"colesterol_mg":15},
{"alimento":"Empanada de pollo","estado":"Frita","kcal":220,"proteina_g":8,"grasas_g":11,"grasas_saturadas_g":3,"carbs_g":22,"azucar_g":1,"fibra_g":2,"sodio_mg":340,"colesterol_mg":25},
{"alimento":"BuÃ±uelo","estado":"Frito","kcal":350,"proteina_g":8,"grasas_g":18,"grasas_saturadas_g":5,"carbs_g":40,"azucar_g":3,"fibra_g":1,"sodio_mg":400,"colesterol_mg":20},
{"alimento":"Pandebono","estado":"Natural","kcal":320,"proteina_g":7,"grasas_g":12,"grasas_saturadas_g":5,"carbs_g":45,"azucar_g":5,"fibra_g":1,"sodio_mg":380,"colesterol_mg":25},
{"alimento":"AlmojÃ¡bana","estado":"Natural","kcal":310,"proteina_g":8,"grasas_g":10,"grasas_saturadas_g":4,"carbs_g":47,"azucar_g":6,"fibra_g":1,"sodio_mg":360,"colesterol_mg":20},
{"alimento":"Pan de bono","estado":"Natural","kcal":320,"proteina_g":7,"grasas_g":12,"grasas_saturadas_g":5,"carbs_g":45,"azucar_g":5,"fibra_g":1,"sodio_mg":380,"colesterol_mg":25},
{"alimento":"PatacÃ³n","estado":"Frito","kcal":270,"proteina_g":1.5,"grasas_g":12,"grasas_saturadas_g":3,"carbs_g":40,"azucar_g":2,"fibra_g":3,"sodio_mg":200,"colesterol_mg":0},
{"alimento":"Dedito de queso","estado":"Frito","kcal":330,"proteina_g":10,"grasas_g":18,"grasas_saturadas_g":7,"carbs_g":32,"azucar_g":1,"fibra_g":1,"sodio_mg":450,"colesterol_mg":25},
/* -- Platos principales colombianos -- */
{"alimento":"Bandeja paisa","estado":"Natural","kcal":220,"proteina_g":11,"grasas_g":11,"grasas_saturadas_g":4,"carbs_g":20,"azucar_g":2,"fibra_g":4,"sodio_mg":350,"colesterol_mg":50},
{"alimento":"Ajiaco bogotano","estado":"Natural","kcal":70,"proteina_g":5,"grasas_g":2,"grasas_saturadas_g":0.5,"carbs_g":8,"azucar_g":1,"fibra_g":1.5,"sodio_mg":280,"colesterol_mg":15},
{"alimento":"Sancocho de gallina","estado":"Natural","kcal":85,"proteina_g":6,"grasas_g":3,"grasas_saturadas_g":0.8,"carbs_g":9,"azucar_g":1,"fibra_g":1.5,"sodio_mg":300,"colesterol_mg":20},
{"alimento":"Caldo de costilla","estado":"Natural","kcal":65,"proteina_g":5,"grasas_g":3,"grasas_saturadas_g":1,"carbs_g":5,"azucar_g":0.5,"fibra_g":0.5,"sodio_mg":350,"colesterol_mg":15},
{"alimento":"Tamal colombiano","estado":"Natural","kcal":155,"proteina_g":7,"grasas_g":7,"grasas_saturadas_g":2,"carbs_g":18,"azucar_g":1,"fibra_g":2,"sodio_mg":380,"colesterol_mg":30},
{"alimento":"Tamal tolimense","estado":"Natural","kcal":165,"proteina_g":8,"grasas_g":8,"grasas_saturadas_g":2.5,"carbs_g":17,"azucar_g":1,"fibra_g":2,"sodio_mg":400,"colesterol_mg":35},
{"alimento":"Lechona","estado":"Natural","kcal":250,"proteina_g":18,"grasas_g":15,"grasas_saturadas_g":5,"carbs_g":12,"azucar_g":1,"fibra_g":1,"sodio_mg":420,"colesterol_mg":60},
{"alimento":"ChicharrÃ³n","estado":"Frito","kcal":540,"proteina_g":35,"grasas_g":44,"grasas_saturadas_g":16,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":500,"colesterol_mg":95},
{"alimento":"Morcilla colombiana","estado":"Cocida","kcal":260,"proteina_g":14,"grasas_g":17,"grasas_saturadas_g":6,"carbs_g":15,"azucar_g":1,"fibra_g":1,"sodio_mg":680,"colesterol_mg":120},
{"alimento":"Chorizo colombiano","estado":"Cocido","kcal":300,"proteina_g":14,"grasas_g":25,"grasas_saturadas_g":9,"carbs_g":3,"azucar_g":1,"fibra_g":0,"sodio_mg":750,"colesterol_mg":70},
{"alimento":"Sobrebarriga sudada","estado":"Cocida","kcal":210,"proteina_g":22,"grasas_g":12,"grasas_saturadas_g":5,"carbs_g":3,"azucar_g":1,"fibra_g":0.5,"sodio_mg":350,"colesterol_mg":75},
{"alimento":"Cazuela de frijoles","estado":"Natural","kcal":130,"proteina_g":8,"grasas_g":4,"grasas_saturadas_g":1.5,"carbs_g":17,"azucar_g":1,"fibra_g":5,"sodio_mg":400,"colesterol_mg":10},
/* -- TubÃ©rculos y acompaÃ±amientos colombianos -- */
{"alimento":"Yuca","estado":"Cocida","kcal":160,"proteina_g":1.4,"grasas_g":0.3,"grasas_saturadas_g":0.1,"carbs_g":38,"azucar_g":1.7,"fibra_g":1.8,"sodio_mg":14,"colesterol_mg":0},
{"alimento":"Yuca frita","estado":"Frita","kcal":280,"proteina_g":1.5,"grasas_g":12,"grasas_saturadas_g":2,"carbs_g":42,"azucar_g":2,"fibra_g":2,"sodio_mg":100,"colesterol_mg":0},
{"alimento":"PlÃ¡tano maduro frito","estado":"Frito","kcal":265,"proteina_g":1.2,"grasas_g":11,"grasas_saturadas_g":3,"carbs_g":42,"azucar_g":18,"fibra_g":2.5,"sodio_mg":5,"colesterol_mg":0},
{"alimento":"PlÃ¡tano maduro","estado":"Cocido","kcal":150,"proteina_g":1,"grasas_g":0.4,"grasas_saturadas_g":0.1,"carbs_g":38,"azucar_g":18,"fibra_g":2.5,"sodio_mg":4,"colesterol_mg":0},
{"alimento":"PlÃ¡tano verde","estado":"Cocido","kcal":130,"proteina_g":1.3,"grasas_g":0.4,"grasas_saturadas_g":0.1,"carbs_g":32,"azucar_g":2,"fibra_g":2.3,"sodio_mg":5,"colesterol_mg":0},
{"alimento":"Papa criolla","estado":"Cocida","kcal":90,"proteina_g":2,"grasas_g":0.1,"grasas_saturadas_g":0,"carbs_g":21,"azucar_g":1,"fibra_g":2,"sodio_mg":6,"colesterol_mg":0},
{"alimento":"Frijol rojo","estado":"Cocido","kcal":127,"proteina_g":8.7,"grasas_g":0.5,"grasas_saturadas_g":0.1,"carbs_g":22,"azucar_g":0.3,"fibra_g":7.4,"sodio_mg":2,"colesterol_mg":0},
{"alimento":"Lenteja","estado":"Cocida","kcal":116,"proteina_g":9,"grasas_g":0.4,"grasas_saturadas_g":0.1,"carbs_g":20,"azucar_g":1.8,"fibra_g":7.9,"sodio_mg":2,"colesterol_mg":0},
{"alimento":"Garbanzo","estado":"Cocido","kcal":164,"proteina_g":8.9,"grasas_g":2.6,"grasas_saturadas_g":0.3,"carbs_g":27,"azucar_g":4.8,"fibra_g":7.6,"sodio_mg":7,"colesterol_mg":0},
{"alimento":"Hogao","estado":"Natural","kcal":60,"proteina_g":1,"grasas_g":3,"grasas_saturadas_g":0.5,"carbs_g":7,"azucar_g":4,"fibra_g":1.5,"sodio_mg":250,"colesterol_mg":0},
/* -- Quesos colombianos -- */
{"alimento":"Queso campesino","estado":"Natural","kcal":310,"proteina_g":22,"grasas_g":24,"grasas_saturadas_g":15,"carbs_g":2,"azucar_g":1,"fibra_g":0,"sodio_mg":600,"colesterol_mg":80},
{"alimento":"Queso costeÃ±o","estado":"Natural","kcal":350,"proteina_g":25,"grasas_g":28,"grasas_saturadas_g":17,"carbs_g":1,"azucar_g":0.5,"fibra_g":0,"sodio_mg":1200,"colesterol_mg":90},
{"alimento":"Queso doble crema","estado":"Natural","kcal":295,"proteina_g":20,"grasas_g":23,"grasas_saturadas_g":14,"carbs_g":3,"azucar_g":2,"fibra_g":0,"sodio_mg":550,"colesterol_mg":75},
{"alimento":"Cuajada","estado":"Natural","kcal":174,"proteina_g":12,"grasas_g":13,"grasas_saturadas_g":8,"carbs_g":2,"azucar_g":2,"fibra_g":0,"sodio_mg":400,"colesterol_mg":45},
/* -- Frutas colombianas -- */
{"alimento":"Guayaba","estado":"Natural","kcal":68,"proteina_g":2.6,"grasas_g":1,"grasas_saturadas_g":0.3,"carbs_g":14,"azucar_g":9,"fibra_g":5.4,"sodio_mg":2,"colesterol_mg":0},
{"alimento":"Lulo","estado":"Natural","kcal":25,"proteina_g":0.6,"grasas_g":0.2,"grasas_saturadas_g":0,"carbs_g":5.7,"azucar_g":3,"fibra_g":1.1,"sodio_mg":3,"colesterol_mg":0},
{"alimento":"MaracuyÃ¡","estado":"Natural","kcal":97,"proteina_g":2.2,"grasas_g":0.7,"grasas_saturadas_g":0.1,"carbs_g":23,"azucar_g":11,"fibra_g":10,"sodio_mg":28,"colesterol_mg":0},
{"alimento":"Granadilla","estado":"Natural","kcal":94,"proteina_g":2.2,"grasas_g":0.7,"grasas_saturadas_g":0.1,"carbs_g":22,"azucar_g":11,"fibra_g":10,"sodio_mg":28,"colesterol_mg":0},
{"alimento":"Tomate de Ã¡rbol","estado":"Natural","kcal":31,"proteina_g":2,"grasas_g":0.4,"grasas_saturadas_g":0.1,"carbs_g":4,"azucar_g":3.5,"fibra_g":3.3,"sodio_mg":1,"colesterol_mg":0},
{"alimento":"Mora","estado":"Natural","kcal":43,"proteina_g":1.4,"grasas_g":0.5,"grasas_saturadas_g":0,"carbs_g":10,"azucar_g":4.9,"fibra_g":5.3,"sodio_mg":1,"colesterol_mg":0},
{"alimento":"GuanÃ¡bana","estado":"Natural","kcal":66,"proteina_g":1,"grasas_g":0.3,"grasas_saturadas_g":0.1,"carbs_g":17,"azucar_g":14,"fibra_g":3.3,"sodio_mg":14,"colesterol_mg":0},
{"alimento":"Papaya","estado":"Natural","kcal":43,"proteina_g":0.5,"grasas_g":0.3,"grasas_saturadas_g":0.1,"carbs_g":11,"azucar_g":8,"fibra_g":1.7,"sodio_mg":8,"colesterol_mg":0},
{"alimento":"Mango","estado":"Natural","kcal":60,"proteina_g":0.8,"grasas_g":0.4,"grasas_saturadas_g":0.1,"carbs_g":15,"azucar_g":14,"fibra_g":1.6,"sodio_mg":1,"colesterol_mg":0},
{"alimento":"Uchuva","estado":"Natural","kcal":53,"proteina_g":1.9,"grasas_g":0.7,"grasas_saturadas_g":0,"carbs_g":11,"azucar_g":8,"fibra_g":0,"sodio_mg":1,"colesterol_mg":0},
{"alimento":"Feijoa","estado":"Natural","kcal":55,"proteina_g":1,"grasas_g":0.6,"grasas_saturadas_g":0.1,"carbs_g":13,"azucar_g":8,"fibra_g":6.4,"sodio_mg":3,"colesterol_mg":0},
{"alimento":"Curuba","estado":"Natural","kcal":25,"proteina_g":0.6,"grasas_g":0.1,"grasas_saturadas_g":0,"carbs_g":6,"azucar_g":4,"fibra_g":1.5,"sodio_mg":5,"colesterol_mg":0},
{"alimento":"Pitahaya","estado":"Natural","kcal":50,"proteina_g":1.1,"grasas_g":0.4,"grasas_saturadas_g":0,"carbs_g":11,"azucar_g":8,"fibra_g":3,"sodio_mg":39,"colesterol_mg":0},
{"alimento":"Zapote","estado":"Natural","kcal":83,"proteina_g":0.4,"grasas_g":0.5,"grasas_saturadas_g":0.1,"carbs_g":20,"azucar_g":15,"fibra_g":5.3,"sodio_mg":10,"colesterol_mg":0},
/* -- Bebidas y dulces colombianos -- */
{"alimento":"Panela","estado":"Natural","kcal":362,"proteina_g":0.4,"grasas_g":0.1,"grasas_saturadas_g":0,"carbs_g":90,"azucar_g":85,"fibra_g":0,"sodio_mg":30,"colesterol_mg":0},
{"alimento":"Aguapanela","estado":"Natural","kcal":40,"proteina_g":0,"grasas_g":0,"grasas_saturadas_g":0,"carbs_g":10,"azucar_g":10,"fibra_g":0,"sodio_mg":5,"colesterol_mg":0},
{"alimento":"Bocadillo guayaba","estado":"Natural","kcal":270,"proteina_g":0.3,"grasas_g":0,"grasas_saturadas_g":0,"carbs_g":70,"azucar_g":67,"fibra_g":3,"sodio_mg":10,"colesterol_mg":0},
{"alimento":"Arequipe","estado":"Natural","kcal":315,"proteina_g":7,"grasas_g":8,"grasas_saturadas_g":5,"carbs_g":55,"azucar_g":50,"fibra_g":0,"sodio_mg":130,"colesterol_mg":30},
{"alimento":"Oblea con arequipe","estado":"Natural","kcal":400,"proteina_g":5,"grasas_g":8,"grasas_saturadas_g":4,"carbs_g":78,"azucar_g":55,"fibra_g":1,"sodio_mg":120,"colesterol_mg":15},
{"alimento":"Mazamorra","estado":"Natural","kcal":80,"proteina_g":1.5,"grasas_g":0.5,"grasas_saturadas_g":0.2,"carbs_g":18,"azucar_g":5,"fibra_g":1,"sodio_mg":15,"colesterol_mg":2},
{"alimento":"Natilla","estado":"Natural","kcal":160,"proteina_g":3,"grasas_g":4,"grasas_saturadas_g":2.5,"carbs_g":28,"azucar_g":20,"fibra_g":0,"sodio_mg":100,"colesterol_mg":15},
/* -- Marcas colombianas comunes -- */
{"alimento":"Leche AlquerÃ­a entera","estado":"Natural","kcal":61,"proteina_g":3.2,"grasas_g":3.3,"grasas_saturadas_g":2,"carbs_g":4.8,"azucar_g":4.8,"fibra_g":0,"sodio_mg":50,"colesterol_mg":12},
{"alimento":"Leche AlquerÃ­a deslactosada","estado":"Natural","kcal":44,"proteina_g":3.2,"grasas_g":1.5,"grasas_saturadas_g":1,"carbs_g":4.8,"azucar_g":4.8,"fibra_g":0,"sodio_mg":50,"colesterol_mg":8},
{"alimento":"Yogurt Alpina","estado":"Natural","kcal":80,"proteina_g":3,"grasas_g":2.5,"grasas_saturadas_g":1.5,"carbs_g":12,"azucar_g":11,"fibra_g":0,"sodio_mg":55,"colesterol_mg":10},
{"alimento":"Yogurt Alpina sin azÃºcar","estado":"Natural","kcal":50,"proteina_g":4,"grasas_g":2,"grasas_saturadas_g":1.2,"carbs_g":5,"azucar_g":4,"fibra_g":0,"sodio_mg":55,"colesterol_mg":8},
{"alimento":"Avena Alpina","estado":"Natural","kcal":70,"proteina_g":2,"grasas_g":1.5,"grasas_saturadas_g":0.8,"carbs_g":13,"azucar_g":9,"fibra_g":0.5,"sodio_mg":40,"colesterol_mg":5},
{"alimento":"Salchicha ZenÃº","estado":"Cocida","kcal":240,"proteina_g":11,"grasas_g":20,"grasas_saturadas_g":8,"carbs_g":4,"azucar_g":1,"fibra_g":0,"sodio_mg":900,"colesterol_mg":55},
{"alimento":"JamÃ³n ZenÃº","estado":"Natural","kcal":145,"proteina_g":14,"grasas_g":9,"grasas_saturadas_g":3.5,"carbs_g":2,"azucar_g":1,"fibra_g":0,"sodio_mg":980,"colesterol_mg":45},
{"alimento":"Galletas Tosh integral","estado":"Natural","kcal":440,"proteina_g":7,"grasas_g":15,"grasas_saturadas_g":5,"carbs_g":70,"azucar_g":18,"fibra_g":5,"sodio_mg":350,"colesterol_mg":0},
{"alimento":"PonquÃ© Ramo","estado":"Natural","kcal":400,"proteina_g":5,"grasas_g":18,"grasas_saturadas_g":8,"carbs_g":56,"azucar_g":32,"fibra_g":1,"sodio_mg":300,"colesterol_mg":40},
{"alimento":"Chocoramo","estado":"Natural","kcal":430,"proteina_g":5,"grasas_g":20,"grasas_saturadas_g":10,"carbs_g":60,"azucar_g":38,"fibra_g":2,"sodio_mg":280,"colesterol_mg":35},
{"alimento":"Leche condensada","estado":"Natural","kcal":321,"proteina_g":8,"grasas_g":8,"grasas_saturadas_g":5,"carbs_g":54,"azucar_g":54,"fibra_g":0,"sodio_mg":130,"colesterol_mg":34},
/* -- Otros alimentos populares en Colombia -- */
{"alimento":"CafÃ© negro","estado":"Natural","kcal":2,"proteina_g":0.1,"grasas_g":0,"grasas_saturadas_g":0,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":2,"colesterol_mg":0},
{"alimento":"Chocolate santafereÃ±o","estado":"Natural","kcal":55,"proteina_g":1.5,"grasas_g":2,"grasas_saturadas_g":1.2,"carbs_g":8,"azucar_g":7,"fibra_g":0.5,"sodio_mg":30,"colesterol_mg":3},
{"alimento":"Coco rallado","estado":"Natural","kcal":354,"proteina_g":3.3,"grasas_g":33,"grasas_saturadas_g":30,"carbs_g":15,"azucar_g":6,"fibra_g":9,"sodio_mg":20,"colesterol_mg":0},
{"alimento":"MaÃ­z tierno","estado":"Cocido","kcal":96,"proteina_g":3.4,"grasas_g":1.5,"grasas_saturadas_g":0.2,"carbs_g":19,"azucar_g":3.2,"fibra_g":2.7,"sodio_mg":1,"colesterol_mg":0},
{"alimento":"Envuelto de mazorca","estado":"Natural","kcal":200,"proteina_g":4,"grasas_g":6,"grasas_saturadas_g":2,"carbs_g":34,"azucar_g":8,"fibra_g":2,"sodio_mg":200,"colesterol_mg":15},
/* ===== FIN COMIDA COLOMBIANA ===== */
/* ===== ALIMENTOS GENERALES (por 100g) ===== */
{"alimento":"Lomo fino res","estado":"Crudo","kcal":120,"proteina_g":22,"grasas_g":3,"grasas_saturadas_g":1.2,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":55,"colesterol_mg":70},
{"alimento":"Lomo fino res","estado":"Cocido","kcal":190,"proteina_g":29,"grasas_g":7,"grasas_saturadas_g":3,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":60,"colesterol_mg":85},
{"alimento":"Pasta Barilla","estado":"Cruda","kcal":360,"proteina_g":12,"grasas_g":1.5,"grasas_saturadas_g":0.3,"carbs_g":72,"azucar_g":3,"fibra_g":3,"sodio_mg":5,"colesterol_mg":0},
{"alimento":"Pasta Barilla","estado":"Cocida","kcal":155,"proteina_g":5.5,"grasas_g":0.9,"grasas_saturadas_g":0.2,"carbs_g":31,"azucar_g":2,"fibra_g":1.8,"sodio_mg":1,"colesterol_mg":0},
{"alimento":"Arroz blanco","estado":"Cocido","kcal":130,"proteina_g":2.5,"grasas_g":0.3,"grasas_saturadas_g":0.1,"carbs_g":28,"azucar_g":0,"fibra_g":0.4,"sodio_mg":1,"colesterol_mg":0},
{"alimento":"Yogurt griego casero","estado":"Natural","kcal":97,"proteina_g":9,"grasas_g":5,"grasas_saturadas_g":3,"carbs_g":3.5,"azucar_g":3.5,"fibra_g":0,"sodio_mg":36,"colesterol_mg":20},
{"alimento":"Aceite oliva","estado":"Natural","kcal":884,"proteina_g":0,"grasas_g":100,"grasas_saturadas_g":14,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":2,"colesterol_mg":0},
{"alimento":"Huevo entero","estado":"Natural","kcal":155,"proteina_g":13,"grasas_g":11,"grasas_saturadas_g":3.3,"carbs_g":1.1,"azucar_g":1.1,"fibra_g":0,"sodio_mg":124,"colesterol_mg":373},
{"alimento":"Yema huevo","estado":"Natural","kcal":322,"proteina_g":16,"grasas_g":27,"grasas_saturadas_g":9.5,"carbs_g":3.6,"azucar_g":0.6,"fibra_g":0,"sodio_mg":48,"colesterol_mg":1085},
{"alimento":"Avena","estado":"Cruda","kcal":389,"proteina_g":17,"grasas_g":7,"grasas_saturadas_g":1.2,"carbs_g":66,"azucar_g":1,"fibra_g":10,"sodio_mg":2,"colesterol_mg":0},
{"alimento":"Crema de mani Wake Up","estado":"Natural","kcal":588,"proteina_g":25,"grasas_g":50,"grasas_saturadas_g":10,"carbs_g":20,"azucar_g":6,"fibra_g":6,"sodio_mg":400,"colesterol_mg":0},
{"alimento":"Tilapia","estado":"Cruda","kcal":96,"proteina_g":20,"grasas_g":1.7,"grasas_saturadas_g":0.6,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":52,"colesterol_mg":50},
{"alimento":"Tilapia","estado":"Cocida","kcal":128,"proteina_g":26,"grasas_g":2.7,"grasas_saturadas_g":0.8,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":60,"colesterol_mg":57},
{"alimento":"Salmon","estado":"Crudo","kcal":208,"proteina_g":20,"grasas_g":13,"grasas_saturadas_g":3,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":59,"colesterol_mg":55},
{"alimento":"Salmon","estado":"Cocido","kcal":232,"proteina_g":25,"grasas_g":14,"grasas_saturadas_g":3.1,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":63,"colesterol_mg":63},
{"alimento":"Costilla res","estado":"Cruda","kcal":291,"proteina_g":19,"grasas_g":24,"grasas_saturadas_g":10,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":70,"colesterol_mg":80},
{"alimento":"Costilla res","estado":"Cocida","kcal":330,"proteina_g":25,"grasas_g":27,"grasas_saturadas_g":11,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":80,"colesterol_mg":95},
{"alimento":"Pechuga pollo","estado":"Cruda","kcal":120,"proteina_g":22,"grasas_g":2.5,"grasas_saturadas_g":0.6,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":45,"colesterol_mg":60},
{"alimento":"Pechuga pollo","estado":"Cocida","kcal":165,"proteina_g":31,"grasas_g":3.6,"grasas_saturadas_g":1,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":70,"colesterol_mg":85},
{"alimento":"Muslo pollo","estado":"Cocido","kcal":209,"proteina_g":26,"grasas_g":11,"grasas_saturadas_g":3,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":90,"colesterol_mg":105},
{"alimento":"Carne molida res 90/10","estado":"Cruda","kcal":176,"proteina_g":26,"grasas_g":10,"grasas_saturadas_g":4,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":72,"colesterol_mg":75},
{"alimento":"Carne molida res 90/10","estado":"Cocida","kcal":217,"proteina_g":26,"grasas_g":12,"grasas_saturadas_g":5,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":85,"colesterol_mg":88},
{"alimento":"Atun en agua","estado":"Natural","kcal":116,"proteina_g":26,"grasas_g":1,"grasas_saturadas_g":0.3,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":247,"colesterol_mg":47},
{"alimento":"Atun en aceite","estado":"Natural","kcal":198,"proteina_g":29,"grasas_g":8,"grasas_saturadas_g":1.5,"carbs_g":0,"azucar_g":0,"fibra_g":0,"sodio_mg":350,"colesterol_mg":55},
{"alimento":"Queso mozzarella","estado":"Natural","kcal":280,"proteina_g":28,"grasas_g":17,"grasas_saturadas_g":11,"carbs_g":3,"azucar_g":1,"fibra_g":0,"sodio_mg":627,"colesterol_mg":79},
{"alimento":"Pan integral","estado":"Natural","kcal":247,"proteina_g":13,"grasas_g":4,"grasas_saturadas_g":0.7,"carbs_g":41,"azucar_g":6,"fibra_g":7,"sodio_mg":400,"colesterol_mg":0},
{"alimento":"Papa cocida","estado":"Natural","kcal":87,"proteina_g":2,"grasas_g":0.1,"grasas_saturadas_g":0,"carbs_g":20,"azucar_g":1,"fibra_g":2.2,"sodio_mg":6,"colesterol_mg":0},
{"alimento":"Aguacate","estado":"Natural","kcal":160,"proteina_g":2,"grasas_g":15,"grasas_saturadas_g":2,"carbs_g":9,"azucar_g":0.7,"fibra_g":7,"sodio_mg":7,"colesterol_mg":0},
{"alimento":"Almendras","estado":"Natural","kcal":579,"proteina_g":21,"grasas_g":50,"grasas_saturadas_g":4,"carbs_g":22,"azucar_g":4,"fibra_g":12,"sodio_mg":1,"colesterol_mg":0},
{"alimento":"Chia","estado":"Natural","kcal":486,"proteina_g":17,"grasas_g":31,"grasas_saturadas_g":3,"carbs_g":42,"azucar_g":0,"fibra_g":34,"sodio_mg":16,"colesterol_mg":0},
{"alimento":"Miel","estado":"Natural","kcal":304,"proteina_g":0.3,"grasas_g":0,"grasas_saturadas_g":0,"carbs_g":82,"azucar_g":82,"fibra_g":0,"sodio_mg":4,"colesterol_mg":0},
{"alimento":"Chocolate 70%","estado":"Natural","kcal":598,"proteina_g":8,"grasas_g":43,"grasas_saturadas_g":25,"carbs_g":46,"azucar_g":24,"fibra_g":11,"sodio_mg":20,"colesterol_mg":3},
{"alimento":"Proteina Whey","estado":"Polvo","kcal":390,"proteina_g":75,"grasas_g":6,"grasas_saturadas_g":3,"carbs_g":10,"azucar_g":6,"fibra_g":1,"sodio_mg":200,"colesterol_mg":60},
{"alimento":"Quinua cocida","estado":"Natural","kcal":120,"proteina_g":4.4,"grasas_g":1.9,"grasas_saturadas_g":0.2,"carbs_g":21,"azucar_g":0.9,"fibra_g":2.8,"sodio_mg":7,"colesterol_mg":0},
{"alimento":"Manzana","estado":"Natural","kcal":52,"proteina_g":0.3,"grasas_g":0.2,"grasas_saturadas_g":0,"carbs_g":14,"azucar_g":10,"fibra_g":2.4,"sodio_mg":1,"colesterol_mg":0},
{"alimento":"Fresa","estado":"Natural","kcal":32,"proteina_g":0.7,"grasas_g":0.3,"grasas_saturadas_g":0,"carbs_g":7.7,"azucar_g":4.9,"fibra_g":2,"sodio_mg":1,"colesterol_mg":0},
{"alimento":"Clara de huevo","estado":"Natural","kcal":52,"proteina_g":10.9,"grasas_g":0.2,"grasas_saturadas_g":0,"carbs_g":0.7,"azucar_g":0.7,"fibra_g":0,"sodio_mg":166,"colesterol_mg":0},
{"alimento":"Huevo frito","estado":"Cocido","kcal":196,"proteina_g":13.6,"grasas_g":15,"grasas_saturadas_g":4.3,"carbs_g":0.8,"azucar_g":0.8,"fibra_g":0,"sodio_mg":207,"colesterol_mg":401},
{"alimento":"Huevo revuelto","estado":"Cocido","kcal":166,"proteina_g":11.1,"grasas_g":12.2,"grasas_saturadas_g":3.9,"carbs_g":1.6,"azucar_g":1.4,"fibra_g":0,"sodio_mg":171,"colesterol_mg":356},
{"alimento":"Banano","estado":"Natural","kcal":89,"proteina_g":1.1,"grasas_g":0.3,"grasas_saturadas_g":0.1,"carbs_g":23,"azucar_g":12,"fibra_g":2.6,"sodio_mg":1,"colesterol_mg":0}
];

/* Food DB search: normalize text for fuzzy matching */
const normFood=s=>(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim();

/* Aliases for common food names â†’ canonical names in FOOD_DB */
const FOOD_ALIASES={
  /* Comida colombiana */
  "arepa":"arepa blanca maÃ­z","arepa blanca":"arepa blanca maÃ­z","arepa maiz":"arepa blanca maÃ­z","arepa de maiz":"arepa blanca maÃ­z",
  "arepa choclo":"arepa de choclo","arepa de chocolo":"arepa de choclo","arepa chocolo":"arepa de choclo",
  "arepa queso":"arepa de queso",
  "arepa huevo":"arepa de huevo","arepa e huevo":"arepa de huevo",
  "empanada":"empanada colombiana","empanadas":"empanada colombiana",
  "empanada pollo":"empanada de pollo","empanada de pollo":"empanada de pollo",
  "buÃ±uelo":"buÃ±uelo","bunuelo":"buÃ±uelo","buÃ±uelos":"buÃ±uelo",
  "pandebono":"pandebono","pan de bono":"pan de bono",
  "almojabana":"almojÃ¡bana","almojÃ¡banas":"almojÃ¡bana","almojabanas":"almojÃ¡bana",
  "patacon":"patacÃ³n","patacones":"patacÃ³n","tostones":"patacÃ³n",
  "dedito":"dedito de queso","deditos":"dedito de queso","deditos de queso":"dedito de queso",
  "bandeja paisa":"bandeja paisa","bandeja":"bandeja paisa",
  "ajiaco":"ajiaco bogotano",
  "sancocho":"sancocho de gallina","sancocho gallina":"sancocho de gallina",
  "caldo de costilla":"caldo de costilla","caldo costilla":"caldo de costilla",
  "tamal":"tamal colombiano","tamales":"tamal colombiano",
  "tamal tolimense":"tamal tolimense",
  "lechona":"lechona",
  "chicharron":"chicharrÃ³n","chicharrones":"chicharrÃ³n",
  "morcilla":"morcilla colombiana",
  "chorizo":"chorizo colombiano","chorizos":"chorizo colombiano",
  "sobrebarriga":"sobrebarriga sudada",
  "frijoles":"cazuela de frijoles","cazuela frijoles":"cazuela de frijoles","frijol":"frijol rojo",
  "lentejas":"lenteja","lenteja":"lenteja",
  "garbanzo":"garbanzo","garbanzos":"garbanzo",
  "hogao":"hogao","guiso":"hogao",
  "yuca":"yuca","cassava":"yuca",
  "yuca frita":"yuca frita",
  "platano maduro":"plÃ¡tano maduro frito","maduro":"plÃ¡tano maduro frito","maduros":"plÃ¡tano maduro frito","tajadas":"plÃ¡tano maduro frito",
  "platano verde":"plÃ¡tano verde","verde":"plÃ¡tano verde",
  "papa criolla":"papa criolla","papas criollas":"papa criolla","criolla":"papa criolla",
  "queso campesino":"queso campesino",
  "queso costeÃ±o":"queso costeÃ±o","queso costeno":"queso costeÃ±o",
  "queso doble crema":"queso doble crema",
  "cuajada":"cuajada",
  "guayaba":"guayaba",
  "lulo":"lulo","naranjilla":"lulo",
  "maracuya":"maracuyÃ¡","maracuyÃ¡":"maracuyÃ¡",
  "granadilla":"granadilla",
  "tomate de arbol":"tomate de Ã¡rbol","tomate arbol":"tomate de Ã¡rbol",
  "mora":"mora","blackberry":"mora",
  "guanabana":"guanÃ¡bana","guanÃ¡bana":"guanÃ¡bana",
  "papaya":"papaya",
  "mango":"mango",
  "uchuva":"uchuva","physalis":"uchuva",
  "feijoa":"feijoa",
  "curuba":"curuba",
  "pitahaya":"pitahaya","pitaya":"pitahaya","dragon fruit":"pitahaya",
  "zapote":"zapote",
  "panela":"panela","aguapanela":"aguapanela","agua panela":"aguapanela","agua de panela":"aguapanela",
  "bocadillo":"bocadillo guayaba","bocadillo guayaba":"bocadillo guayaba",
  "arequipe":"arequipe","dulce de leche":"arequipe",
  "oblea":"oblea con arequipe","obleas":"oblea con arequipe",
  "mazamorra":"mazamorra",
  "natilla":"natilla",
  "leche":"leche alquerÃ­a entera","leche entera":"leche alquerÃ­a entera","leche alqueria":"leche alquerÃ­a entera",
  "leche deslactosada":"leche alquerÃ­a deslactosada",
  "yogurt alpina":"yogurt alpina","alpina":"yogurt alpina",
  "avena alpina":"avena alpina",
  "salchicha":"salchicha zenÃº","salchichas":"salchicha zenÃº","salchicha zenu":"salchicha zenÃº",
  "jamon":"jamÃ³n zenÃº","jamÃ³n":"jamÃ³n zenÃº","jamon zenu":"jamÃ³n zenÃº",
  "tosh":"galletas tosh integral","galletas tosh":"galletas tosh integral",
  "ponque":"ponquÃ© ramo","ponque ramo":"ponquÃ© ramo","ponquÃ©":"ponquÃ© ramo",
  "chocoramo":"chocoramo",
  "leche condensada":"leche condensada",
  "cafe":"cafÃ© negro","cafÃ©":"cafÃ© negro","tinto":"cafÃ© negro","coffee":"cafÃ© negro",
  "chocolate santafereÃ±o":"chocolate santafereÃ±o","chocolate caliente":"chocolate santafereÃ±o",
  "coco":"coco rallado",
  "mazorca":"maÃ­z tierno","maiz":"maÃ­z tierno","choclo":"maÃ­z tierno",
  "envuelto":"envuelto de mazorca","envueltos":"envuelto de mazorca",
  /* Alimentos generales */
  "pollo":"pechuga pollo","chicken":"pechuga pollo","breast":"pechuga pollo","pechuga":"pechuga pollo",
  "muslo":"muslo pollo","thigh":"muslo pollo",
  "lomo":"lomo fino res","tenderloin":"lomo fino res","filete":"lomo fino res",
  "res":"lomo fino res","beef":"lomo fino res",
  "costilla":"costilla res","ribs":"costilla res",
  "carne molida":"carne molida res 90/10","molida":"carne molida res 90/10","ground beef":"carne molida res 90/10",
  "arroz":"arroz blanco","rice":"arroz blanco",
  "pasta":"pasta barilla","spaghetti":"pasta barilla","espagueti":"pasta barilla","fideo":"pasta barilla",
  "avena":"avena","oats":"avena","oatmeal":"avena",
  "huevo":"huevo entero","egg":"huevo entero","huevos":"huevo entero",
  "yema":"yema huevo","yolk":"yema huevo",
  "yogurt":"yogurt griego casero","yogur":"yogurt griego casero","greek yogurt":"yogurt griego casero",
  "aceite":"aceite oliva","olive oil":"aceite oliva",
  "crema de mani":"crema de mani wake up","mantequilla de mani":"crema de mani wake up","peanut butter":"crema de mani wake up",
  "tilapia":"tilapia","fish":"tilapia",
  "salmon":"salmon","salmÃ³n":"salmon",
  "atun":"atun en agua","tuna":"atun en agua",
  "queso":"queso mozzarella","mozzarella":"queso mozzarella","cheese":"queso mozzarella",
  "pan":"pan integral","bread":"pan integral","pan integral":"pan integral",
  "papa":"papa cocida","potato":"papa cocida","patata":"papa cocida",
  "aguacate":"aguacate","avocado":"aguacate",
  "almendras":"almendras","almonds":"almendras",
  "chia":"chia","chÃ­a":"chia",
  "miel":"miel","honey":"miel",
  "chocolate":"chocolate 70%",
  "whey":"proteina whey","proteina":"proteina whey","protein":"proteina whey",
  "quinua":"quinua cocida","quinoa":"quinua cocida",
  "manzana":"manzana","apple":"manzana",
  "fresa":"fresa","strawberry":"fresa","fresas":"fresa",
  "clara":"clara de huevo","claras":"clara de huevo","clara de huevo":"clara de huevo","egg white":"clara de huevo",
  "huevo frito":"huevo frito","frito":"huevo frito","fried egg":"huevo frito",
  "huevo revuelto":"huevo revuelto","revueltos":"huevo revuelto","scrambled":"huevo revuelto",
  "banano":"banano","banana":"banano","guineo":"banano","platano":"banano"
};

/* Search food in personal DB (priority 1) then reference table (priority 2).
   Returns {match, source:"personal"|"referencia", entry} or null */
const searchFoodMatch=(query, personalFoods)=>{
  const q=normFood(query);
  /* Check aliases first */
  const aliasKey=Object.keys(FOOD_ALIASES).find(a=>q.includes(normFood(a)));
  const canonical=aliasKey?normFood(FOOD_ALIASES[aliasKey]):q;

  /* Determine cooking state from query */
  const rawWords=["crudo","cruda","raw"];
  const cookedWords=["cocido","cocida","cooked","asado","asada","a la plancha","grilled","horneado","horneada"];
  const isRaw=rawWords.some(w=>q.includes(w));
  const isCooked=cookedWords.some(w=>q.includes(w));
  /* Default: cocido for meats/grains, natural for others */
  const preferState=isRaw?"Crudo":isCooked?"Cocido":null;

  const scoreMatch=(entry)=>{
    const name=normFood(entry.alimento);
    let score=0;
    if(name===canonical)score=100;
    else if(canonical.includes(name)||name.includes(canonical))score=80;
    else{
      const words=canonical.split(" ");
      const nameWords=name.split(" ");
      const matched=words.filter(w=>nameWords.some(nw=>nw.includes(w)||w.includes(nw)));
      score=matched.length>0?(matched.length/Math.max(words.length,nameWords.length))*60:0;
    }
    /* Boost for matching state */
    if(preferState&&normFood(entry.estado)===normFood(preferState))score+=10;
    else if(!preferState&&["Cocido","Cocida","Natural","Polvo"].includes(entry.estado))score+=5;
    return score;
  };

  /* Search personal foods first */
  if(personalFoods&&personalFoods.length>0){
    let best=null,bestScore=0;
    personalFoods.forEach(f=>{const s=scoreMatch(f);if(s>bestScore){bestScore=s;best=f}});
    if(best&&bestScore>=40)return{match:best,source:"personal",score:bestScore};
  }
  /* Then search reference table */
  let best=null,bestScore=0;
  FOOD_DB.forEach(f=>{const s=scoreMatch(f);if(s>bestScore){bestScore=s;best=f}});
  if(best&&bestScore>=40)return{match:best,source:"referencia",score:bestScore};
  return null;
};

/* Default portions (grams) when user doesn't specify */
const DEFAULT_PORTIONS={
  /* Colombianos */
  "arepa blanca maÃ­z":120,"arepa de choclo":120,"arepa de queso":120,"arepa de huevo":150,
  "empanada colombiana":70,"empanada de pollo":70,
  "buÃ±uelo":50,"pandebono":60,"almojÃ¡bana":60,"pan de bono":60,
  "patacÃ³n":100,"dedito de queso":40,
  "bandeja paisa":650,"ajiaco bogotano":400,"sancocho de gallina":450,"caldo de costilla":350,
  "tamal colombiano":250,"tamal tolimense":300,"lechona":200,
  "chicharrÃ³n":60,"morcilla colombiana":100,"chorizo colombiano":80,
  "sobrebarriga sudada":150,"cazuela de frijoles":200,
  "yuca":150,"yuca frita":150,
  "plÃ¡tano maduro frito":120,"plÃ¡tano maduro":120,"plÃ¡tano verde":120,
  "papa criolla":150,"frijol rojo":170,"lenteja":170,"garbanzo":170,"hogao":50,
  "queso campesino":30,"queso costeÃ±o":30,"queso doble crema":30,"cuajada":50,
  "guayaba":150,"lulo":60,"maracuyÃ¡":50,"granadilla":50,"tomate de Ã¡rbol":80,
  "mora":150,"guanÃ¡bana":150,"papaya":200,"mango":200,"uchuva":80,"feijoa":100,"curuba":50,"pitahaya":150,"zapote":150,
  "panela":30,"aguapanela":250,"bocadillo guayaba":40,"arequipe":30,"oblea con arequipe":60,
  "mazamorra":250,"natilla":150,
  "leche alquerÃ­a entera":250,"leche alquerÃ­a deslactosada":250,
  "yogurt alpina":200,"yogurt alpina sin azÃºcar":200,"avena alpina":250,
  "salchicha zenÃº":50,"jamÃ³n zenÃº":30,"galletas tosh integral":30,
  "ponquÃ© ramo":65,"chocoramo":65,"leche condensada":20,
  "cafÃ© negro":250,"chocolate santafereÃ±o":250,"coco rallado":30,
  "maÃ­z tierno":150,"envuelto de mazorca":120,
  /* Generales */
  "huevo entero":50,"yema huevo":17,"clara de huevo":33,"huevo frito":50,"huevo revuelto":50,
  "aceite oliva":14,"crema de mani wake up":32,
  "pan integral":30,"manzana":180,"fresa":150,"miel":21,
  "chocolate 70%":30,"proteina whey":30,"chia":15,"almendras":30,"aguacate":80,
  "queso mozzarella":30,"atun en agua":80,"atun en aceite":80,"banano":120
};

const DEF_S={planName:"Mini-Cut 6 Semanas",planGoal:"20% â†’ 15% Body Fat",startWeight:73.7,goalWeight:71.0,startWaist:87.5,cutWeeks:6,startDate:"2026-02-01",trainingPerWeek:5,protRange:[153,999],fatRange:[0,75],carbRange:[0,999],sugarRange:[0,40],fiberRange:[20,999],goalProfiles:DEF_GOALS,activeGoalProfile:"cut",geminiApiKey:"",groqApiKey:"",aiProvider:"gemini",aiPrompt:""};

const DEF_HAB=[
{id:"h1",name:"Gym / Pesas",emoji:"ðŸ’ª",meta:"5x/semana",active:true},
{id:"h2",name:"Lectura",emoji:"ðŸ“–",meta:"30 min/dÃ­a",active:true},
{id:"h3",name:"PÃ¡del / Tenis",emoji:"ðŸŽ¾",meta:"2x/semana",active:true},
{id:"h4",name:"Estudiar",emoji:"ðŸ§ ",meta:"1 hora/dÃ­a",active:true},
{id:"h5",name:"Agua 3L",emoji:"ðŸ’§",meta:"Diario",active:true},
{id:"h6",name:"Dormir 7h+",emoji:"ðŸ˜´",meta:"Diario",active:true}];

const DEF_PROJ=[
{id:"p1",name:"Asorsalud Web",status:"En progreso",progress:72,priority:"Alta",category:"Web Dev",deadline:"2026-03-15",notes:"RediseÃ±o web $22M COP",tasks:[{id:uid(),t:"AnÃ¡lisis sitio actual",s:"done",note:"",dl:""},{id:uid(),t:"Propuesta ejecutiva",s:"done",note:"",dl:""},{id:uid(),t:"FotografÃ­a profesional",s:"progress",note:"Contactar fotÃ³grafo",dl:"2026-03-01"},{id:uid(),t:"Desarrollo frontend",s:"pending",note:"",dl:""},{id:uid(),t:"IntegraciÃ³n sistemas",s:"pending",note:"",dl:""},{id:uid(),t:"Testing y lanzamiento",s:"pending",note:"",dl:""}]},
{id:"p2",name:"Canchas de PÃ¡del",status:"En progreso",progress:55,priority:"Alta",category:"InversiÃ³n",deadline:"2026-04-01",notes:"8 canchas, $250K inversiÃ³n",tasks:[{id:uid(),t:"Modelo DCF + escenarios",s:"done",note:"",dl:""},{id:uid(),t:"AnÃ¡lisis de sensibilidad",s:"done",note:"",dl:""},{id:uid(),t:"Pitch deck inversionistas",s:"progress",note:"Preparar para marzo",dl:"2026-03-15"},{id:uid(),t:"ValidaciÃ³n de mercado",s:"pending",note:"",dl:""},{id:uid(),t:"BÃºsqueda de ubicaciÃ³n",s:"pending",note:"",dl:""},{id:uid(),t:"Plan operativo",s:"pending",note:"",dl:""}]}];

const DEF_BOOKS=[
{id:"b1",title:"Atomic Habits",author:"James Clear",status:"reading",progress:65,genre:"Productividad",rating:5,startDate:"2026-01-10",notes:"Excelente para hÃ¡bitos"},
{id:"b2",title:"The Lean Startup",author:"Eric Ries",status:"reading",progress:30,genre:"Negocios",rating:4,startDate:"2026-01-25",notes:"Aplica para canchas de pÃ¡del"},
{id:"b3",title:"Deep Work",author:"Cal Newport",status:"queue",progress:0,genre:"Productividad",rating:0,startDate:"",notes:""},
{id:"b4",title:"$100M Offers",author:"Alex Hormozi",status:"queue",progress:0,genre:"Negocios",rating:0,startDate:"",notes:""},
{id:"b5",title:"Meditations",author:"Marcus Aurelius",status:"queue",progress:0,genre:"FilosofÃ­a",rating:0,startDate:"",notes:""}];

const DEF_RL=[{id:uid(),date:"2026-02-07",book:"Atomic Habits",pages:15,minutes:30,notes:"Identity-based habits"},{id:uid(),date:"2026-02-06",book:"The Lean Startup",pages:20,minutes:35,notes:"MVP y Build-Measure-Learn"},{id:uid(),date:"2026-02-05",book:"Atomic Habits",pages:12,minutes:25,notes:"Habit stacking"}];

const DEF_HOR=[
{hour:"6:00",slots:["","Gym ðŸ’ª","","Gym ðŸ’ª","","Gym ðŸ’ª",""]},
{hour:"7:00",slots:["Gym ðŸ’ª","","Gym ðŸ’ª","","Gym ðŸ’ª","",""]},
{hour:"8:00",slots:["","","","","","PÃ¡del ðŸŽ¾",""]},
{hour:"9:00",slots:["Deep Work","Deep Work","Deep Work","Deep Work","Deep Work","",""]},
{hour:"10:00",slots:["Deep Work","Deep Work","Deep Work","Deep Work","Deep Work","",""]},
{hour:"11:00",slots:["Reuniones","","Reuniones","","Reuniones","",""]},
{hour:"12:00",slots:["Almuerzo ðŸ½ï¸","Almuerzo ðŸ½ï¸","Almuerzo ðŸ½ï¸","Almuerzo ðŸ½ï¸","Almuerzo ðŸ½ï¸","",""]},
{hour:"14:00",slots:["Proyectos ðŸ’¼","Proyectos ðŸ’¼","Proyectos ðŸ’¼","Proyectos ðŸ’¼","Proyectos ðŸ’¼","",""]},
{hour:"16:00",slots:["Estudiar ðŸ“š","","Estudiar ðŸ“š","","Estudiar ðŸ“š","",""]},
{hour:"17:00",slots:["","Tenis ðŸŽ¾","","","","",""]},
{hour:"19:00",slots:["Lectura ðŸ“–","Lectura ðŸ“–","Lectura ðŸ“–","Lectura ðŸ“–","Lectura ðŸ“–","",""]},
{hour:"21:00",slots:["Descanso ðŸ˜´","Descanso ðŸ˜´","Descanso ðŸ˜´","Descanso ðŸ˜´","Descanso ðŸ˜´","Libre âœ¨","Libre âœ¨"]}];

const DEF_FL=[
{date:"2026-02-01",week:"S1",dayType:"dt1",weight:73.7,waist:87.5,cal:2763,prot:172,fat:99,carbs:287,sugar:15,fiber:0,steps:12160,sleep:"",notes:""},
{date:"2026-02-02",week:"S1",dayType:"dt2",weight:73.7,waist:87.5,cal:2553,prot:180,fat:55,carbs:319,sugar:7,fiber:0,steps:11459,sleep:"",notes:""},
{date:"2026-02-03",week:"S1",dayType:"dt6",weight:73.7,waist:87.5,cal:2803,prot:187,fat:73,carbs:348,sugar:39,fiber:0,steps:20535,sleep:"",notes:""},
{date:"2026-02-04",week:"S1",dayType:"dt2",weight:73.7,waist:87.5,cal:2330,prot:180,fat:76,carbs:242,sugar:40,fiber:0,steps:15150,sleep:"",notes:""},
{date:"2026-02-05",week:"S1",dayType:"dt2",weight:73.2,waist:87.5,cal:2310,prot:175,fat:62,carbs:241,sugar:42,fiber:0,steps:10795,sleep:"",notes:""},
{date:"2026-02-06",week:"S1",dayType:"dt2",weight:73.2,waist:87.5,cal:2331,prot:178,fat:84,carbs:217,sugar:30,fiber:0,steps:11380,sleep:"",notes:""},
{date:"2026-02-07",week:"S1",dayType:"dt1",weight:73.0,waist:87.0,cal:2094,prot:184,fat:81,carbs:161,sugar:38,fiber:0,steps:9333,sleep:"",notes:""},
{date:"2026-02-08",week:"S2",dayType:"dt1",weight:73.0,waist:87.0,cal:2368,prot:168,fat:125,carbs:140,sugar:10,fiber:0,steps:12000,sleep:"",notes:""},
{date:"2026-02-09",week:"S2",dayType:"dt2",weight:72.5,waist:87.0,cal:0,prot:0,fat:0,carbs:0,sugar:0,fiber:0,steps:0,sleep:"",notes:""}];

const DEF_TT=[{id:"tt1",task:"SesiÃ³n de pesas â€” Upper body",cat:"Gym",done:false},{id:"tt2",task:"Revisar propuesta Asorsalud",cat:"Trabajo",done:false},{id:"tt3",task:"Llamada canchas de pÃ¡del",cat:"Trabajo",done:false},{id:"tt4",task:"Leer 30 min",cat:"Lectura",done:false},{id:"tt5",task:"Registrar macros del dÃ­a",cat:"Fitness",done:false},{id:"tt6",task:"Estudiar 1 hora",cat:"Estudio",done:false}];

const DEF={settings:DEF_S,dayTypes:DEF_DT,habits:DEF_HAB,habitWeekly:{},projects:DEF_PROJ,books:DEF_BOOKS,readingLog:DEF_RL,horario:DEF_HOR,fitnessLog:DEF_FL,todayTasks:DEF_TT,journal:{},personalFoods:[]};

/* === DEEP MERGE helper === */
const deepMerge=(p)=>{
  const merged={};for(const k of Object.keys(DEF)){
  if(p[k]===undefined||p[k]===null){merged[k]=DEF[k]}
  else if(k==="settings"){merged[k]={...DEF_S,...p[k]}}
  else if(k==="dayTypes"){merged[k]=p[k].map(t=>({...DEF_DT.find(d=>d.id===t.id)||{},...t}))}
  else{merged[k]=p[k]}
  }return merged;
};

function App(){
const[D,setD]=useState(null);const[ld,setLd]=useState(true);const[pg,setPg]=useState("dashboard");const[modal,setModal]=useState(null);const[sideOpen,setSideOpen]=useState(false);
/* Auth state */
const[user,setUser]=useState(null);const[authLoading,setAuthLoading]=useState(true);
const[syncStatus,setSyncStatus]=useState("offline"); /* synced | syncing | offline | error */
const[syncError,setSyncError]=useState("");
const saveTimer=useRef(null);
/* Global date filters â€” persist across page switches */
const[gFitFrom,setGFitFrom]=useState("");const[gFitTo,setGFitTo]=useState("");
const[gTrendFrom,setGTrendFrom]=useState("");const[gTrendTo,setGTrendTo]=useState("");
const[gRepFrom,setGRepFrom]=useState("");const[gRepTo,setGRepTo]=useState("");
const[gHabFrom,setGHabFrom]=useState("");const[gHabTo,setGHabTo]=useState("");

/* Listen to Firebase auth state + handle redirect result */
useEffect(()=>{
  if(!fbAuth){setAuthLoading(false);return}
  /* Handle redirect result (mobile login returns here) */
  fbAuth.getRedirectResult().catch(e=>{setSyncError("Auth redirect: "+e.message)});
  const unsub=fbAuth.onAuthStateChanged(u=>{setUser(u);setAuthLoading(false)});
  return()=>unsub();
},[]);

/* Load data: real-time Firestore listener if logged in, else localStorage */
const skipNextSnapshot=useRef(false);
useEffect(()=>{
  if(authLoading)return;
  const loadLocal=()=>{
    try{const s=localStorage.getItem(KEY);if(s){setD(deepMerge(JSON.parse(s)))}else setD({...DEF})}catch{setD({...DEF})}
    setSyncStatus("offline");setLd(false);
  };
  if(user&&fbDb){
    setSyncStatus("syncing");
    /* Real-time listener: syncs changes across devices */
    const unsub=fbDb.collection("users").doc(user.uid).onSnapshot(doc=>{
      if(skipNextSnapshot.current){skipNextSnapshot.current=false;return}
      if(doc.exists){
        const p=doc.data();const merged=deepMerge(p);
        setD(merged);localStorage.setItem(KEY,JSON.stringify(merged));
        setSyncError("");
      } else{/* First time: upload localStorage data to Firestore */
        const local=localStorage.getItem(KEY);const parsed=local?deepMerge(JSON.parse(local)):{...DEF};
        setD(parsed);fbDb.collection("users").doc(user.uid).set(parsed).catch(er=>{setSyncError("Save: "+er.message)});
      }
      setSyncStatus("synced");setLd(false);
    },err=>{setSyncError("Firestore: "+err.message);loadLocal()});
    return()=>unsub();
  } else { loadLocal(); }
},[user,authLoading]);

/* Save function: localStorage + Firestore (debounced) */
const sv=useCallback(nd=>{
  setD(nd);
  try{localStorage.setItem(KEY,JSON.stringify(nd))}catch{}
  if(user&&fbDb){
    setSyncStatus("syncing");
    if(saveTimer.current)clearTimeout(saveTimer.current);
    saveTimer.current=setTimeout(()=>{
      skipNextSnapshot.current=true;
      fbDb.collection("users").doc(user.uid).set(nd).then(()=>setSyncStatus("synced")).catch(()=>{skipNextSnapshot.current=false;setSyncStatus("error")});
    },1500);
  }
},[user]);

/* Auth helpers */
const signIn=()=>{if(!fbAuth)return setSyncError("Firebase no configurado. Edita FIREBASE_CONFIG en el HTML.");
  const provider=new firebase.auth.GoogleAuthProvider();
  fbAuth.signInWithPopup(provider).catch(e=>{
    /* If popup blocked (common on mobile), fall back to redirect */
    if(e.code==="auth/popup-blocked"||e.code==="auth/popup-closed-by-browser"||e.code==="auth/cancelled-popup-request"){
      fbAuth.signInWithRedirect(provider);
    } else { setSyncError("Login: "+e.code+" - "+e.message) }
  })};
const signOut=()=>{if(fbAuth)fbAuth.signOut()};
const go=p=>{setPg(p);setSideOpen(false)};

const S=D?.settings||DEF_S;const dayTypes=D?.dayTypes||DEF_DT;const fl=D?.fitnessLog||[];const habits=D?.habits||DEF_HAB;const projects=D?.projects||DEF_PROJ;const books=D?.books||DEF_BOOKS;const readingLog=D?.readingLog||[];const horario=D?.horario||DEF_HOR;const journal=D?.journal||{};const hw=D?.habitWeekly||{};const personalFoods=D?.personalFoods||[];

const getDT=id=>dayTypes.find(t=>t.id===id)||dayTypes[0];
/* Compliance: P,G,C,S use global intervals; K (cal) uses per-day-type calMin/calMax */
const chkComp=(e)=>{
  const pr=S.protRange||[153,999],fr=S.fatRange||[0,75],cr=S.carbRange||[0,999],sr=S.sugarRange||[0,40],fbr=S.fiberRange||[20,999];
  const dt=getDT(e.dayType);
  const p=(+e.prot||0)>=pr[0]&&(+e.prot||0)<=pr[1]?1:0;
  const g=(+e.fat||0)>=fr[0]&&(+e.fat||0)<=fr[1]?1:0;
  const c=(+e.carbs||0)>=cr[0]&&(+e.carbs||0)<=cr[1]?1:0;
  const su=(+e.sugar||0)>=sr[0]&&(+e.sugar||0)<=sr[1]?1:0;
  const fb=(+e.fiber||0)>=fbr[0]&&(+e.fiber||0)<=fbr[1]?1:0;
  const k=(+e.cal||0)>=(dt.calMin||0)&&(+e.cal||0)<=(dt.calMax||99999)?1:0;
  return{p,g,c,s:su,fb,k,day:p+g+c+su+fb+k>=4?1:0};
};

const latest=fl.length>0?fl[fl.length-1]:{weight:S.startWeight,waist:S.startWaist};
const curW=+(latest.weight||S.startWeight);const curWaist=+(latest.waist||S.startWaist);const wLost=(S.startWeight-curW).toFixed(1);
const dayN=Math.max(1,Math.floor((new Date()-new Date(S.startDate))/86400000)+1);const totalDays=S.cutWeeks*7;const prog=Math.min(100,Math.round(dayN/totalDays*100));
const completedWeek=Math.min(Math.floor((dayN-1)/7),S.cutWeeks);const currentWeek=Math.min(Math.ceil(dayN/7),S.cutWeeks);
const goalProfiles=S.goalProfiles||DEF_GOALS;const activeGP=goalProfiles.find(g=>g.id===S.activeGoalProfile)||goalProfiles[0];
const setActiveProfile=(pid)=>{sv({...D,settings:{...S,activeGoalProfile:pid}})};
const updGoalProfile=(pid,u)=>{const gp=goalProfiles.map(g=>g.id===pid?{...g,...u}:g);sv({...D,settings:{...S,goalProfiles:gp}})};
const validateGoal=(k,v)=>{const ranges={cal:[800,6000],prot:[30,500],fat:[10,300],carbs:[30,800],sugar:[0,200],fiber:[0,100],trainingPerWeek:[0,14]};const r=ranges[k]||[0,99999];return Math.max(r[0],Math.min(r[1],+v||0))};
const avg=(arr,k)=>arr.length>0?(arr.reduce((a,x)=>a+(+x[k]||0),0)/arr.length).toFixed(1):0;
const movAvg=(arr,k,w=7)=>{if(arr.length<2)return[];return arr.map((_,i)=>{const st=Math.max(0,i-w+1);const sl=arr.slice(st,i+1).filter(x=>x[k]!==undefined&&x[k]!==null&&x[k]!=="");const a=sl.length>0?sl.reduce((a,x)=>a+(+x[k]||0),0)/sl.length:0;return{date:arr[i].date,v:+a.toFixed(1),label:arr[i].date.slice(5)}})};
const getWk=()=>{const wk=[];const now=new Date();const dow=now.getDay();const sow=new Date(now);sow.setDate(now.getDate()-(dow===0?6:dow-1));for(let i=0;i<7;i++){const d=new Date(sow);d.setDate(sow.getDate()+i);wk.push(fmtD(d))}return wk};

const C={bg0:"#08080a",bg1:"#0e0e12",bg2:"#141418",bg3:"#1a1a20",bg4:"#222228",b1:"#1e1e24",t0:"#f4f4f6",t1:"#c8c8d0",t2:"#8888a0",t3:"#55556a",lime:"#b8f000",blue:"#5b9df5",orange:"#f5a623",red:"#f55353",green:"#34d399",purple:"#a78bfa",cyan:"#22d3ee",pink:"#f472b6",amber:"#fbbf24"};
const z={
card:{background:C.bg1,border:`1px solid ${C.b1}`,borderRadius:14,padding:"16px",marginBottom:14},
lb:{fontSize:"0.6rem",textTransform:"uppercase",letterSpacing:2,color:C.t3,fontWeight:600,marginBottom:8},
big:{fontFamily:"'IBM Plex Mono',monospace",fontSize:"1.6rem",fontWeight:700,lineHeight:1},
btn:p=>({padding:"8px 16px",borderRadius:8,border:p?"none":`1px solid ${C.b1}`,fontWeight:600,fontSize:"0.78rem",cursor:"pointer",fontFamily:"inherit",background:p?C.lime:C.bg2,color:p?C.bg0:C.t1,whiteSpace:"nowrap"}),
btnS:p=>({padding:"5px 11px",borderRadius:6,border:p?"none":`1px solid ${C.b1}`,fontWeight:600,fontSize:"0.7rem",cursor:"pointer",fontFamily:"inherit",background:p?C.lime:C.bg2,color:p?C.bg0:C.t2}),
btnD:{padding:"5px 11px",borderRadius:6,border:"1px solid #f5535333",fontWeight:600,fontSize:"0.7rem",cursor:"pointer",fontFamily:"inherit",background:"transparent",color:C.red},
inp:{width:"100%",padding:"9px 14px",borderRadius:8,border:`1px solid ${C.b1}`,background:C.bg0,color:C.t0,fontSize:"0.82rem",fontFamily:"inherit",outline:"none"},
inpM:{width:"100%",padding:"8px 12px",borderRadius:8,border:`1px solid ${C.b1}`,background:C.bg0,color:C.t0,fontSize:"0.8rem",fontFamily:"'IBM Plex Mono',monospace",outline:"none"},
tag:c=>({fontSize:"0.6rem",padding:"3px 8px",borderRadius:100,fontWeight:600,background:c+"18",color:c,display:"inline-block"}),
delta:c=>({display:"inline-flex",alignItems:"center",gap:3,fontSize:"0.65rem",fontWeight:600,padding:"2px 8px",borderRadius:5,marginTop:5,color:c,background:c+"15"}),
th:{fontSize:"0.52rem",textTransform:"uppercase",letterSpacing:1.5,color:C.t3,fontWeight:600,padding:"6px 4px",textAlign:"left",borderBottom:`1px solid ${C.b1}`},
td:{padding:"6px 4px",fontSize:"0.76rem",borderBottom:`1px solid ${C.b1}`},
navI:a=>({display:"flex",alignItems:"center",gap:10,padding:"8px 12px",borderRadius:8,cursor:"pointer",fontSize:"0.8rem",color:a?C.lime:C.t2,background:a?C.lime+"12":"transparent",border:a?`1px solid ${C.lime}20`:"1px solid transparent",fontWeight:500,marginBottom:2})};

const Mdl=({title,ch,onClose,wide})=>(<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.65)",zIndex:200,display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(4px)",padding:12}} onClick={onClose}><div style={{background:C.bg1,border:`1px solid ${C.b1}`,borderRadius:16,padding:"20px",width:"100%",maxWidth:wide?720:540,maxHeight:"90vh",overflowY:"auto"}} onClick={e=>e.stopPropagation()}><div style={{fontSize:"1rem",fontWeight:700,marginBottom:16}}>{title}</div>{ch}</div></div>);

const Chart=({pts,h=130,color=C.lime,pts2,color2})=>{if(pts.length<2)return<div style={{textAlign:"center",padding:20,color:C.t3,fontSize:"0.78rem"}}>2+ datos</div>;const last=pts.slice(-14),vals=last.map(p=>p.v);let allV=[...vals];if(pts2)allV=[...allV,...pts2.slice(-14).map(p=>p.v)];const mn=Math.min(...allV)-0.3,mx=Math.max(...allV)+0.3,rng=mx-mn||1;const W=520,pL=42,pR=12,pT=10,pB=22,cW=W-pL-pR,cH=h-pT-pB;const pp=last.map((p,i)=>({x:pL+(i/(last.length-1))*cW,y:pT+(1-(p.v-mn)/rng)*cH,...p}));const poly=pp.map(p=>`${p.x},${p.y}`).join(" ");const area=`M${pp[0].x},${pp[0].y} ${pp.map(p=>`L${p.x},${p.y}`).join(" ")} L${pp[pp.length-1].x},${pT+cH} L${pp[0].x},${pT+cH} Z`;let pp2=[],poly2="";if(pts2&&pts2.length>=2){const l2=pts2.slice(-14);if(l2.length>1){pp2=l2.map((p,i)=>({x:pL+(i/(l2.length-1))*cW,y:pT+(1-(p.v-mn)/rng)*cH}));poly2=pp2.map(p=>`${p.x},${p.y}`).join(" ")}}return(<svg viewBox={`0 0 ${W} ${h}`} style={{width:"100%",height:"auto"}}>{[0,1,2,3].map(i=><line key={i} x1={pL} y1={pT+(i/3)*cH} x2={W-pR} y2={pT+(i/3)*cH} stroke="#f4f4f608" strokeWidth="1"/>)}{[0,3].map(i=><text key={i} x={2} y={pT+(i/3)*cH+3} fill={C.t3} fontSize="8" fontFamily="monospace">{(mx-(i/3)*rng).toFixed(1)}</text>)}<defs><linearGradient id="cg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={color} stopOpacity="0.12"/><stop offset="100%" stopColor={color} stopOpacity="0"/></linearGradient></defs><path d={area} fill="url(#cg)"/><polyline points={poly} fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>{pp.map((p,i)=><circle key={i} cx={p.x} cy={p.y} r="3" fill={C.bg0} stroke={color} strokeWidth="2"/>)}{poly2&&<polyline points={poly2} fill="none" stroke={color2||C.orange} strokeWidth="2" strokeDasharray="6,3" strokeLinecap="round"/>}{pp.filter((_,i)=>i%Math.max(1,Math.floor(pp.length/6))===0||i===pp.length-1).map((p,i)=><text key={`l${i}`} x={p.x} y={pT+cH+16} fill={C.t3} fontSize="7" fontFamily="monospace" textAnchor="middle">{p.label}</text>)}</svg>)};
const G2=({children})=>(<div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>{children}</div>);
const G3=({children})=>(<div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:10}}>{children}</div>);

/* === FITNESS === */
const FitnessPage=()=>{
const[flM,setFlM]=useState(null);const[compM,setCompM]=useState(false);const[tblPage,setTblPage]=useState(0);
const dateFrom=gFitFrom,setDateFrom=setGFitFrom,dateTo=gFitTo,setDateTo=setGFitTo;
const ffl=fl.filter(e=>{if(dateFrom&&e.date<dateFrom)return false;if(dateTo&&e.date>dateTo)return false;return true});
const fitCards=S.fitCards||["weight","waist","cal","steps"];
const setCard=(idx,mid)=>{const nc=[...fitCards];nc[idx]=mid;sv({...D,settings:{...S,fitCards:nc}})};
const FMET=[
{id:"weight",lb:"Peso",em:"âš–ï¸",unit:"kg",color:C.lime,calc:d=>{const l=d.filter(e=>e.weight);return l.length?(+l[l.length-1].weight).toFixed(1):"â€”"},delta:d=>{const l=d.filter(e=>e.weight);if(l.length<2)return null;return{v:(+l[0].weight-(+l[l.length-1].weight)).toFixed(1),c:C.green,pre:"â†“"}}},
{id:"waist",lb:"Cintura",em:"ðŸ“",unit:"cm",color:C.cyan,calc:d=>{const l=d.filter(e=>e.waist);return l.length?(+l[l.length-1].waist).toFixed(1):"â€”"},delta:d=>{const l=d.filter(e=>e.waist);if(l.length<2)return null;return{v:(+l[0].waist-(+l[l.length-1].waist)).toFixed(1),c:C.green,pre:"â†“"}}},
{id:"cal",lb:"Prom Cal",em:"ðŸ”¥",unit:"kcal",color:C.orange,calc:d=>avg(d.filter(e=>+e.cal>0),"cal"),delta:null},
{id:"steps",lb:"Prom Pasos",em:"ðŸ‘Ÿ",unit:"pasos",color:C.purple,calc:d=>(+avg(d.filter(e=>+e.steps>0),"steps")).toLocaleString(),delta:null},
{id:"prot",lb:"Prom Prot",em:"ðŸ¥©",unit:"g",color:C.blue,calc:d=>avg(d.filter(e=>+e.prot>0),"prot"),delta:null},
{id:"fat",lb:"Prom Grasa",em:"ðŸ¥‘",unit:"g",color:C.red,calc:d=>avg(d.filter(e=>+e.fat>0),"fat"),delta:null},
{id:"carbs",lb:"Prom Carbos",em:"ðŸš",unit:"g",color:C.green,calc:d=>avg(d.filter(e=>+e.carbs>0),"carbs"),delta:null},
{id:"sugar",lb:"Prom AzÃºcar",em:"ðŸ¬",unit:"g",color:C.pink,calc:d=>avg(d.filter(e=>+e.sugar>0),"sugar"),delta:null},
{id:"fiber",lb:"Prom Fibra",em:"ðŸŒ¾",unit:"g",color:C.amber,calc:d=>avg(d.filter(e=>+e.fiber>0),"fiber"),delta:null},
{id:"sleep",lb:"Prom SueÃ±o",em:"ðŸ˜´",unit:"hrs",color:C.cyan,calc:d=>{const s=d.filter(e=>+e.sleep>0);return s.length?(s.reduce((a,x)=>a+(+x.sleep||0),0)/s.length).toFixed(1):"â€”"},delta:null}
];
const wPts=ffl.filter(e=>e.weight).map(e=>({v:+e.weight,label:e.date.slice(5)}));const wAvg=movAvg(ffl.filter(e=>e.weight),"weight");

const FlModal=({idx,onClose})=>{
const ex=idx!==null?fl[idx]:null;
const[f,setF]=useState(ex||{date:todayS(),week:`S${currentWeek}`,dayType:"dt2",weight:"",waist:"",cal:"",prot:"",fat:"",carbs:"",sugar:"",fiber:"",steps:"",sleep:"",notes:""});
const dt=getDT(f.dayType);
const submit=()=>{const log=[...fl];if(idx!==null)log[idx]={...f};else log.push({...f});log.sort((a,b)=>a.date.localeCompare(b.date));sv({...D,fitnessLog:log});onClose()};
return(<Mdl title={idx!==null?"Editar Registro":"ðŸ“Š Nuevo Registro"} onClose={onClose} wide ch={<div>
<G3><div><div style={{...z.lb,marginBottom:4}}>Fecha</div><input style={z.inpM} type="date" value={f.date} onChange={e=>setF({...f,date:e.target.value})}/></div>
<div><div style={{...z.lb,marginBottom:4}}>Semana</div><input style={z.inpM} value={f.week} onChange={e=>setF({...f,week:e.target.value})}/></div>
<div><div style={{...z.lb,marginBottom:4}}>Tipo</div><select style={{...z.inpM,cursor:"pointer"}} value={f.dayType} onChange={e=>setF({...f,dayType:e.target.value})}>{dayTypes.map(t=><option key={t.id} value={t.id}>{t.emoji} {t.name}</option>)}</select></div></G3>
<div style={{marginTop:10}}><G2><div><div style={{...z.lb,marginBottom:4}}>Peso (kg)</div><input style={z.inpM} type="number" step="0.1" value={f.weight} onChange={e=>setF({...f,weight:e.target.value})}/></div>
<div><div style={{...z.lb,marginBottom:4}}>Cintura (cm)</div><input style={z.inpM} type="number" step="0.5" value={f.waist} onChange={e=>setF({...f,waist:e.target.value})}/></div></G2></div>
<div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(80px,1fr))",gap:8,marginTop:10}}>
{[["Cal","cal",C.orange],["Prot","prot",C.blue],["Grasa","fat",C.red],["Carbos","carbs",C.green],["AzÃºcar","sugar",C.pink],["Fibra","fiber",C.amber]].map(([l,k,c])=><div key={k}><div style={{...z.lb,marginBottom:4,color:c}}>{l}</div><input style={z.inpM} type="number" value={f[k]} onChange={e=>setF({...f,[k]:e.target.value})}/></div>)}</div>
<div style={{marginTop:10}}><G2><div><div style={{...z.lb,marginBottom:4}}>Pasos</div><input style={z.inpM} type="number" value={f.steps} onChange={e=>setF({...f,steps:e.target.value})}/></div>
<div><div style={{...z.lb,marginBottom:4}}>SueÃ±o</div><input style={z.inpM} type="number" step="0.5" value={f.sleep} onChange={e=>setF({...f,sleep:e.target.value})}/></div></G2></div>
<div style={{marginTop:10}}><div style={{...z.lb,marginBottom:4}}>Notas del dÃ­a</div><textarea style={{...z.inp,minHeight:55}} value={f.notes||""} onChange={e=>setF({...f,notes:e.target.value})} placeholder="Â¿CÃ³mo fue tu dÃ­a?"/></div>
<div style={{padding:"10px 12px",background:C.bg2,borderRadius:8,margin:"10px 0",fontSize:"0.72rem",color:C.t2}}><b style={{color:C.t1}}>{dt.emoji} {dt.name}:</b> {dt.cal} kcal Â· {dt.prot}g P Â· {dt.carbs}g C Â· {dt.fat}g G Â· â‰¤{dt.sugar}g S Â· {dt.fiber||0}g F Â· Rango cal: {dt.calMin}â€“{dt.calMax}</div>
<div style={{display:"flex",gap:8,flexWrap:"wrap"}}><button style={z.btn(true)} onClick={submit}>{idx!==null?"Guardar":"Registrar"}</button><button style={z.btn(false)} onClick={onClose}>Cancelar</button>{idx!==null&&<button style={z.btnD} onClick={()=>{const l=[...fl];l.splice(idx,1);sv({...D,fitnessLog:l});onClose()}}>Eliminar</button>}</div>
</div>}/>)};

const CompEditor=({onClose})=>{
const[f,setF]=useState({protRange:[...(S.protRange||[153,999])],fatRange:[...(S.fatRange||[0,75])],carbRange:[...(S.carbRange||[0,999])],sugarRange:[...(S.sugarRange||[0,40])],fiberRange:[...(S.fiberRange||[20,999])]});
const[dtRanges,setDtRanges]=useState(dayTypes.map(t=>({id:t.id,name:t.name,emoji:t.emoji,calMin:t.calMin||0,calMax:t.calMax||9999})));
const updDR=(i,k,v)=>{const n=[...dtRanges];n[i]={...n[i],[k]:+v};setDtRanges(n)};
return(<Mdl title="âš™ Intervalos de Compliance" onClose={onClose} wide ch={<div>
<p style={{fontSize:"0.76rem",color:C.t2,marginBottom:12}}>Pâœ“ Gâœ“ Câœ“ Sâœ“ Fâœ“ Kâœ“ = valor dentro del intervalo. DÃAâœ“ = 4 de 6 checks. Kâœ“ = calorÃ­as dentro del rango del tipo de dÃ­a.</p>
{[["ProteÃ­na (Pâœ“)","protRange",C.blue],["Grasas (Gâœ“)","fatRange",C.red],["Carbos (Câœ“)","carbRange",C.green],["AzÃºcar (Sâœ“)","sugarRange",C.pink],["Fibra (Fâœ“)","fiberRange",C.amber]].map(([l,k,c])=>(<div key={k} style={{display:"flex",alignItems:"center",gap:8,marginBottom:10,flexWrap:"wrap"}}><span style={{width:120,fontSize:"0.78rem",color:c,fontWeight:600}}>{l}</span><span style={{fontSize:"0.7rem",color:C.t3}}>Min:</span><input style={{...z.inpM,maxWidth:75}} type="number" value={f[k][0]} onChange={e=>{const n=[...f[k]];n[0]=+e.target.value;setF({...f,[k]:n})}}/><span style={{fontSize:"0.7rem",color:C.t3}}>Max:</span><input style={{...z.inpM,maxWidth:75}} type="number" value={f[k][1]} onChange={e=>{const n=[...f[k]];n[1]=+e.target.value;setF({...f,[k]:n})}}/></div>))}
<div style={{...z.lb,marginTop:14}}>ðŸ”¥ Rango CalorÃ­as (Kâœ“) por tipo de dÃ­a</div>
{dtRanges.map((dr,i)=>(<div key={dr.id} style={{display:"flex",alignItems:"center",gap:8,marginBottom:8,flexWrap:"wrap"}}><span style={{width:130,fontSize:"0.78rem",fontWeight:500}}>{dr.emoji} {dr.name}</span><span style={{fontSize:"0.7rem",color:C.t3}}>Min:</span><input style={{...z.inpM,maxWidth:80}} type="number" value={dr.calMin} onChange={e=>updDR(i,"calMin",e.target.value)}/><span style={{fontSize:"0.7rem",color:C.t3}}>Max:</span><input style={{...z.inpM,maxWidth:80}} type="number" value={dr.calMax} onChange={e=>updDR(i,"calMax",e.target.value)}/></div>))}
<div style={{display:"flex",gap:8,marginTop:14}}><button style={z.btn(true)} onClick={()=>{const ndt=dayTypes.map(t=>{const r=dtRanges.find(d=>d.id===t.id);return r?{...t,calMin:r.calMin,calMax:r.calMax}:t});sv({...D,settings:{...S,...f},dayTypes:ndt});onClose()}}>Guardar</button><button style={z.btn(false)} onClick={onClose}>Cancelar</button></div>
</div>}/>)};

return(<div style={{animation:"fadeIn 0.3s ease-out"}}>
<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}>
<div><div style={{fontSize:"1.3rem",fontWeight:700}}>ðŸ‹ï¸ Mini-Cut Tracker</div><div style={{fontSize:"0.75rem",color:C.t3}}>{S.planGoal}</div></div>
<div style={{display:"flex",gap:6,flexWrap:"wrap"}}><button style={z.btn(true)} onClick={()=>setFlM("new")}>+ Registro</button><button style={z.btnS(false)} onClick={()=>setCompM(true)}>âš™ Intervalos</button></div></div>
<G3>{[["ðŸ”¥ Cal",activeGP.cal,"kcal",C.orange,avg(ffl.filter(e=>+e.cal>0),"cal")],["ðŸ¥© Prot",activeGP.prot+"g","g",C.blue,avg(ffl.filter(e=>+e.prot>0),"prot")+"g"],["ðŸ¥‘ Grasa",activeGP.fat+"g","g",C.red,avg(ffl.filter(e=>+e.fat>0),"fat")+"g"],["ðŸš Carbos",activeGP.carbs+"g","g",C.green,avg(ffl.filter(e=>+e.carbs>0),"carbs")+"g"],["ðŸ¬ AzÃºcar","â‰¤"+activeGP.sugar+"g","g",C.pink,avg(ffl.filter(e=>+e.sugar>0),"sugar")+"g"]].map(([l,v,u,c,real],i)=><div key={i} style={z.card}><div style={{...z.lb,color:c}}>{l} <span style={{fontSize:"0.5rem",color:C.t3}}>({activeGP.name})</span></div><div style={{fontFamily:"monospace",fontSize:"1.1rem",fontWeight:700}}>{v}</div>{real&&<div style={{fontSize:"0.6rem",color:C.t2,marginTop:2}}>Real: {real}</div>}<div style={{fontSize:"0.6rem",color:C.t3}}>{u}</div></div>)}</G3>
<div style={{...z.card,padding:"12px 16px",marginTop:4}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}><span style={{...z.lb,marginBottom:0}}>Progreso</span><span style={{fontFamily:"monospace",fontSize:"0.72rem",color:C.lime}}>DÃ­a {Math.min(dayN,totalDays)}/{totalDays} â€” {prog}%</span></div><div style={{width:"100%",height:7,background:C.bg3,borderRadius:100,overflow:"hidden"}}><div style={{height:"100%",borderRadius:100,width:`${prog}%`,background:`linear-gradient(90deg,${C.lime},#8aff00)`}}/></div></div>
<div style={{...z.card,padding:"10px 14px",marginTop:4,display:"flex",alignItems:"center",gap:10,flexWrap:"wrap"}}>
<span style={{fontSize:"0.72rem",fontWeight:600,color:C.t2}}>ðŸ“… Filtrar</span>
<div style={{display:"flex",alignItems:"center",gap:6}}>
<label style={{fontSize:"0.65rem",color:C.t3}}>Desde</label>
<input type="date" style={{...z.inpM,padding:"4px 8px",fontSize:"0.7rem",maxWidth:140,colorScheme:"dark"}} value={dateFrom} onChange={e=>setDateFrom(e.target.value)}/>
</div>
<div style={{display:"flex",alignItems:"center",gap:6}}>
<label style={{fontSize:"0.65rem",color:C.t3}}>Hasta</label>
<input type="date" style={{...z.inpM,padding:"4px 8px",fontSize:"0.7rem",maxWidth:140,colorScheme:"dark"}} value={dateTo} onChange={e=>setDateTo(e.target.value)}/>
</div>
{(dateFrom||dateTo)&&<button style={{...z.btnS(false),padding:"4px 10px",fontSize:"0.65rem"}} onClick={()=>{setDateFrom("");setDateTo("")}}>âœ• Reset</button>}
{(dateFrom||dateTo)&&<span style={{fontSize:"0.63rem",color:C.lime,fontWeight:600}}>{ffl.length} registros</span>}
</div>
<G3>{fitCards.map((mid,ci)=>{const m=FMET.find(x=>x.id===mid)||FMET[0];const val=m.calc(ffl);const dt=m.delta?m.delta(ffl):null;return(<div key={ci} style={z.card}>
<div style={{display:"flex",alignItems:"center",gap:4,marginBottom:4}}>
<select style={{background:"transparent",border:"none",color:m.color,fontSize:"0.62rem",fontWeight:700,letterSpacing:0.5,textTransform:"uppercase",cursor:"pointer",padding:0,fontFamily:"inherit",outline:"none",appearance:"auto",WebkitAppearance:"menulist",colorScheme:"dark",maxWidth:"100%"}} value={mid} onChange={e=>setCard(ci,e.target.value)}>
{FMET.map(o=><option key={o.id} value={o.id}>{o.em} {o.lb}</option>)}
</select></div>
<div style={z.big}>{val}</div>
<div style={{fontSize:"0.72rem",color:C.t2,marginTop:3}}>{m.unit}</div>
{dt&&<div style={z.delta(dt.c)}>{dt.pre} {dt.v}</div>}
</div>)})}</G3>
<G2><div style={z.card}><div style={{display:"flex",justifyContent:"space-between"}}><div style={z.lb}>Peso</div><div style={{fontSize:"0.5rem",color:C.t3}}>â€” Real <span style={{color:C.orange}}>--- 7d</span></div></div><Chart pts={wPts} pts2={wAvg} color={C.lime} color2={C.orange}/></div>
<div style={z.card}><div style={z.lb}>Cintura</div><Chart pts={ffl.filter(e=>e.waist).map(e=>({v:+e.waist,label:e.date.slice(5)}))} color={C.cyan}/></div></G2>
<div style={z.card}><div style={z.lb}>ðŸŽ¯ Macros por Tipo de DÃ­a</div><div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse",minWidth:550}}><thead><tr>{["Tipo","Cal","Prot","Carbos","Grasa","AzÃºcar","Fibra","Rango Cal"].map(h=><th key={h} style={z.th}>{h}</th>)}</tr></thead>
<tbody>{dayTypes.map(t=>(<tr key={t.id}><td style={{...z.td,fontWeight:600}}>{t.emoji} {t.name}</td><td style={{...z.td,fontFamily:"monospace"}}>{t.cal}</td><td style={{...z.td,fontFamily:"monospace"}}>{t.prot}g</td><td style={{...z.td,fontFamily:"monospace"}}>{t.carbs}g</td><td style={{...z.td,fontFamily:"monospace"}}>{t.fat}g</td><td style={{...z.td,fontFamily:"monospace"}}>â‰¤{t.sugar}g</td><td style={{...z.td,fontFamily:"monospace",color:C.amber}}>{t.fiber||0}g</td><td style={{...z.td,fontFamily:"monospace",color:C.orange}}>{t.calMin}â€“{t.calMax}</td></tr>))}</tbody></table></div></div>
<div style={{...z.card,padding:"10px 16px",display:"flex",gap:12,flexWrap:"wrap",alignItems:"center"}}>
<span style={{...z.lb,marginBottom:0}}>Intervalos:</span>
{[["Pâœ“",S.protRange||[153,999],C.blue],["Gâœ“",S.fatRange||[0,75],C.red],["Câœ“",S.carbRange||[0,999],C.green],["Sâœ“",S.sugarRange||[0,40],C.pink],["Fâœ“",S.fiberRange||[20,999],C.amber]].map(([l,r,c])=><span key={l} style={{fontSize:"0.68rem",color:c,fontWeight:600}}>{l}:{r[0]}â€“{r[1]}g</span>)}
<span style={{fontSize:"0.68rem",color:C.orange,fontWeight:600}}>Kâœ“: por tipo</span>
<span style={{fontSize:"0.68rem",color:C.t3}}>DÃAâœ“=4/6</span></div>
{(()=>{const PAGE_SIZE=10;const totalPages=Math.max(1,Math.ceil(ffl.length/PAGE_SIZE));const safePage=Math.min(tblPage,totalPages-1);const pageData=ffl.slice(safePage*PAGE_SIZE,(safePage+1)*PAGE_SIZE);return(<div style={z.card}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}><div style={z.lb}>ðŸ“Š Progreso Semanal</div><div style={{display:"flex",alignItems:"center",gap:8}}><button onClick={()=>setTblPage(Math.max(0,safePage-1))} disabled={safePage===0} style={{background:"none",border:`1px solid ${safePage===0?C.b1:C.lime}`,borderRadius:6,color:safePage===0?C.t3:C.lime,cursor:safePage===0?"default":"pointer",padding:"4px 10px",fontSize:"0.72rem",fontWeight:700,fontFamily:"inherit"}}>â—€</button><span style={{fontSize:"0.65rem",color:C.t2,fontFamily:"monospace"}}>{safePage+1}/{totalPages}</span><button onClick={()=>setTblPage(Math.min(totalPages-1,safePage+1))} disabled={safePage>=totalPages-1} style={{background:"none",border:`1px solid ${safePage>=totalPages-1?C.b1:C.lime}`,borderRadius:6,color:safePage>=totalPages-1?C.t3:C.lime,cursor:safePage>=totalPages-1?"default":"pointer",padding:"4px 10px",fontSize:"0.72rem",fontWeight:700,fontFamily:"inherit"}}>â–¶</button></div></div><div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse",minWidth:750}}>
<thead style={{position:"sticky",top:0,zIndex:1,background:C.bg1}}><tr>{["Fecha","Tipo","Peso","Cintura","Cal","Prot","Grasa","Carbos","AzÃºcar","Fibra","Pasos","Pâœ“","Gâœ“","Câœ“","Sâœ“","Fâœ“","Kâœ“","DÃA"].map(h=><th key={h} style={{...z.th,padding:"5px 3px"}}>{h}</th>)}</tr></thead>
<tbody>{pageData.map((e,i)=>{const oi=fl.indexOf(e);const comp=chkComp(e);const dt=getDT(e.dayType);return(<tr key={oi} style={{cursor:"pointer"}} onClick={()=>setFlM(oi)}>
<td style={{...z.td,fontFamily:"monospace",fontSize:"0.68rem"}}>{e.date.slice(5)}</td><td style={z.td}>{dt.emoji}</td>
<td style={{...z.td,fontFamily:"monospace",fontWeight:600}}>{e.weight||"â€”"}</td><td style={{...z.td,fontFamily:"monospace"}}>{e.waist||"â€”"}</td>
<td style={{...z.td,fontFamily:"monospace"}}>{e.cal||"â€”"}</td><td style={{...z.td,fontFamily:"monospace"}}>{e.prot||"â€”"}</td><td style={{...z.td,fontFamily:"monospace"}}>{e.fat||"â€”"}</td><td style={{...z.td,fontFamily:"monospace"}}>{e.carbs||"â€”"}</td><td style={{...z.td,fontFamily:"monospace"}}>{e.sugar||"â€”"}</td><td style={{...z.td,fontFamily:"monospace",color:C.amber}}>{e.fiber||"â€”"}</td>
<td style={{...z.td,fontFamily:"monospace"}}>{(+e.steps||0).toLocaleString()}</td>
{[comp.p,comp.g,comp.c,comp.s,comp.fb,comp.k].map((v,j)=><td key={j} style={{...z.td,textAlign:"center"}}><span style={{color:v?C.green:C.red,fontWeight:700}}>{v?"âœ“":"âœ—"}</span></td>)}
<td style={{...z.td,textAlign:"center"}}><span style={{color:comp.day?C.green:C.red,fontWeight:800,fontSize:"0.85rem"}}>{comp.day?"âœ“":"âœ—"}</span></td>
</tr>)})}</tbody></table></div></div>)})()}
{ffl.filter(e=>e.notes).length>0&&<div style={z.card}><div style={z.lb}>ðŸ“ Notas</div>{ffl.filter(e=>e.notes).slice(-5).reverse().map((e,i)=>(<div key={i} style={{padding:"7px 0",borderBottom:`1px solid ${C.b1}`}}><span style={{fontFamily:"monospace",fontSize:"0.65rem",color:C.t3}}>{e.date}</span> {getDT(e.dayType).emoji}<div style={{fontSize:"0.8rem",color:C.t1,marginTop:3}}>{e.notes}</div></div>))}</div>}
{flM==="new"&&<FlModal idx={null} onClose={()=>setFlM(null)}/>}
{typeof flM==="number"&&<FlModal idx={flM} onClose={()=>setFlM(null)}/>}
{compM&&<CompEditor onClose={()=>setCompM(false)}/>}
</div>)};

/* === PROJECTS (task notes) === */
const ProjectsPage=()=>{
const[editP,setEditP]=useState(null);const[editTM,setEditTM]=useState(null);
const TSTATES=[{id:"pending",lb:"Inicio",em:"ðŸ”µ",c:C.blue},{id:"progress",lb:"En Proceso",em:"ðŸŸ¡",c:C.orange},{id:"done",lb:"Completado",em:"ðŸŸ¢",c:C.green}];
const tState=s=>TSTATES.find(x=>x.id===s)||TSTATES[0];
const nextState=s=>{const i=TSTATES.findIndex(x=>x.id===s);return TSTATES[(i+1)%TSTATES.length].id};
const addP=()=>{sv({...D,projects:[...projects,{id:uid(),name:"Nuevo Proyecto",status:"Por iniciar",progress:0,priority:"Media",category:"â€”",deadline:"",notes:"",tasks:[]}]})};
const updP=(i,u)=>{const p=[...projects];p[i]={...p[i],...u};sv({...D,projects:p})};
const delP=i=>{const p=[...projects];p.splice(i,1);sv({...D,projects:p})};
const addT=pi=>{const p=[...projects];p[pi].tasks.push({id:uid(),t:"Nueva tarea",s:"pending",note:"",dl:""});sv({...D,projects:p})};
const updT=(pi,ti,u)=>{const p=[...projects];p[pi].tasks[ti]={...p[pi].tasks[ti],...u};p[pi].progress=p[pi].tasks.length>0?Math.round(p[pi].tasks.filter(t=>t.s==="done").length/p[pi].tasks.length*100):0;sv({...D,projects:p})};
const delT=(pi,ti)=>{const p=[...projects];p[pi].tasks.splice(ti,1);p[pi].progress=p[pi].tasks.length>0?Math.round(p[pi].tasks.filter(t=>t.s==="done").length/p[pi].tasks.length*100):0;sv({...D,projects:p})};
const moveT=(pi,ti,dir)=>{const p=[...projects];const t=p[pi].tasks;const ni=ti+dir;if(ni<0||ni>=t.length)return;[t[ti],t[ni]]=[t[ni],t[ti]];sv({...D,projects:p})};

const ProjEdit=({idx,onClose})=>{const p=projects[idx];const[f,setF]=useState({...p});return(<Mdl title="âœï¸ Editar Proyecto" onClose={onClose} ch={<div style={{display:"flex",flexDirection:"column",gap:10}}>
<div><div style={{...z.lb,marginBottom:4}}>Nombre</div><input style={z.inp} value={f.name} onChange={e=>setF({...f,name:e.target.value})}/></div>
<G2><div><div style={{...z.lb,marginBottom:4}}>Status</div><select style={z.inpM} value={f.status} onChange={e=>setF({...f,status:e.target.value})}><option>Por iniciar</option><option>En progreso</option><option>Completado</option><option>Pausado</option></select></div><div><div style={{...z.lb,marginBottom:4}}>Prioridad</div><select style={z.inpM} value={f.priority} onChange={e=>setF({...f,priority:e.target.value})}><option>Alta</option><option>Media</option><option>Baja</option></select></div></G2>
<G2><div><div style={{...z.lb,marginBottom:4}}>CategorÃ­a</div><input style={z.inp} value={f.category} onChange={e=>setF({...f,category:e.target.value})}/></div><div><div style={{...z.lb,marginBottom:4}}>Fecha LÃ­mite</div><input style={z.inpM} type="date" value={f.deadline} onChange={e=>setF({...f,deadline:e.target.value})}/></div></G2>
<div><div style={{...z.lb,marginBottom:4}}>Notas</div><textarea style={{...z.inp,minHeight:50}} value={f.notes} onChange={e=>setF({...f,notes:e.target.value})}/></div>
<div style={{display:"flex",gap:8}}><button style={z.btn(true)} onClick={()=>{updP(idx,f);onClose()}}>Guardar</button><button style={z.btn(false)} onClick={onClose}>Cancelar</button></div></div>}/>)};

const TaskEdit=({pi,ti,onClose})=>{const t=projects[pi].tasks[ti];const[f,setF]=useState({t:t.t,s:t.s||"pending",dl:t.dl||"",note:t.note||""});
const isOverdue=f.dl&&f.dl<todayS()&&f.s!=="done";
return(<Mdl title="âœï¸ Editar Tarea" onClose={onClose} ch={<div style={{display:"flex",flexDirection:"column",gap:12}}>
<div><div style={{...z.lb,marginBottom:4}}>Nombre</div><input style={z.inp} value={f.t} onChange={e=>setF({...f,t:e.target.value})}/></div>
<G2><div><div style={{...z.lb,marginBottom:4}}>Estado</div>
<div style={{display:"flex",gap:6}}>{TSTATES.map(st=>(<button key={st.id} onClick={()=>setF({...f,s:st.id})} style={{padding:"6px 12px",borderRadius:8,border:f.s===st.id?`2px solid ${st.c}`:`1px solid ${C.b1}`,background:f.s===st.id?st.c+"20":C.bg2,color:f.s===st.id?st.c:C.t2,fontSize:"0.72rem",fontWeight:600,cursor:"pointer",fontFamily:"inherit"}}>{st.em} {st.lb}</button>))}</div>
</div><div><div style={{...z.lb,marginBottom:4}}>Fecha LÃ­mite</div><input style={{...z.inpM,colorScheme:"dark"}} type="date" value={f.dl} onChange={e=>setF({...f,dl:e.target.value})}/>
{isOverdue&&<div style={{fontSize:"0.65rem",color:C.red,fontWeight:600,marginTop:4}}>âš  Vencida</div>}</div></G2>
<div><div style={{...z.lb,marginBottom:4}}>ðŸ“ Notas</div>
<textarea style={{...z.inp,minHeight:150,fontFamily:"'IBM Plex Mono',monospace",fontSize:"0.78rem",lineHeight:1.7,whiteSpace:"pre-wrap",resize:"vertical"}} value={f.note} onChange={e=>setF({...f,note:e.target.value})} placeholder="Escribe notas libres aquÃ­..."/></div>
<div style={{display:"flex",gap:8}}><button style={z.btn(true)} onClick={()=>{updT(pi,ti,f);onClose()}}>Guardar</button><button style={z.btnD} onClick={()=>{delT(pi,ti);onClose()}}>Eliminar</button><button style={z.btn(false)} onClick={onClose}>Cancelar</button></div></div>}/>)};

return(<div style={{animation:"fadeIn 0.3s ease-out"}}>
<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}><div style={{fontSize:"1.3rem",fontWeight:700}}>ðŸ“‚ Proyectos</div><button style={z.btn(true)} onClick={addP}>+ Proyecto</button></div>
<G3>{projects.map((p,i)=>(<div key={p.id} style={z.card}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}><span style={{fontWeight:700,fontSize:"0.85rem"}}>{p.name}</span><div style={{display:"flex",gap:4}}><button style={z.btnS(false)} onClick={()=>setEditP(i)}>âœï¸</button><button style={z.btnD} onClick={()=>delP(i)}>âœ•</button></div></div><div style={{display:"flex",gap:5,marginBottom:8,flexWrap:"wrap"}}><span style={z.tag(p.status==="En progreso"?C.blue:p.status==="Completado"?C.green:C.orange)}>{p.status}</span><span style={z.tag(p.priority==="Alta"?C.red:C.orange)}>{p.priority}</span></div><div style={{width:"100%",height:6,background:C.bg3,borderRadius:100,overflow:"hidden"}}><div style={{height:"100%",borderRadius:100,width:`${p.progress}%`,background:C.lime}}/></div><div style={{fontSize:"0.63rem",color:C.t3,marginTop:3,textAlign:"right"}}>{p.progress}%</div></div>))}</G3>
<div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(340px,1fr))",gap:14,marginTop:14}}>{projects.map((p,pi)=>(<div key={p.id} style={z.card}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}><div style={z.lb}>ðŸ“‹ {p.name}</div><button style={z.btnS(true)} onClick={()=>addT(pi)}>+ Tarea</button></div>
{p.tasks.map((t,ti)=>{const st=tState(t.s);const isOverdue=t.dl&&t.dl<todayS()&&t.s!=="done";return(<div key={t.id} style={{padding:"8px 0",borderBottom:`1px solid ${C.b1}`}}>
<div style={{display:"flex",alignItems:"center",gap:6}}>
<span style={{cursor:"pointer",fontSize:"0.85rem",transition:"transform 0.15s"}} title={`Click: ${tState(nextState(t.s)).lb}`} onClick={()=>updT(pi,ti,{s:nextState(t.s)})}>{st.em}</span>
<span style={{flex:1,fontSize:"0.78rem",textDecoration:t.s==="done"?"line-through":"none",color:t.s==="done"?C.t3:C.t0,cursor:"pointer",fontWeight:t.s==="progress"?600:400}} onClick={()=>setEditTM({pi,ti})}>{t.t}</span>
<span style={{...z.tag(st.c),fontSize:"0.5rem",padding:"2px 6px"}}>{st.lb}</span>
<button style={{background:"none",border:"none",color:C.t3,cursor:"pointer",fontSize:"0.6rem"}} onClick={()=>moveT(pi,ti,-1)}>â†‘</button>
<button style={{background:"none",border:"none",color:C.t3,cursor:"pointer",fontSize:"0.6rem"}} onClick={()=>moveT(pi,ti,1)}>â†“</button>
<button style={{background:"none",border:"none",color:C.red+"55",cursor:"pointer",fontSize:"0.6rem"}} onClick={()=>delT(pi,ti)}>âœ•</button></div>
<div style={{display:"flex",gap:8,marginLeft:26,marginTop:3,alignItems:"center",flexWrap:"wrap"}}>
{t.dl&&<span style={{fontSize:"0.62rem",fontFamily:"monospace",color:isOverdue?C.red:t.s==="done"?C.t3:C.t2,fontWeight:isOverdue?700:400}}>{isOverdue?"âš  ":"ðŸ“… "}{t.dl}</span>}
{t.note&&<span style={{fontSize:"0.65rem",color:C.t3,cursor:"pointer",maxWidth:200,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}} onClick={()=>setEditTM({pi,ti})}>ðŸ“ {t.note.split("\n")[0]}</span>}
</div>
</div>)})}
</div>))}</div>
{editP!==null&&<ProjEdit idx={editP} onClose={()=>setEditP(null)}/>}
{editTM&&<TaskEdit pi={editTM.pi} ti={editTM.ti} onClose={()=>setEditTM(null)}/>}
</div>)};

/* === HABITS === */
const HabitsPage=()=>{
const[editH,setEditH]=useState(null);const[hf,setHf]=useState(null);const activeH=habits.filter(h=>h.active);const wk=getWk();
const hDateFrom=gHabFrom,setHDateFrom=setGHabFrom,hDateTo=gHabTo,setHDateTo=setGHabTo;
const hasHFilter=hDateFrom||hDateTo;
const openHab=idx=>{setEditH(idx);setHf({...habits[idx]})};
const saveHab=()=>{if(editH!==null&&hf)updH(editH,hf);setEditH(null);setHf(null)};
const closeHab=()=>{setEditH(null);setHf(null)};
/* Generate date range for filter */
const getDateRange=(from,to)=>{const dates=[];const s=new Date(from);const e=new Date(to);for(let d=new Date(s);d<=e;d.setDate(d.getDate()+1))dates.push(fmtD(new Date(d)));return dates};
const filteredDates=hasHFilter?getDateRange(hDateFrom||"2020-01-01",hDateTo||todayS()):null;
const wkCnt=activeH.map(h=>{let c=0;wk.forEach(dt=>{if(hw[`${dt}_${h.id}`])c++});return{id:h.id,c}});
const totWk=wkCnt.reduce((a,x)=>a+x.c,0);const maxWk=activeH.length*7;const wkPct=maxWk>0?Math.round(totWk/maxWk*100):0;
/* Filtered stats */
let fTot=0,fMax=0;
if(filteredDates){filteredDates.forEach(dt=>{activeH.forEach(h=>{fMax++;if(hw[`${dt}_${h.id}`])fTot++})})}
const fPct=fMax>0?Math.round(fTot/fMax*100):0;
const curMo=new Date().getMonth();const curYr=new Date().getFullYear();
let moTot=0,moMax=0;const dim=new Date(curYr,curMo+1,0).getDate();for(let d=1;d<=dim;d++){const dt=`${curYr}-${String(curMo+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;activeH.forEach(h=>{moMax++;if(hw[`${dt}_${h.id}`])moTot++})}const moPct=moMax>0?Math.round(moTot/moMax*100):0;
let yrTot=0,yrMax=0;for(let m=0;m<12;m++){const d2=new Date(curYr,m+1,0).getDate();for(let d=1;d<=d2;d++){const dt=`${curYr}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;activeH.forEach(h=>{yrMax++;if(hw[`${dt}_${h.id}`])yrTot++})}}const yrPct=yrMax>0?Math.round(yrTot/yrMax*100):0;
const addH=()=>{sv({...D,habits:[...habits,{id:uid(),name:"Nuevo hÃ¡bito",emoji:"âœ…",meta:"Diario",active:true}]})};
const updH=(i,u)=>{const h=[...habits];h[i]={...h[i],...u};sv({...D,habits:h})};
const delH=i=>{const h=[...habits];h.splice(i,1);sv({...D,habits:h})};
return(<div style={{animation:"fadeIn 0.3s ease-out"}}>
<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}><div style={{fontSize:"1.3rem",fontWeight:700}}>ðŸŽ¯ HÃ¡bitos</div><button style={z.btn(true)} onClick={addH}>+ HÃ¡bito</button></div>
<div style={{...z.card,padding:"10px 14px",marginBottom:14,display:"flex",alignItems:"center",gap:10,flexWrap:"wrap"}}>
<span style={{fontSize:"0.72rem",fontWeight:600,color:C.t2}}>ðŸ“… Filtrar</span>
<div style={{display:"flex",alignItems:"center",gap:6}}>
<label style={{fontSize:"0.65rem",color:C.t3}}>Desde</label>
<input type="date" style={{...z.inpM,padding:"4px 8px",fontSize:"0.7rem",maxWidth:140,colorScheme:"dark"}} value={hDateFrom} onChange={e=>setHDateFrom(e.target.value)}/>
</div>
<div style={{display:"flex",alignItems:"center",gap:6}}>
<label style={{fontSize:"0.65rem",color:C.t3}}>Hasta</label>
<input type="date" style={{...z.inpM,padding:"4px 8px",fontSize:"0.7rem",maxWidth:140,colorScheme:"dark"}} value={hDateTo} onChange={e=>setHDateTo(e.target.value)}/>
</div>
{hasHFilter&&<button style={{...z.btnS(false),padding:"4px 10px",fontSize:"0.65rem"}} onClick={()=>{setHDateFrom("");setHDateTo("")}}>âœ• Reset</button>}
{hasHFilter&&<span style={{fontSize:"0.63rem",color:C.lime,fontWeight:600}}>{filteredDates.length} dÃ­as</span>}
</div>
{hasHFilter&&<div style={{marginBottom:14}}><div style={z.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}><span style={{...z.lb,marginBottom:0}}>Periodo seleccionado</span><span style={{fontFamily:"monospace",fontSize:"0.76rem",color:C.cyan,fontWeight:600}}>{fPct}%</span></div><div style={{width:"100%",height:7,background:C.bg3,borderRadius:100,overflow:"hidden"}}><div style={{height:"100%",borderRadius:100,width:`${fPct}%`,background:C.cyan}}/></div>
<div style={{marginTop:10,overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse"}}><thead><tr><th style={z.th}>HÃ¡bito</th><th style={{...z.th,textAlign:"center"}}>Completados</th><th style={{...z.th,textAlign:"center"}}>%</th></tr></thead>
<tbody>{activeH.map(h=>{let c=0;filteredDates.forEach(dt=>{if(hw[`${dt}_${h.id}`])c++});const pct=filteredDates.length>0?Math.round(c/filteredDates.length*100):0;return(<tr key={h.id}><td style={{...z.td,fontWeight:500}}>{h.emoji} {h.name}</td><td style={{...z.td,textAlign:"center",fontFamily:"monospace"}}>{c}/{filteredDates.length}</td><td style={{...z.td,textAlign:"center"}}><span style={{fontFamily:"monospace",fontWeight:600,color:pct>=70?C.green:pct>=40?C.orange:C.red}}>{pct}%</span></td></tr>)})}</tbody></table></div>
</div></div>}
<G3>{[["Semanal",wkPct,C.lime],["Mensual",moPct,C.blue],["Anual",yrPct,C.purple]].map(([l,p,c])=>(<div key={l} style={z.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}><span style={{...z.lb,marginBottom:0}}>{l}</span><span style={{fontFamily:"monospace",fontSize:"0.76rem",color:c,fontWeight:600}}>{p}%</span></div><div style={{width:"100%",height:7,background:C.bg3,borderRadius:100,overflow:"hidden"}}><div style={{height:"100%",borderRadius:100,width:`${p}%`,background:c}}/></div></div>))}</G3>
<div style={{...z.card,marginTop:4}}><div style={z.lb}>Esta Semana</div><div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse",minWidth:500}}><thead><tr><th style={z.th}>HÃ¡bito</th><th style={z.th}>Meta</th>{DOWS.map(d=><th key={d} style={{...z.th,textAlign:"center"}}>{d}</th>)}<th style={{...z.th,textAlign:"center"}}>Score</th></tr></thead>
<tbody>{activeH.map((h,hi)=>{const wc=wkCnt.find(x=>x.id===h.id)?.c||0;return(<tr key={h.id}><td style={{...z.td,fontWeight:500,cursor:"pointer"}} onClick={()=>openHab(habits.findIndex(x=>x.id===h.id))}>{h.emoji} {h.name} âœï¸</td><td style={{...z.td,fontSize:"0.65rem",color:C.t3}}>{h.meta}</td>
{wk.map((dt,i)=>{const key=`${dt}_${h.id}`;const done=hw[key];return<td key={i} style={{...z.td,textAlign:"center",cursor:"pointer",padding:"4px 2px"}} onClick={()=>{const n={...hw};n[key]=!done;sv({...D,habitWeekly:n})}}><span style={{display:"inline-block",width:24,height:24,borderRadius:6,lineHeight:"24px",fontSize:"0.66rem",background:done?C.lime:C.bg3,color:done?C.bg0:C.t3,fontWeight:700}}>{done?"âœ“":""}</span></td>})}
<td style={{...z.td,textAlign:"center",fontFamily:"monospace",fontWeight:600}}>{wc}/7</td></tr>)})}</tbody></table></div></div>

{/* === HISTORIAL ÃšLTIMO MES === */}
{(()=>{
const[histWeekOff,setHistWeekOff]=useState(1);
const getHistWeek=(off)=>{const dates=[];const now=new Date();const endDate=new Date(now);endDate.setDate(now.getDate()-off*7);const startDate=new Date(endDate);startDate.setDate(endDate.getDate()-6);for(let d=new Date(startDate);d<=endDate;d.setDate(d.getDate()+1))dates.push(fmtD(new Date(d)));return dates};
const histDates=getHistWeek(histWeekOff);
const maxOff=4;
const histWkLabel=`${histDates[0].slice(5)} â†’ ${histDates[histDates.length-1].slice(5)}`;
const histDows=histDates.map(dt=>{const d=new Date(dt);return DOWS[d.getDay()===0?6:d.getDay()-1]});
return(<div style={{...z.card,marginTop:4}}>
<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8,flexWrap:"wrap",gap:6}}>
<div style={z.lb}>ðŸ“… Editar Historial (Ãºltimo mes)</div>
<div style={{display:"flex",alignItems:"center",gap:6}}>
<button style={z.btnS(false)} disabled={histWeekOff>=maxOff} onClick={()=>setHistWeekOff(Math.min(maxOff,histWeekOff+1))}>â† Ant</button>
<span style={{fontFamily:"monospace",fontSize:"0.68rem",color:C.cyan,fontWeight:600}}>{histWkLabel}</span>
<button style={z.btnS(false)} disabled={histWeekOff<=1} onClick={()=>setHistWeekOff(Math.max(1,histWeekOff-1))}>Sig â†’</button>
</div></div>
<div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse",minWidth:500}}>
<thead><tr><th style={z.th}>HÃ¡bito</th>{histDates.map((dt,i)=><th key={i} style={{...z.th,textAlign:"center"}}><div>{histDows[i]}</div><div style={{fontSize:"0.45rem",color:C.t3}}>{dt.slice(5)}</div></th>)}<th style={{...z.th,textAlign:"center"}}>Score</th></tr></thead>
<tbody>{activeH.map(h=>{let sc=0;histDates.forEach(dt=>{if(hw[`${dt}_${h.id}`])sc++});return(<tr key={h.id}><td style={{...z.td,fontWeight:500,fontSize:"0.72rem"}}>{h.emoji} {h.name}</td>
{histDates.map((dt,i)=>{const key=`${dt}_${h.id}`;const done=hw[key];return<td key={i} style={{...z.td,textAlign:"center",cursor:"pointer",padding:"4px 2px"}} onClick={()=>{const n={...hw};n[key]=!done;sv({...D,habitWeekly:n})}}><span style={{display:"inline-block",width:24,height:24,borderRadius:6,lineHeight:"24px",fontSize:"0.66rem",background:done?C.cyan:C.bg3,color:done?C.bg0:C.t3,fontWeight:700}}>{done?"âœ“":""}</span></td>})}
<td style={{...z.td,textAlign:"center",fontFamily:"monospace",fontWeight:600,color:C.cyan}}>{sc}/7</td></tr>)})}</tbody></table></div>
</div>)})()}

{editH!==null&&hf&&<Mdl title="âœï¸ HÃ¡bito" onClose={saveHab} ch={<div style={{display:"flex",flexDirection:"column",gap:10}}>
<G2><div><div style={{...z.lb,marginBottom:4}}>Emoji</div><input style={z.inp} value={hf.emoji} onChange={e=>setHf({...hf,emoji:e.target.value})}/></div><div><div style={{...z.lb,marginBottom:4}}>Nombre</div><input style={z.inp} value={hf.name} onChange={e=>setHf({...hf,name:e.target.value})}/></div></G2>
<div><div style={{...z.lb,marginBottom:4}}>Meta</div><input style={z.inp} value={hf.meta} onChange={e=>setHf({...hf,meta:e.target.value})}/></div>
<div style={{display:"flex",gap:8}}><button style={z.btn(hf.active)} onClick={()=>setHf({...hf,active:!hf.active})}>{hf.active?"Activo âœ“":"Inactivo"}</button><button style={z.btnD} onClick={()=>{delH(editH);closeHab()}}>Eliminar</button><button style={z.btn(false)} onClick={saveHab}>Cerrar</button></div></div>}/>}
</div>)};

/* === HORARIO === */
const HorarioPage=()=>{
const[edit,setEdit]=useState(null);
const updSlot=(ri,si,v)=>{const h=[...horario];h[ri]={...h[ri],slots:[...h[ri].slots]};h[ri].slots[si]=v;sv({...D,horario:h})};
const addRow=()=>{sv({...D,horario:[...horario,{hour:"??:00",slots:["","","","","","",""]}]})};
const delRow=i=>{const h=[...horario];h.splice(i,1);sv({...D,horario:h})};
const updHr=(i,v)=>{const h=[...horario];h[i]={...h[i],hour:v};sv({...D,horario:h})};
const colFor=v=>{if(!v)return{bg:"transparent",c:C.t3};if(v.includes("Gym"))return{bg:C.lime+"15",c:C.lime};if(v.includes("Work")||v.includes("Proyectos")||v.includes("Reuniones"))return{bg:C.blue+"15",c:C.blue};if(v.includes("Estudiar"))return{bg:C.cyan+"15",c:C.cyan};if(v.includes("Tenis")||v.includes("PÃ¡del"))return{bg:C.orange+"15",c:C.orange};if(v.includes("Lectura"))return{bg:C.purple+"15",c:C.purple};if(v.includes("Descanso")||v.includes("Libre"))return{bg:C.t3+"15",c:C.t3};if(v.includes("Almuerzo"))return{bg:C.green+"15",c:C.green};return{bg:C.bg3,c:C.t1}};
const saveEdit=(e)=>{if(!e)return;if(e.isHour)updHr(e.ri,e.val);else updSlot(e.ri,e.si,e.val)};
const startEdit=(key,ri,si,isHour,val)=>{if(edit){saveEdit(edit);return}setEdit({key,ri,si,isHour,val})};
const updVal=val=>setEdit(e=>e?{...e,val}:null);
const confirmEdit=()=>{saveEdit(edit);setEdit(null)};
const cancelEdit=()=>setEdit(null);
return(<div style={{animation:"fadeIn 0.3s ease-out"}}>
<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}><div style={{fontSize:"1.3rem",fontWeight:700}}>ðŸ“… Horario</div><div style={{display:"flex",gap:6}}>{edit&&<button style={z.btnS(true)} onClick={confirmEdit}>Guardar âœ“</button>}<button style={z.btn(true)} onClick={addRow}>+ Franja</button></div></div>
<div style={z.card}><div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse",minWidth:600}}>
<thead><tr><th style={z.th}>Hora</th>{DOWS.map(d=><th key={d} style={{...z.th,textAlign:"center"}}>{d}</th>)}<th style={z.th}></th></tr></thead>
<tbody>{horario.map((row,ri)=>(<tr key={ri}>
<td style={{...z.td,padding:"4px"}}>{edit&&edit.key===`h${ri}`?<input style={{...z.inpM,padding:"4px",maxWidth:65}} value={edit.val} autoFocus onChange={e=>updVal(e.target.value)} onKeyDown={e=>{if(e.key==="Enter")confirmEdit();if(e.key==="Escape")cancelEdit()}}/>:<span style={{fontFamily:"monospace",fontWeight:600,fontSize:"0.72rem",color:C.t3,cursor:"pointer"}} onClick={()=>startEdit(`h${ri}`,ri,null,true,row.hour)}>{row.hour}</span>}</td>
{row.slots.map((v,si)=>{const col=colFor(v);const key=`${ri}-${si}`;return<td key={si} style={{...z.td,textAlign:"center",background:col.bg,padding:"4px 2px"}} onClick={()=>{if(!edit||edit.key!==key)startEdit(key,ri,si,false,v)}}>
{edit&&edit.key===key?<input style={{...z.inp,padding:"4px",fontSize:"0.7rem",textAlign:"center",maxWidth:110}} value={edit.val} autoFocus onChange={e=>updVal(e.target.value)} onClick={e=>e.stopPropagation()} onKeyDown={e=>{if(e.key==="Enter")confirmEdit();if(e.key==="Escape")cancelEdit()}}/>:<span style={{color:col.c,fontSize:"0.7rem",fontWeight:v?500:400,cursor:"pointer"}}>{v||"â€”"}</span>}</td>})}
<td style={z.td}><button style={{...z.btnD,padding:"2px 5px",fontSize:"0.5rem"}} onClick={()=>delRow(ri)}>âœ•</button></td></tr>))}</tbody></table></div></div></div>)};

/* === LECTURA === */
const LecturaPage=()=>{
const[editB,setEditB]=useState(null);const[showLF,setShowLF]=useState(false);const[lf,setLf]=useState({date:todayS(),book:"",pages:"",minutes:"",notes:""});
const addBk=()=>{sv({...D,books:[...books,{id:uid(),title:"Nuevo Libro",author:"",status:"queue",progress:0,genre:"",rating:0,startDate:"",notes:""}]})};
const updBk=(i,u)=>{const b=[...books];b[i]={...b[i],...u};sv({...D,books:b})};
const delBk=i=>{const b=[...books];b.splice(i,1);sv({...D,books:b})};
const addLog=()=>{if(!lf.book)return;sv({...D,readingLog:[{id:uid(),...lf},...readingLog]});setLf({date:todayS(),book:"",pages:"",minutes:"",notes:""});setShowLF(false)};
const delLog=i=>{const r=[...readingLog];r.splice(i,1);sv({...D,readingLog:r})};
const reading=books.filter(b=>b.status==="reading");const queue=books.filter(b=>b.status==="queue");const done=books.filter(b=>b.status==="done");
const BkEdit=({idx,onClose})=>{const b=books[idx];const[f,setF]=useState({...b});return(<Mdl title="âœï¸ Libro" onClose={onClose} ch={<div style={{display:"flex",flexDirection:"column",gap:10}}>
<div><div style={{...z.lb,marginBottom:4}}>TÃ­tulo</div><input style={z.inp} value={f.title} onChange={e=>setF({...f,title:e.target.value})}/></div>
<G2><div><div style={{...z.lb,marginBottom:4}}>Autor</div><input style={z.inp} value={f.author} onChange={e=>setF({...f,author:e.target.value})}/></div><div><div style={{...z.lb,marginBottom:4}}>GÃ©nero</div><input style={z.inp} value={f.genre} onChange={e=>setF({...f,genre:e.target.value})}/></div></G2>
<G3><div><div style={{...z.lb,marginBottom:4}}>Status</div><select style={z.inpM} value={f.status} onChange={e=>setF({...f,status:e.target.value})}><option value="reading">ðŸ“– Leyendo</option><option value="queue">ðŸ“‹ Cola</option><option value="done">âœ… Terminado</option></select></div><div><div style={{...z.lb,marginBottom:4}}>Progreso %</div><input style={z.inpM} type="number" min="0" max="100" value={f.progress} onChange={e=>setF({...f,progress:+e.target.value})}/></div><div><div style={{...z.lb,marginBottom:4}}>Rating</div><input style={z.inpM} type="number" min="0" max="5" value={f.rating} onChange={e=>setF({...f,rating:+e.target.value})}/></div></G3>
<div><div style={{...z.lb,marginBottom:4}}>Notas</div><textarea style={{...z.inp,minHeight:45}} value={f.notes||""} onChange={e=>setF({...f,notes:e.target.value})}/></div>
<div style={{display:"flex",gap:8}}><button style={z.btn(true)} onClick={()=>{updBk(idx,f);onClose()}}>Guardar</button><button style={z.btnD} onClick={()=>{delBk(idx);onClose()}}>Eliminar</button><button style={z.btn(false)} onClick={onClose}>Cancelar</button></div></div>}/>)};
return(<div style={{animation:"fadeIn 0.3s ease-out"}}>
<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}><div style={{fontSize:"1.3rem",fontWeight:700}}>ðŸ“š Lectura</div><div style={{display:"flex",gap:6}}><button style={z.btn(true)} onClick={addBk}>+ Libro</button><button style={z.btnS(false)} onClick={()=>setShowLF(!showLF)}>ðŸ“ Log</button></div></div>
<G3><div style={z.card}><div style={z.lb}>Total</div><div style={z.big}>{books.length}</div></div><div style={z.card}><div style={z.lb}>Leyendo</div><div style={z.big}>{reading.length}</div></div><div style={z.card}><div style={z.lb}>Cola</div><div style={z.big}>{queue.length}</div></div><div style={z.card}><div style={z.lb}>Terminados</div><div style={z.big}>{done.length}</div></div></G3>
<div style={z.card}><div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse",minWidth:550}}><thead><tr>{["Libro","Autor","Status","Progreso","Rating","Notas",""].map(h=><th key={h} style={z.th}>{h}</th>)}</tr></thead>
<tbody>{books.map((b,i)=>(<tr key={b.id}><td style={{...z.td,fontWeight:600}}>{b.title}</td><td style={{...z.td,color:C.t2}}>{b.author}</td><td style={z.td}><span style={z.tag(b.status==="reading"?C.blue:b.status==="done"?C.green:C.t3)}>{b.status==="reading"?"ðŸ“–":"ðŸ“‹"}</span></td><td style={z.td}><div style={{display:"flex",alignItems:"center",gap:4}}><div style={{width:40,height:4,background:C.bg3,borderRadius:100,overflow:"hidden"}}><div style={{height:"100%",width:`${b.progress}%`,background:C.blue,borderRadius:100}}/></div><span style={{fontFamily:"monospace",fontSize:"0.65rem"}}>{b.progress}%</span></div></td><td style={z.td}>{b.rating>0?"â­".repeat(b.rating):"â€”"}</td><td style={{...z.td,fontSize:"0.7rem",color:C.t2,maxWidth:100,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{b.notes}</td><td style={z.td}><button style={z.btnS(false)} onClick={()=>setEditB(i)}>âœï¸</button></td></tr>))}</tbody></table></div></div>
{showLF&&<div style={{...z.card,background:C.bg2}}><div style={z.lb}>ðŸ“ Nueva Entrada</div><div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(100px,1fr))",gap:8,marginBottom:10}}><div><select style={z.inpM} value={lf.book} onChange={e=>setLf({...lf,book:e.target.value})}><option value="">Libro...</option>{books.map(b=><option key={b.id} value={b.title}>{b.title}</option>)}</select></div><div><input style={z.inpM} type="date" value={lf.date} onChange={e=>setLf({...lf,date:e.target.value})}/></div><div><input style={z.inpM} type="number" placeholder="PÃ¡gs" value={lf.pages} onChange={e=>setLf({...lf,pages:e.target.value})}/></div><div><input style={z.inpM} type="number" placeholder="Min" value={lf.minutes} onChange={e=>setLf({...lf,minutes:e.target.value})}/></div></div><div style={{marginBottom:8}}><input style={z.inp} value={lf.notes} onChange={e=>setLf({...lf,notes:e.target.value})} placeholder="Notas"/></div><button style={z.btn(true)} onClick={addLog}>Agregar</button></div>}
<div style={z.card}><div style={z.lb}>ðŸ“ Log</div><div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse"}}><thead><tr>{["Fecha","Libro","PÃ¡gs","Min","Notas",""].map(h=><th key={h} style={z.th}>{h}</th>)}</tr></thead><tbody>{readingLog.map((r,i)=>(<tr key={r.id||i}><td style={{...z.td,fontFamily:"monospace"}}>{r.date}</td><td style={{...z.td,fontWeight:500}}>{r.book}</td><td style={{...z.td,fontFamily:"monospace"}}>{r.pages}</td><td style={{...z.td,fontFamily:"monospace"}}>{r.minutes}</td><td style={{...z.td,color:C.t2,fontSize:"0.72rem"}}>{r.notes}</td><td style={z.td}><button style={{...z.btnD,padding:"2px 5px",fontSize:"0.5rem"}} onClick={()=>delLog(i)}>âœ•</button></td></tr>))}</tbody></table></div></div>
{editB!==null&&<BkEdit idx={editB} onClose={()=>setEditB(null)}/>}
</div>)};

/* === TRENDS === */
const TREND_METRICS=[
{id:"weight",lb:"Peso",key:"weight",unit:"kg",color:C.lime,filter:e=>e.weight},
{id:"cal",lb:"CalorÃ­as",key:"cal",unit:"kcal",color:C.orange,filter:e=>+e.cal>0},
{id:"prot",lb:"ProteÃ­na",key:"prot",unit:"g",color:C.blue,filter:e=>+e.prot>0},
{id:"steps",lb:"Pasos",key:"steps",unit:"pasos",color:C.green,filter:e=>+e.steps>0},
{id:"fat",lb:"Grasas",key:"fat",unit:"g",color:C.red,filter:e=>+e.fat>0},
{id:"carbs",lb:"Carbos",key:"carbs",unit:"g",color:C.cyan,filter:e=>+e.carbs>0},
{id:"sugar",lb:"AzÃºcar",key:"sugar",unit:"g",color:C.pink,filter:e=>+e.sugar>0},
{id:"fiber",lb:"Fibra",key:"fiber",unit:"g",color:C.amber,filter:e=>+e.fiber>0},
{id:"waist",lb:"Cintura",key:"waist",unit:"cm",color:C.purple,filter:e=>e.waist},
{id:"sleep",lb:"SueÃ±o",key:"sleep",unit:"hrs",color:C.cyan,filter:e=>+e.sleep>0}
];
const TrendsPage=()=>{
const tDateFrom=gTrendFrom,setTDateFrom=setGTrendFrom,tDateTo=gTrendTo,setTDateTo=setGTrendTo;
const tfl=fl.filter(e=>{if(tDateFrom&&e.date<tDateFrom)return false;if(tDateTo&&e.date>tDateTo)return false;return true});
const trendCharts=S.trendCharts||["weight","cal","prot","steps"];
const setTChart=(idx,mid)=>{const nc=[...trendCharts];nc[idx]=mid;sv({...D,settings:{...S,trendCharts:nc}})};
const addTChart=()=>{const avail=TREND_METRICS.find(m=>!trendCharts.includes(m.id));if(avail)sv({...D,settings:{...S,trendCharts:[...trendCharts,avail.id]}})};
const rmTChart=idx=>{if(trendCharts.length<=1)return;const nc=[...trendCharts];nc.splice(idx,1);sv({...D,settings:{...S,trendCharts:nc}})};
const wArr=tfl.filter(e=>e.weight);const wr=wArr.length>=7?((+wArr[0].weight)-(+wArr[wArr.length-1].weight))/(wArr.length/7):0;
const wAvg=movAvg(tfl.filter(e=>e.weight),"weight");const calAvg=movAvg(tfl.filter(e=>+e.cal>0),"cal");
return(<div style={{animation:"fadeIn 0.3s ease-out"}}>
<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}>
<div style={{fontSize:"1.3rem",fontWeight:700}}>ðŸ“ˆ Tendencias</div>
<div style={{display:"flex",gap:6}}>{trendCharts.length<TREND_METRICS.length&&<button style={z.btnS(false)} onClick={addTChart}>+ GrÃ¡fica</button>}</div>
</div>
<div style={{...z.card,padding:"10px 14px",marginBottom:14,display:"flex",alignItems:"center",gap:10,flexWrap:"wrap"}}>
<span style={{fontSize:"0.72rem",fontWeight:600,color:C.t2}}>ðŸ“… Filtrar</span>
<div style={{display:"flex",alignItems:"center",gap:6}}>
<label style={{fontSize:"0.65rem",color:C.t3}}>Desde</label>
<input type="date" style={{...z.inpM,padding:"4px 8px",fontSize:"0.7rem",maxWidth:140,colorScheme:"dark"}} value={tDateFrom} onChange={e=>setTDateFrom(e.target.value)}/>
</div>
<div style={{display:"flex",alignItems:"center",gap:6}}>
<label style={{fontSize:"0.65rem",color:C.t3}}>Hasta</label>
<input type="date" style={{...z.inpM,padding:"4px 8px",fontSize:"0.7rem",maxWidth:140,colorScheme:"dark"}} value={tDateTo} onChange={e=>setTDateTo(e.target.value)}/>
</div>
{(tDateFrom||tDateTo)&&<button style={{...z.btnS(false),padding:"4px 10px",fontSize:"0.65rem"}} onClick={()=>{setTDateFrom("");setTDateTo("")}}>âœ• Reset</button>}
{(tDateFrom||tDateTo)&&<span style={{fontSize:"0.63rem",color:C.lime,fontWeight:600}}>{tfl.length} registros</span>}
</div>
<G3><div style={z.card}><div style={z.lb}>Ritmo</div><div style={z.big}>{wr.toFixed(2)}</div><div style={{fontSize:"0.72rem",color:C.t2,marginTop:3}}>kg/sem</div></div>
<div style={z.card}><div style={z.lb}>Peso 7d</div><div style={z.big}>{wAvg.length>0?wAvg[wAvg.length-1].v:curW}</div><div style={{fontSize:"0.72rem",color:C.t2,marginTop:3}}>kg</div></div>
<div style={z.card}><div style={z.lb}>Cal 7d</div><div style={z.big}>{calAvg.length>0?calAvg[calAvg.length-1].v:0}</div><div style={{fontSize:"0.72rem",color:C.t2,marginTop:3}}>kcal</div></div></G3>
<div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>{trendCharts.map((mid,ci)=>{const m=TREND_METRICS.find(x=>x.id===mid)||TREND_METRICS[0];
const pts=tfl.filter(m.filter).map(e=>({v:+e[m.key],label:e.date.slice(5)}));
const avg7=movAvg(tfl.filter(m.filter),m.key);
return(<div key={ci} style={z.card}>
<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
<div style={{display:"flex",alignItems:"center",gap:6}}>
<select style={{background:"transparent",border:"none",color:m.color,fontSize:"0.6rem",fontWeight:700,letterSpacing:0.5,textTransform:"uppercase",cursor:"pointer",padding:0,fontFamily:"inherit",outline:"none",appearance:"auto",WebkitAppearance:"menulist",colorScheme:"dark"}} value={mid} onChange={e=>setTChart(ci,e.target.value)}>
{TREND_METRICS.map(o=><option key={o.id} value={o.id}>{o.lb} ({o.unit})</option>)}
</select>
</div>
<div style={{display:"flex",alignItems:"center",gap:6}}>
<span style={{fontSize:"0.5rem",color:C.t3}}>â€” Real <span style={{color:C.orange}}>--- 7d</span></span>
{trendCharts.length>1&&<button style={{background:"none",border:"none",color:C.red+"55",cursor:"pointer",fontSize:"0.55rem"}} onClick={()=>rmTChart(ci)}>âœ•</button>}
</div>
</div>
<Chart pts={pts} pts2={avg7} color={m.color} color2={C.orange} h={155}/>
</div>)})}</div>
</div>)};

/* === WEEKLY REPORT === */
const RPT_METRICS=[
{id:"weight",lb:"Î” Peso",em:"âš–ï¸",unit:"kg",color:C.lime,calc:d=>{const wS2=d.length>0?+d[0].weight:S.startWeight;const wE2=d.length>0?+d[d.length-1].weight:S.startWeight;return(wS2-wE2).toFixed(1)},txt:d=>{const wS2=d.length>0?+d[0].weight:S.startWeight;const wE2=d.length>0?+d[d.length-1].weight:S.startWeight;return`Peso: ${wS2} â†’ ${wE2} kg (${(wS2-wE2).toFixed(1)} kg)`}},
{id:"cal",lb:"Prom Cal",em:"ðŸ”¥",unit:"kcal",color:C.orange,calc:d=>{const f=d.filter(e=>+e.cal>0);return f.length?(f.reduce((a,e)=>a+(+e.cal),0)/f.length).toFixed(1):"0"},txt:d=>`Cal promedio: ${RPT_METRICS.find(m=>m.id==="cal").calc(d)} kcal/dÃ­a`},
{id:"prot",lb:"Prom Prot",em:"ðŸ¥©",unit:"g",color:C.blue,calc:d=>{const f=d.filter(e=>+e.prot>0);return f.length?(f.reduce((a,e)=>a+(+e.prot),0)/f.length).toFixed(1):"0"},txt:d=>`Prot promedio: ${RPT_METRICS.find(m=>m.id==="prot").calc(d)}g/dÃ­a`},
{id:"comp",lb:"Compliance",em:"âœ“",unit:"dÃ­as",color:C.green,calc:d=>d.filter(e=>chkComp(e).day).length+"/"+d.length,txt:d=>`DÃ­as compliance: ${d.filter(e=>chkComp(e).day).length}/${d.length}`},
{id:"steps",lb:"Prom Pasos",em:"ðŸ‘Ÿ",unit:"pasos",color:C.purple,calc:d=>{const f=d.filter(e=>+e.steps>0);return f.length?(f.reduce((a,e)=>a+(+e.steps),0)/f.length).toFixed(0):"0"},txt:d=>`Pasos promedio: ${(+RPT_METRICS.find(m=>m.id==="steps").calc(d)).toLocaleString()}`},
{id:"fat",lb:"Prom Grasa",em:"ðŸ¥‘",unit:"g",color:C.red,calc:d=>{const f=d.filter(e=>+e.fat>0);return f.length?(f.reduce((a,e)=>a+(+e.fat),0)/f.length).toFixed(1):"0"},txt:d=>`Grasa promedio: ${RPT_METRICS.find(m=>m.id==="fat").calc(d)}g/dÃ­a`},
{id:"carbs",lb:"Prom Carbos",em:"ðŸš",unit:"g",color:C.cyan,calc:d=>{const f=d.filter(e=>+e.carbs>0);return f.length?(f.reduce((a,e)=>a+(+e.carbs),0)/f.length).toFixed(1):"0"},txt:d=>`Carbos promedio: ${RPT_METRICS.find(m=>m.id==="carbs").calc(d)}g/dÃ­a`},
{id:"sugar",lb:"Prom AzÃºcar",em:"ðŸ¬",unit:"g",color:C.pink,calc:d=>{const f=d.filter(e=>+e.sugar>0);return f.length?(f.reduce((a,e)=>a+(+e.sugar),0)/f.length).toFixed(1):"0"},txt:d=>`AzÃºcar promedio: ${RPT_METRICS.find(m=>m.id==="sugar").calc(d)}g/dÃ­a`},
{id:"fiber",lb:"Prom Fibra",em:"ðŸŒ¾",unit:"g",color:C.amber,calc:d=>{const f=d.filter(e=>+e.fiber>0);return f.length?(f.reduce((a,e)=>a+(+e.fiber),0)/f.length).toFixed(1):"0"},txt:d=>`Fibra promedio: ${RPT_METRICS.find(m=>m.id==="fiber").calc(d)}g/dÃ­a`},
{id:"sleep",lb:"Prom SueÃ±o",em:"ðŸ˜´",unit:"hrs",color:C.cyan,calc:d=>{const f=d.filter(e=>+e.sleep>0);return f.length?(f.reduce((a,e)=>a+(+e.sleep),0)/f.length).toFixed(1):"â€”"},txt:d=>`SueÃ±o promedio: ${RPT_METRICS.find(m=>m.id==="sleep").calc(d)} hrs`}
];
const ReportPage=()=>{
const rDateFrom=gRepFrom,setRDateFrom=setGRepFrom,rDateTo=gRepTo,setRDateTo=setGRepTo;
const rfl=fl.filter(e=>{if(rDateFrom&&e.date<rDateFrom)return false;if(rDateTo&&e.date>rDateTo)return false;return true});
const dataSet=rfl.length>0?rfl:fl.slice(-7);
const activeH=habits.filter(h=>h.active);
const rDates=rfl.length>0?rfl.map(e=>e.date):getWk();
let habTot=0,habMax=0;activeH.forEach(h=>{rDates.forEach(dt=>{habMax++;if(hw[`${dt}_${h.id}`])habTot++})});
const habPct=habMax>0?Math.round(habTot/habMax*100):0;
const[copied,setCopied]=useState(false);
const periodLabel=(rDateFrom||rDateTo)?`${rDateFrom||"inicio"} â†’ ${rDateTo||"hoy"}`:"Ãšltima semana";
const rpt=`ðŸ“Š REPORTE â€” ${S.planName}\n${"â”€".repeat(35)}\nðŸ“… Periodo: ${periodLabel} (${dataSet.length} dÃ­as)\n\nðŸ‹ï¸ FITNESS\n${RPT_METRICS.map(m=>`â€¢ ${m.txt(dataSet)}`).join("\n")}\n\nðŸŽ¯ HÃBITOS: ${habPct}%\n${activeH.map(h=>{let c=0;rDates.forEach(dt=>{if(hw[`${dt}_${h.id}`])c++});return`â€¢ ${h.emoji} ${h.name}: ${c}/${rDates.length}`}).join("\n")}\n\nðŸ“‚ PROYECTOS\n${projects.map(p=>`â€¢ ${p.name}: ${p.progress}% â€” ${p.status}`).join("\n")}\n\nðŸ“š LECTURA\n${books.filter(b=>b.status==="reading").map(b=>`â€¢ ${b.title}: ${b.progress}%`).join("\n")}\n\nðŸ“… ${new Date().toLocaleDateString("es",{day:"numeric",month:"long",year:"numeric"})}`;
const copy=()=>{navigator.clipboard.writeText(rpt).then(()=>{setCopied(true);setTimeout(()=>setCopied(false),2000)})};
return(<div style={{animation:"fadeIn 0.3s ease-out"}}>
<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}><div style={{fontSize:"1.3rem",fontWeight:700}}>ðŸ“‹ Reporte</div><button style={z.btn(true)} onClick={copy}>{copied?"âœ“ Copiado!":"ðŸ“‹ Copiar"}</button></div>
<div style={{...z.card,padding:"10px 14px",marginBottom:14,display:"flex",alignItems:"center",gap:10,flexWrap:"wrap"}}>
<span style={{fontSize:"0.72rem",fontWeight:600,color:C.t2}}>ðŸ“… Filtrar</span>
<div style={{display:"flex",alignItems:"center",gap:6}}>
<label style={{fontSize:"0.65rem",color:C.t3}}>Desde</label>
<input type="date" style={{...z.inpM,padding:"4px 8px",fontSize:"0.7rem",maxWidth:140,colorScheme:"dark"}} value={rDateFrom} onChange={e=>setRDateFrom(e.target.value)}/>
</div>
<div style={{display:"flex",alignItems:"center",gap:6}}>
<label style={{fontSize:"0.65rem",color:C.t3}}>Hasta</label>
<input type="date" style={{...z.inpM,padding:"4px 8px",fontSize:"0.7rem",maxWidth:140,colorScheme:"dark"}} value={rDateTo} onChange={e=>setRDateTo(e.target.value)}/>
</div>
{(rDateFrom||rDateTo)&&<button style={{...z.btnS(false),padding:"4px 10px",fontSize:"0.65rem"}} onClick={()=>{setRDateFrom("");setRDateTo("")}}>âœ• Reset</button>}
{(rDateFrom||rDateTo)&&<span style={{fontSize:"0.63rem",color:C.lime,fontWeight:600}}>{rfl.length} dÃ­as</span>}
</div>
<div style={z.card}><div style={z.lb}>Vista previa</div><pre style={{fontFamily:"'IBM Plex Mono',monospace",fontSize:"0.7rem",color:C.t1,whiteSpace:"pre-wrap",lineHeight:1.7,background:C.bg0,padding:14,borderRadius:10,border:`1px solid ${C.b1}`,overflowX:"auto"}}>{rpt}</pre></div>
</div>)};

/* === DASHBOARD === */
const DashboardPage=()=>{
const tasks=D?.todayTasks||DEF_TT;const activeH=habits.filter(h=>h.active);const wk=getWk();
const toggleTask=i=>{const t=[...tasks];t[i]={...t[i],done:!t[i].done};sv({...D,todayTasks:t})};
const[jText,setJText]=useState(journal[todayS()]||"");
const saveJ=()=>{sv({...D,journal:{...journal,[todayS()]:jText}})};
return(<div style={{animation:"fadeIn 0.3s ease-out"}}>
<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:10}}>
<div><div style={{fontSize:"1.4rem",fontWeight:800}}>âš¡ Life Dashboard</div><div style={{fontSize:"0.75rem",color:C.t3}}>Proyectos Â· HÃ¡bitos Â· Horario Â· Lectura Â· Fitness</div></div>
<div style={{fontFamily:"monospace",fontSize:"0.75rem",color:C.t2,padding:"6px 12px",background:C.bg2,border:`1px solid ${C.b1}`,borderRadius:8}}>{new Date().toLocaleDateString("es",{weekday:"long",day:"numeric",month:"short"})}</div></div>

{/* === GOALS SECTION === */}
{(()=>{
const[goalsEdit,setGoalsEdit]=useState(false);
const[gf,setGf]=useState(null);
const wkFl=fl.filter(e=>{const w=getWk();return w.includes(e.date)});
const r1d=(arr,k)=>{const f=arr.filter(e=>+e[k]>0);return f.length>0?Math.round(f.reduce((a,x)=>a+(+x[k]||0),0)/f.length*10)/10:0};
const realCal=r1d(wkFl,"cal");
const realProt=r1d(wkFl,"prot");
const realFat=r1d(wkFl,"fat");
const realCarbs=r1d(wkFl,"carbs");
const realSugar=r1d(wkFl,"sugar");
const realFiber=r1d(wkFl,"fiber");
const goalRows=[
{lb:"CalorÃ­as",key:"cal",em:"ðŸ”¥",c:C.orange,unit:"kcal",goal:activeGP.cal,real:realCal},
{lb:"ProteÃ­na",key:"prot",em:"ðŸ¥©",c:C.blue,unit:"g",goal:activeGP.prot,real:realProt},
{lb:"Grasas",key:"fat",em:"ðŸ¥‘",c:C.red,unit:"g",goal:activeGP.fat,real:realFat},
{lb:"Carbos",key:"carbs",em:"ðŸš",c:C.green,unit:"g",goal:activeGP.carbs,real:realCarbs},
{lb:"AzÃºcar mÃ¡x",key:"sugar",em:"ðŸ¬",c:C.pink,unit:"g",goal:activeGP.sugar,real:realSugar}
];
return(<div style={z.card}>
<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
<div style={z.lb}>ðŸŽ¯ Objetivos â€” {activeGP.name}</div>
<div style={{display:"flex",gap:6}}>
<select style={{...z.inpM,padding:"4px 8px",fontSize:"0.65rem",maxWidth:130,colorScheme:"dark"}} value={S.activeGoalProfile||"cut"} onChange={e=>setActiveProfile(e.target.value)}>
{goalProfiles.map(g=><option key={g.id} value={g.id}>{g.name}</option>)}
</select>
<button style={z.btnS(false)} onClick={()=>{setGoalsEdit(!goalsEdit);setGf({...activeGP})}}>âœï¸</button>
</div></div>
<div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))",gap:8}}>
{goalRows.map(r=>(<div key={r.key} style={{padding:"8px 10px",background:C.bg2,borderRadius:8,border:`1px solid ${C.b1}`}}>
<div style={{fontSize:"0.58rem",textTransform:"uppercase",letterSpacing:1,color:r.c,fontWeight:600,marginBottom:4}}>{r.em} {r.lb}</div>
<div style={{fontFamily:"monospace",fontSize:"1rem",fontWeight:700}}>{r.goal}{r.unit==="kcal"?"":""} <span style={{fontSize:"0.6rem",color:C.t3}}>{r.unit}</span></div>
{r.real!==""&&<div style={{fontSize:"0.65rem",color:r.real<=r.goal*1.1&&r.real>=r.goal*0.9?C.green:C.orange,marginTop:3}}>Real: {r.real} {r.unit} {r.real<=r.goal*1.1&&r.real>=r.goal*0.9?"âœ“":"âš "}</div>}
</div>))}
</div>
{goalsEdit&&gf&&<div style={{marginTop:12,padding:14,background:C.bg2,borderRadius:10,border:`1px solid ${C.b1}`}}>
<div style={{fontSize:"0.78rem",fontWeight:600,marginBottom:10}}>Editar perfil: {gf.name}</div>
<div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(100px,1fr))",gap:8,marginBottom:10}}>
{[["CalorÃ­as","cal"],["ProteÃ­na","prot"],["Grasas","fat"],["Carbos","carbs"],["AzÃºcar mÃ¡x","sugar"]].map(([l,k])=>(<div key={k}><div style={{fontSize:"0.58rem",color:C.t3,marginBottom:3}}>{l}</div><input style={z.inpM} type="number" value={gf[k]} onChange={e=>setGf({...gf,[k]:validateGoal(k,e.target.value)})}/></div>))}
</div>
<div style={{display:"flex",gap:6}}>
<button style={z.btn(true)} onClick={()=>{updGoalProfile(activeGP.id,gf);setGoalsEdit(false)}}>Guardar</button>
<button style={z.btn(false)} onClick={()=>setGoalsEdit(false)}>Cancelar</button>
</div>
</div>}
</div>)})()}

<div style={z.card}><div style={z.lb}>ðŸ“‚ Proyectos</div>
{projects.map(p=>(<div key={p.id} style={{display:"flex",alignItems:"center",gap:10,padding:"7px 0",borderBottom:`1px solid ${C.b1}`,flexWrap:"wrap"}}>
<span style={{fontWeight:600,flex:1,fontSize:"0.83rem",minWidth:100}}>{p.name}</span>
<span style={z.tag(p.status==="En progreso"?C.blue:C.green)}>{p.status}</span>
<div style={{width:70}}><div style={{width:"100%",height:5,background:C.bg3,borderRadius:100,overflow:"hidden"}}><div style={{height:"100%",borderRadius:100,width:`${p.progress}%`,background:C.lime}}/></div><div style={{fontSize:"0.58rem",color:C.t3,textAlign:"right",marginTop:2}}>{p.progress}%</div></div>
<span style={z.tag(p.priority==="Alta"?C.red:C.orange)}>{p.priority}</span></div>))}</div>

<G2>
<div style={z.card}><div style={z.lb}>ðŸŽ¯ HÃ¡bitos</div>
<div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse"}}><thead><tr><th style={z.th}>HÃ¡bito</th>{DOWS.map(d=><th key={d} style={{...z.th,textAlign:"center",padding:"4px 2px"}}>{d}</th>)}</tr></thead>
<tbody>{activeH.map(h=>(<tr key={h.id}><td style={{...z.td,fontSize:"0.7rem",fontWeight:500}}>{h.emoji} {h.name}</td>
{wk.map((dt,i)=>{const key=`${dt}_${h.id}`;const done=hw[key];return<td key={i} style={{...z.td,textAlign:"center",cursor:"pointer",padding:"3px 1px"}} onClick={()=>{const n={...hw};n[key]=!done;sv({...D,habitWeekly:n})}}><span style={{display:"inline-block",width:18,height:18,borderRadius:4,lineHeight:"18px",fontSize:"0.56rem",background:done?C.lime:C.bg3,color:done?C.bg0:C.t3,fontWeight:700}}>{done?"âœ“":""}</span></td>})}</tr>))}</tbody></table></div></div>

<div>
<div style={{...z.card,marginBottom:12}}><div style={z.lb}>ðŸ‹ï¸ Mini-Cut</div>
<div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:5,fontSize:"0.78rem"}}>
<div><span style={{color:C.t3}}>Peso</span><div style={{fontFamily:"monospace",fontWeight:600}}>{curW} kg</div></div>
<div><span style={{color:C.t3}}>Meta</span><div style={{fontFamily:"monospace",fontWeight:600}}>{S.planGoal}</div></div>
<div><span style={{color:C.t3}}>Progreso</span><div style={{fontFamily:"monospace",fontWeight:600}}>{prog}%</div></div>
<div><span style={{color:C.t3}}>Sem completada</span><div style={{fontFamily:"monospace",fontWeight:600}}>{completedWeek}/{S.cutWeeks}</div></div>
<div><span style={{color:C.t3}}>Sem en curso</span><div style={{fontFamily:"monospace",fontWeight:600}}>{currentWeek}/{S.cutWeeks}</div></div></div></div>
<div style={z.card}><div style={z.lb}>ðŸ“š Lectura</div>
{books.filter(b=>b.status==="reading").map(b=>(<div key={b.id} style={{display:"flex",alignItems:"center",gap:8,marginBottom:5}}>
<span style={{flex:1,fontWeight:500,fontSize:"0.78rem"}}>{b.title}</span>
<div style={{width:45,height:4,background:C.bg3,borderRadius:100,overflow:"hidden"}}><div style={{height:"100%",width:`${b.progress}%`,background:C.blue,borderRadius:100}}/></div>
<span style={{fontFamily:"monospace",fontSize:"0.65rem",color:C.t3}}>{b.progress}%</span></div>))}</div>
</div></G2>

<div style={z.card}><div style={z.lb}>âœ… Hoy</div>
{tasks.map((t,i)=>(<div key={t.id} style={{display:"flex",alignItems:"center",gap:8,padding:"6px 0",borderBottom:`1px solid ${C.b1}`,cursor:"pointer"}} onClick={()=>toggleTask(i)}>
<span style={{display:"inline-block",width:20,height:20,borderRadius:5,lineHeight:"20px",textAlign:"center",fontSize:"0.63rem",background:t.done?C.lime:C.bg3,color:t.done?C.bg0:C.t3,fontWeight:700,flexShrink:0}}>{t.done?"âœ“":""}</span>
<span style={{flex:1,fontSize:"0.8rem",textDecoration:t.done?"line-through":"none",color:t.done?C.t3:C.t0}}>{t.task}</span>
<span style={z.tag(t.cat==="Gym"?C.lime:t.cat==="Trabajo"?C.blue:t.cat==="Lectura"?C.purple:t.cat==="Fitness"?C.orange:C.cyan)}>{t.cat}</span></div>))}</div>

<div style={z.card}><div style={z.lb}>ðŸ“ Journal â€” Hoy</div>
<textarea style={{...z.inp,minHeight:70}} value={jText} onChange={e=>setJText(e.target.value)} placeholder="Reflexiones, aprendizajes, gratitud..."/>
<button style={{...z.btn(true),marginTop:8}} onClick={saveJ}>Guardar</button>
{Object.keys(journal).filter(k=>k!==todayS()&&journal[k]).slice(-3).reverse().map(k=>(<div key={k} style={{marginTop:8,padding:"7px 0",borderTop:`1px solid ${C.b1}`}}><span style={{fontFamily:"monospace",fontSize:"0.65rem",color:C.t3}}>{k}</span><div style={{fontSize:"0.78rem",color:C.t1,marginTop:3}}>{journal[k]}</div></div>))}
</div>
</div>)};

/* === FOOD DB MANAGER COMPONENT === */
const FoodDBManager=({personalFoods,onSave})=>{
const[search,setSearch]=useState("");
const[tab,setTab]=useState("personal");/* personal | referencia */
const[editIdx,setEditIdx]=useState(null);
const[form,setForm]=useState({alimento:"",estado:"Natural",kcal:"",proteina_g:"",grasas_g:"",carbs_g:"",azucar_g:"0",fibra_g:"0"});

const filtered=(tab==="personal"?personalFoods:FOOD_DB).filter(f=>{
  if(!search)return true;
  return normFood(f.alimento).includes(normFood(search))||normFood(f.estado).includes(normFood(search));
});

const startEdit=(idx)=>{
  const f=personalFoods[idx];
  setForm({alimento:f.alimento,estado:f.estado,kcal:f.kcal,proteina_g:f.proteina_g,grasas_g:f.grasas_g,carbs_g:f.carbs_g,azucar_g:f.azucar_g||0,fibra_g:f.fibra_g||0});
  setEditIdx(idx);
};

const saveEdit=()=>{
  const entry={alimento:form.alimento.trim(),estado:form.estado,kcal:+form.kcal||0,proteina_g:+form.proteina_g||0,grasas_g:+form.grasas_g||0,grasas_saturadas_g:0,carbs_g:+form.carbs_g||0,azucar_g:+form.azucar_g||0,fibra_g:+form.fibra_g||0,sodio_mg:0,colesterol_mg:0};
  if(!entry.alimento)return;
  const newFoods=[...personalFoods];
  if(editIdx!==null&&editIdx>=0)newFoods[editIdx]=entry;
  else newFoods.push(entry);
  onSave(newFoods);
  setEditIdx(null);setForm({alimento:"",estado:"Natural",kcal:"",proteina_g:"",grasas_g:"",carbs_g:"",azucar_g:"0",fibra_g:"0"});
};

const deleteFood=(idx)=>{
  const newFoods=[...personalFoods];newFoods.splice(idx,1);onSave(newFoods);
};

const copyToPersonal=(entry)=>{
  const newFoods=[...personalFoods,{...entry}];
  onSave(newFoods);
};

return(<div style={{flex:1,overflowY:"auto",padding:"10px 12px",display:"flex",flexDirection:"column",gap:8}}>
{/* Search */}
<input style={{...z.inp,fontSize:"0.72rem",padding:"7px 10px"}} value={search} onChange={e=>setSearch(e.target.value)} placeholder="Buscar alimento..."/>
{/* Tabs */}
<div style={{display:"flex",gap:4}}>
{[["personal",`ðŸŸ¢ Mis alimentos (${personalFoods.length})`],["referencia",`ðŸ”µ Referencia (${FOOD_DB.length})`]].map(([t,l])=>(
<button key={t} onClick={()=>setTab(t)} style={{flex:1,padding:"5px",borderRadius:6,border:`1px solid ${tab===t?C.green:C.b1}`,background:tab===t?C.green+"20":"transparent",color:tab===t?C.t0:C.t3,fontSize:"0.6rem",fontWeight:600,cursor:"pointer",fontFamily:"inherit"}}>{l}</button>
))}
</div>

{/* Add/Edit form */}
{(editIdx!==null||tab==="personal")&&<div style={{padding:8,background:C.bg3,borderRadius:8,border:`1px solid ${C.b1}`}}>
<div style={{fontSize:"0.65rem",fontWeight:600,color:C.green,marginBottom:6}}>{editIdx!==null&&editIdx>=0?"âœï¸ Editando":"âž• Agregar alimento"} (macros por 100g)</div>
<div style={{display:"grid",gridTemplateColumns:"1fr 80px",gap:4,marginBottom:4}}>
<input style={{...z.inp,fontSize:"0.68rem",padding:"5px 8px"}} value={form.alimento} onChange={e=>setForm({...form,alimento:e.target.value})} placeholder="Nombre del alimento"/>
<select style={{...z.inp,fontSize:"0.68rem",padding:"5px 4px"}} value={form.estado} onChange={e=>setForm({...form,estado:e.target.value})}>
{["Natural","Cocido","Cocida","Crudo","Cruda","Polvo"].map(s=><option key={s} value={s}>{s}</option>)}
</select>
</div>
<div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:4}}>
{[["kcal","Cal"],["proteina_g","Prot"],["grasas_g","Grasa"],["carbs_g","Carbs"],["azucar_g","AzÃºcar"],["fibra_g","Fibra"]].map(([k,l])=>(
<div key={k}><div style={{fontSize:"0.5rem",color:C.t3}}>{l}</div>
<input style={{...z.inp,fontSize:"0.68rem",padding:"4px 6px",width:"100%"}} type="number" step="0.1" value={form[k]} onChange={e=>setForm({...form,[k]:e.target.value})} placeholder="0"/></div>
))}
</div>
<div style={{display:"flex",gap:4,marginTop:6}}>
<button style={{...z.btn(true),flex:1,padding:"5px",fontSize:"0.65rem"}} onClick={saveEdit}>{editIdx!==null&&editIdx>=0?"Guardar":"Agregar"}</button>
{editIdx!==null&&editIdx>=0&&<button style={{...z.btn(false),padding:"5px",fontSize:"0.65rem"}} onClick={()=>{setEditIdx(null);setForm({alimento:"",estado:"Natural",kcal:"",proteina_g:"",grasas_g:"",carbs_g:"",azucar_g:"0",fibra_g:"0"})}}>Cancelar</button>}
</div>
</div>}

{/* Food list */}
<div style={{flex:1,overflowY:"auto"}}>
{filtered.length===0&&<div style={{textAlign:"center",padding:20,color:C.t3,fontSize:"0.7rem"}}>{tab==="personal"?"No tienes alimentos personales aÃºn.\nUsa el formulario de arriba o escribe en Comida:\n\"agregar arroz cocido 100g 130cal 2.5P 0.3G 28C\"":"No se encontraron resultados."}</div>}
{filtered.map((f,i)=>{
  const realIdx=tab==="personal"?personalFoods.indexOf(f):-1;
  return(<div key={i} style={{padding:"6px 0",borderBottom:`1px solid ${C.b1}`,fontSize:"0.68rem"}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
      <div><span style={{fontWeight:600,color:C.t0}}>{f.alimento}</span> <span style={{color:C.t3,fontSize:"0.58rem"}}>({f.estado})</span></div>
      <div style={{display:"flex",gap:3}}>
        {tab==="personal"&&<button style={{background:"none",border:"none",color:C.cyan,cursor:"pointer",fontSize:"0.65rem",padding:"2px 4px"}} onClick={()=>startEdit(realIdx)}>âœï¸</button>}
        {tab==="personal"&&<button style={{background:"none",border:"none",color:C.red,cursor:"pointer",fontSize:"0.65rem",padding:"2px 4px"}} onClick={()=>deleteFood(realIdx)}>ðŸ—‘ï¸</button>}
        {tab==="referencia"&&<button style={{background:"none",border:"none",color:C.green,cursor:"pointer",fontSize:"0.55rem",padding:"2px 4px"}} title="Copiar a mis alimentos" onClick={()=>copyToPersonal(f)}>ðŸ“‹â†’ðŸŸ¢</button>}
      </div>
    </div>
    <div style={{color:C.t2,fontSize:"0.58rem",fontFamily:"monospace"}}>{f.kcal}cal {f.proteina_g}P {f.grasas_g}G {f.carbs_g}C {f.azucar_g}S {f.fibra_g}F /100g</div>
  </div>);
})}
</div>
</div>);
};

/* === AI ASSISTANT (Gemini + Groq) === */
const GEMINI_ENDPOINTS=[
  {model:"gemini-2.0-flash-lite",ver:"v1beta"},
  {model:"gemini-2.0-flash",ver:"v1beta"},
  {model:"gemini-2.0-flash-lite",ver:"v1"},
  {model:"gemini-2.0-flash",ver:"v1"},
];
const geminiURL=(model,ver,key)=>`https://generativelanguage.googleapis.com/${ver}/models/${model}:generateContent?key=${key}`;
const callGemini=async(prompt,apiKey,onStatus)=>{
  const maxRetries=3;const errors=[];
  for(let attempt=0;attempt<maxRetries;attempt++){
    for(const ep of GEMINI_ENDPOINTS){
      try{
        const label=`${ep.model} (${ep.ver})`;
        if(onStatus)onStatus(`${label}${attempt>0?` intento ${attempt+1}/${maxRetries}`:""}...`);
        const res=await fetch(geminiURL(ep.model,ep.ver,apiKey),{method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.3,maxOutputTokens:2048}})});
        if(res.status===429){errors.push(`${label}: 429`);continue}
        if(res.status===404){errors.push(`${label}: 404`);continue}
        if(res.status===400){const e=await res.text();
          if(e.includes("API_KEY_INVALID"))throw new Error("KEY_INVALID");
          errors.push(`${label}: 400`);continue}
        if(res.status===403){throw new Error("NO_PERMS")}
        if(!res.ok){errors.push(`${label}: ${res.status}`);continue}
        const data=await res.json();
        const text=data.candidates?.[0]?.content?.parts?.[0]?.text;
        if(text)return text;
        errors.push(`${label}: vacÃ­o`);
      }catch(e){
        if(e.message==="KEY_INVALID")throw new Error("KEY_INVALID");
        if(e.message==="NO_PERMS")throw new Error("NO_PERMS");
        errors.push(`${ep.model}: ${e.message.slice(0,40)}`)}
    }
    if(attempt<maxRetries-1){
      const wait=20+attempt*20;/* 20s, 40s */
      if(onStatus)onStatus(`â³ Rate limit. Esperando ${wait}s... (intento ${attempt+2}/${maxRetries})`);
      await new Promise(r=>setTimeout(r,wait*1000));
    }
  }
  throw new Error(`QUOTA|${errors.join("; ")}`);
};

const GROQ_MODELS=["llama-3.3-70b-versatile","llama-3.1-8b-instant"];
const callGroq=async(prompt,apiKey,onStatus)=>{
  const errors=[];
  for(const model of GROQ_MODELS){
    try{
      if(onStatus)onStatus(`Groq: ${model}...`);
      const res=await fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",
        headers:{"Content-Type":"application/json","Authorization":`Bearer ${apiKey}`},
        body:JSON.stringify({model,messages:[{role:"user",content:prompt}],temperature:0.3,max_tokens:2048})});
      if(res.status===401)throw new Error("KEY_INVALID");
      if(res.status===429){errors.push(`${model}: 429`);continue}
      if(!res.ok){errors.push(`${model}: ${res.status}`);continue}
      const data=await res.json();
      const text=data.choices?.[0]?.message?.content;
      if(text)return text;
      errors.push(`${model}: vacÃ­o`);
    }catch(e){
      if(e.message==="KEY_INVALID")throw new Error("KEY_INVALID");
      errors.push(`${model}: ${e.message.slice(0,40)}`);
    }
  }
  throw new Error(`QUOTA|${errors.join("; ")}`);
};

const callAI=async(prompt,provider,apiKey,onStatus)=>{
  if(provider==="groq")return callGroq(prompt,apiKey,onStatus);
  return callGemini(prompt,apiKey,onStatus);
};

/* CalorieNinjas API removed â€” now using local food database */

const testGeminiKey=async(key,onProgress)=>{
  const results=[];
  const ep=GEMINI_ENDPOINTS[0];
  const label=`${ep.model} (${ep.ver})`;
  if(onProgress)onProgress(`Probando ${label}...`);
  try{
    const res=await fetch(geminiURL(ep.model,ep.ver,key),{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({contents:[{parts:[{text:"Responde solo: OK"}]}],generationConfig:{maxOutputTokens:10}})});
    if(res.ok){results.push(`âœ… Funciona correctamente`);return{ok:true,results}}
    const t=await res.text();
    if(res.status===429){
      results.push(`â³ 429 â€” Rate limit activo`);
      results.push(`Tu key parece vÃ¡lida pero excediste la cuota.`);
      results.push(`Pasos: 1) Espera 2 min sin tocar nada`);
      results.push(`2) Si sigue, ve a aistudio.google.com`);
      results.push(`3) Genera una API key NUEVA`);
      return{ok:false,rateLimit:true,results};
    }
    if(res.status===400){
      if(t.includes("API_KEY_INVALID")){results.push(`âŒ API Key invÃ¡lida. Genera una nueva en aistudio.google.com/apikey`)}
      else{results.push(`âŒ Error 400: ${t.slice(0,100)}`)}
    }
    else if(res.status===403)results.push(`âŒ Sin permisos (403). Habilita Generative Language API.`);
    else results.push(`âŒ ${label}: ${res.status} - ${t.slice(0,100)}`);
  }catch(e){results.push(`âŒ Error de red: ${e.message.slice(0,80)}`)}
  return{ok:false,results};
};

const testGroqKey=async(key,onProgress)=>{
  const results=[];
  if(onProgress)onProgress("Probando Groq API...");
  try{
    const res=await fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",
      headers:{"Content-Type":"application/json","Authorization":`Bearer ${key}`},
      body:JSON.stringify({model:"llama-3.3-70b-versatile",messages:[{role:"user",content:"Responde solo: OK"}],max_tokens:10})});
    if(res.ok){results.push("âœ… Funciona correctamente");return{ok:true,results}}
    if(res.status===401){results.push("âŒ API Key invÃ¡lida. Revisa tu key en console.groq.com")}
    else if(res.status===429){results.push("â³ Rate limit activo. Espera unos segundos.");return{ok:false,rateLimit:true,results}}
    else{const t=await res.text();results.push(`âŒ Error ${res.status}: ${t.slice(0,100)}`)}
  }catch(e){results.push(`âŒ Error de red: ${e.message.slice(0,80)}`)}
  return{ok:false,results};
};

const testAIKey=async(provider,key,onProgress)=>{
  if(provider==="groq")return testGroqKey(key,onProgress);
  return testGeminiKey(key,onProgress);
};

const AIAssistant=()=>{
const[open,setOpen]=useState(false);
const[mode,setMode]=useState("food");/* food | chat | prompt */
const[input,setInput]=useState("");
const[loading,setLoading]=useState(false);
const[loadStatus,setLoadStatus]=useState("");
const[msgs,setMsgs]=useState([]);
const[parsedFood,setParsedFood]=useState(null);
const[foodDate,setFoodDate]=useState(todayS());
const provider=S.aiProvider||"gemini";
const curKey=provider==="groq"?(S.groqApiKey||""):(S.geminiApiKey||"");
const[keyInput,setKeyInput]=useState(curKey);
const[showKey,setShowKey]=useState(!curKey);
const[lastAction,setLastAction]=useState(null);/* {type:"food"|"chat",input:string} for retry */
const[testResult,setTestResult]=useState(null);/* null | "testing" | {ok,results} */
const chatRef=useRef(null);

const setProvider=(p)=>{sv({...D,settings:{...S,aiProvider:p}});setKeyInput(p==="groq"?(S.groqApiKey||""):(S.geminiApiKey||""));setTestResult(null)};
const saveKey=(k)=>{const key=provider==="groq"?"groqApiKey":"geminiApiKey";sv({...D,settings:{...S,[key]:k}});setShowKey(false)};
const apiKey=curKey;

const buildContext=()=>{
  const last7=fl.slice(-7);
  const gp=activeGP;
  const customPrompt=S.aiPrompt?`\n\nINSTRUCCIONES PERSONALIZADAS DEL USUARIO:\n${S.aiPrompt}`:"";
  const habitsCtx=habits.filter(h=>h.active).map(h=>`${h.emoji} ${h.name} (${h.meta})`).join(", ");

  /* Projects with tasks detail */
  const projCtx=projects.map(p=>{
    const tasksDone=p.tasks?p.tasks.filter(t=>t.s==="done").length:0;
    const tasksTotal=p.tasks?p.tasks.length:0;
    const pendingTasks=p.tasks?p.tasks.filter(t=>t.s!=="done").map(t=>`  - ${t.t} (${t.s==="progress"?"en progreso":"pendiente"})`).join("\n"):"";
    return`  * ${p.name}: ${p.progress}% | ${p.status} | Prioridad: ${p.priority} | CategorÃ­a: ${p.category}${p.deadline?" | Deadline: "+p.deadline:""}\n    Tareas: ${tasksDone}/${tasksTotal} completadas${pendingTasks?"\n"+pendingTasks:""}${p.notes?"\n    Notas: "+p.notes:""}`;
  }).join("\n");

  /* Books detail */
  const booksCtx=books.map(b=>{
    const status=b.status==="reading"?"Leyendo":b.status==="done"?"Terminado":"En cola";
    return`  * "${b.title}" (${b.author}) â€” ${status}${b.progress>0?", "+b.progress+"%":""}${b.rating?" â˜…"+b.rating:""}${b.genre?" ["+b.genre+"]":""}`;
  }).join("\n");

  /* Habits with weekly tracking */
  const habitsDetail=habits.filter(h=>h.active).map(h=>{
    const wk=getWk();
    const done=wk.filter(d=>(D.habitWeekly||{})[`${h.id}_${d}`]).length;
    return`  * ${h.emoji} ${h.name}: ${h.meta} â€” ${done}/7 esta semana`;
  }).join("\n");

  /* Journal recent entries */
  const journalCtx=Object.entries(D.journal||{}).sort((a,b)=>b[0].localeCompare(a[0])).slice(0,3).map(([date,entry])=>`  * ${date}: ${(entry.text||entry).substring(0,100)}...`).join("\n");

  /* Schedule summary */
  const schedCtx=(D.horario||[]).filter(h=>h.slots&&h.slots.some(s=>s)).map(h=>`  ${h.hour}: ${h.slots.filter(s=>s).join(", ")}`).join("\n");

  /* Today's tasks */
  const todayCtx=(D.todayTasks||[]).map(t=>`  * [${t.done?"âœ“":"â—‹"}] ${t.task} (${t.cat})`).join("\n");

  /* Compliance stats */
  const compDays=last7.filter(e=>chkComp(e).day).length;

  return`=== DATOS COMPLETOS DEL LIFE DASHBOARD ===

ðŸ“Š FITNESS Y NUTRICIÃ“N:
- Plan: ${S.planName} | Meta: ${S.planGoal}
- Peso: ${curW}kg (inicio: ${S.startWeight}kg â†’ meta: ${S.goalWeight}kg) | Perdido: ${wLost}kg
- Cintura: ${curWaist}cm (inicio: ${S.startWaist}cm)
- Semana: ${completedWeek}/${S.cutWeeks} | DÃ­a ${Math.min(dayN,totalDays)}/${totalDays} | Progreso: ${prog}%
- Perfil nutricional: ${gp.name} â†’ Cal:${gp.cal} | Prot:${gp.prot}g | Grasa:${gp.fat}g | Carbos:${gp.carbs}g | AzÃºcar:â‰¤${gp.sugar}g | Fibra:${gp.fiber||25}g | Entrenos:${gp.trainingPerWeek}x/sem
- Ãšltimos 7 registros:
${last7.map(e=>`  ${e.date}: ${e.cal}cal, ${e.prot}P, ${e.fat}G, ${e.carbs}C, ${e.sugar}S, ${e.fiber||0}F, ${e.weight}kg, ${e.steps||0} pasos`).join("\n")}
- Promedio Ãºltimos 7: Cal:${avg(last7.filter(e=>+e.cal>0),"cal")} | Prot:${avg(last7.filter(e=>+e.prot>0),"prot")}g | Grasa:${avg(last7.filter(e=>+e.fat>0),"fat")}g | Carbos:${avg(last7.filter(e=>+e.carbs>0),"carbs")}g | Fibra:${avg(last7.filter(e=>+e.fiber>0),"fiber")}g
- Compliance Ãºltimos 7 dÃ­as: ${compDays}/7 dÃ­as cumplidos

ðŸ“‚ PROYECTOS:
${projCtx||"  Sin proyectos"}

ðŸ“š LECTURA:
${booksCtx||"  Sin libros"}

ðŸŽ¯ HÃBITOS (esta semana):
${habitsDetail||"  Sin hÃ¡bitos activos"}

ðŸ“… TAREAS DE HOY:
${todayCtx||"  Sin tareas"}

${journalCtx?`ðŸ“ JOURNAL RECIENTE:\n${journalCtx}\n`:""}${schedCtx?`ðŸ• HORARIO SEMANAL:\n${schedCtx}\n`:""}${customPrompt}`;
};

/* ========== NEW FOOD ANALYSIS SYSTEM: Local DB + AI identification (no hallucinations) ========== */

/* Try to parse "agregar" command: agregar [food] [amount]g [cal]cal [prot]P [fat]G [carbs]C */
const parseAddFoodCmd=(text)=>{
  const m=text.match(/^agregar\s+(.+?)\s+(\d+)\s*g\s+(\d+(?:\.\d+)?)\s*(?:cal|kcal)\s+(\d+(?:\.\d+)?)\s*P\s+(\d+(?:\.\d+)?)\s*G\s+(\d+(?:\.\d+)?)\s*C(?:\s+(\d+(?:\.\d+)?)\s*S)?(?:\s+(\d+(?:\.\d+)?)\s*F)?/i);
  if(!m)return null;
  return{alimento:m[1].trim(),estado:"Natural",kcal:+m[3],proteina_g:+m[4],grasas_g:+m[5],grasas_saturadas_g:0,carbs_g:+m[6],azucar_g:+(m[7]||0),fibra_g:+(m[8]||0),sodio_mg:0,colesterol_mg:0};
};

const analyzeFood=async(retryInput)=>{
  const foodText=retryInput||input.trim();
  if(!foodText)return;
  setLoading(true);setParsedFood(null);setLoadStatus("");
  setLastAction({type:"food",input:foodText});
  if(!retryInput)setMsgs(prev=>[...prev,{role:"user",text:foodText}]);
  const r1=v=>Math.round((+v||0)*10)/10;

  try{
    /* ===== COMMAND: agregar alimento ===== */
    const addCmd=parseAddFoodCmd(foodText);
    if(addCmd){
      const newFoods=[...personalFoods,addCmd];
      sv({...D,personalFoods:newFoods});
      setMsgs(prev=>[...prev,{role:"ai",text:`âœ… Alimento agregado a tu base de datos personal:\n\nðŸ“¦ ${addCmd.alimento} (${addCmd.estado})\nPor 100g: ${addCmd.kcal}cal | ${addCmd.proteina_g}g P | ${addCmd.grasas_g}g G | ${addCmd.carbs_g}g C | ${addCmd.azucar_g}g S | ${addCmd.fibra_g}g F`}]);
      setLoading(false);setInput("");setLoadStatus("");return;
    }

    /* ===== COMMAND: eliminar alimento ===== */
    if(foodText.match(/^eliminar\s+/i)){
      const name=foodText.replace(/^eliminar\s+/i,"").trim();
      const idx=personalFoods.findIndex(f=>normFood(f.alimento).includes(normFood(name)));
      if(idx>=0){
        const removed=personalFoods[idx];
        const newFoods=[...personalFoods];newFoods.splice(idx,1);
        sv({...D,personalFoods:newFoods});
        setMsgs(prev=>[...prev,{role:"ai",text:`ðŸ—‘ï¸ Eliminado "${removed.alimento}" de tu base de datos personal.`}]);
      }else{
        setMsgs(prev=>[...prev,{role:"ai",text:`âš ï¸ No encontrÃ© "${name}" en tu base de datos personal.`}]);
      }
      setLoading(false);setInput("");setLoadStatus("");return;
    }

    /* ===== COMMAND: mis alimentos / ver db ===== */
    if(foodText.match(/^(mis alimentos|ver db|mi db|lista alimentos)/i)){
      const total=personalFoods.length;
      const ref=FOOD_DB.length;
      let txt=`ðŸ“¦ Tu base de datos de alimentos:\n\n`;
      txt+=`ðŸ”µ Referencia built-in: ${ref} alimentos\n`;
      txt+=`ðŸŸ¢ Tus alimentos personales: ${total}\n\n`;
      if(total>0){
        txt+=`--- Personales ---\n`;
        personalFoods.forEach(f=>{txt+=`â€¢ ${f.alimento} (${f.estado}): ${f.kcal}cal ${f.proteina_g}P ${f.grasas_g}G ${f.carbs_g}C ${f.azucar_g}S ${f.fibra_g}F\n`});
      }
      txt+=`\nðŸ’¡ Para agregar: "agregar [nombre] [100]g [cal]cal [P]P [G]G [C]C [S]S [F]F"`;
      txt+=`\nðŸ’¡ Para eliminar: "eliminar [nombre]"`;
      setMsgs(prev=>[...prev,{role:"ai",text:txt}]);
      setLoading(false);setInput("");setLoadStatus("");return;
    }

    /* ===== MAIN FLOW: AI identifies food + grams â†’ DB lookup â†’ calculate ===== */
    if(!apiKey){
      setMsgs(prev=>[...prev,{role:"ai",text:`ðŸ”‘ Configura tu API Key de ${provider==="groq"?"Groq":"Gemini"} para analizar comidas.`}]);
      setLoading(false);setInput("");setLoadStatus("");return;
    }

    /* Build available foods list for AI */
    const allFoodsForAI=[...personalFoods.map(f=>`${f.alimento} (${f.estado})`),...FOOD_DB.map(f=>`${f.alimento} (${f.estado})`)];
    const uniqueFoods=[...new Set(allFoodsForAI)];

    setLoadStatus("ðŸ¤– Identificando alimentos...");
    const parsePrompt=`Eres un parser de comida. Tu ÃšNICA tarea es identificar quÃ© alimentos hay y cuÃ¡ntos gramos de cada uno.
NO inventes macros ni calorÃ­as â€” solo parsea y mapea contra la lista.

ALIMENTOS DISPONIBLES EN LA DB:
${uniqueFoods.join(", ")}

REGLAS DE MATCH:
1. Match EXACTO o sinÃ³nimo OBVIO del mismo alimento â†’ found:true, "name" = nombre EXACTO de la lista
   Ej: "pollo" â†’ "Pechuga pollo" OK | "whey" â†’ "Proteina Whey" OK
2. PROHIBIDO match si cambia el alimento real:
   - Diferente marca/sabor (yogurt alquerÃ­a â‰  yogurt griego casero) â†’ found:false
   - Diferente parte (clara de huevo â‰  huevo entero â‰  yema huevo) â†’ found:false
   - Diferente tipo (integral vs blanco, light vs regular) â†’ found:false
3. Si un alimento NO estÃ¡ en la lista â†’ found:false obligatorio. NO fuerces un match
4. Productos comerciales que no estÃ¡n en la lista â†’ found:false

GRAMOS Y PORCIONES:
- Si el usuario da gramos/ml â†’ Ãºsalos tal cual
- Si da unidades, convierte a gramos:
  1 huevo entero=50g | 1 clara=33g | 1 yema=17g | 1 huevo frito=50g | 1 huevo revuelto=50g
  1 arepa=100g | 1 tajada pan=30g | 1 porciÃ³n carne/pollo/pescado=150g
  1 porciÃ³n arroz/pasta=200g | 1 cucharada aceite/mantequilla=14g | 1 cucharada miel=21g
  1 fruta mediana=180g | 1 banano=120g | 1 vaso leche=240g | 1 scoop whey=30g

ESTADO:
Usa el estado que aparece en la DB para ese alimento.
Si no se especifica: carnes/granos=Cocido, frutas=Natural, suplementos=Polvo

IMPORTANTE: "clara" = "Clara de huevo" (solo la clara, SIN yema). "huevo" o "huevo entero" = "Huevo entero" (entero con yema). SON ALIMENTOS DIFERENTES con macros MUY distintos. NUNCA confundirlos.

EJEMPLOS:
"200g arroz con 150g pechuga" â†’
{"items":[{"name":"Arroz blanco","grams":200,"estado":"Cocido","found":true},{"name":"Pechuga pollo","grams":150,"estado":"Cocida","found":true}]}

"5 huevos (2 enteros y 3 claras)" â†’
{"items":[{"name":"Huevo entero","grams":100,"estado":"Natural","found":true},{"name":"Clara de huevo","grams":99,"estado":"Natural","found":true}]}

"3 claras y 1 huevo con arepa" â†’
{"items":[{"name":"Clara de huevo","grams":99,"estado":"Natural","found":true},{"name":"Huevo entero","grams":50,"estado":"Natural","found":true},{"name":"Arepa blanca","grams":100,"estado":"Natural","found":true}]}

"yogurt alquerÃ­a con granola fitness" â†’
{"items":[{"name":"yogurt alquerÃ­a","grams":200,"estado":"Natural","found":false},{"name":"granola fitness","grams":60,"estado":"Natural","found":false}]}

"almorcÃ© bien" â†’
{"items":[],"note":"No pude identificar alimentos especÃ­ficos"}

Comida: "${foodText}"

Responde SOLO JSON puro (sin markdown, sin backticks, sin texto extra):
{"items":[{"name":"nombre exacto de la lista","grams":number,"estado":"string","found":boolean}]}`;

    const resp=await callAI(parsePrompt,provider,apiKey,s=>setLoadStatus(s));
    const jsonMatch=resp.match(/\{[\s\S]*\}/);
    if(!jsonMatch){
      setMsgs(prev=>[...prev,{role:"ai",text:`âš ï¸ Error al interpretar. Intenta con algo mÃ¡s claro, ej: "200g arroz con 150g pollo"`}]);
      setLoading(false);setInput("");setLoadStatus("");return;
    }

    const parsed=JSON.parse(jsonMatch[0]);
    let items=parsed.items||[];
    if(!Array.isArray(items))items=[];

    /* Post-process: fix known AI confusion between egg variants.
       Llama3/Groq often maps "claras" â†’ "Huevo entero" incorrectly.
       Use gram-distance heuristic: 1 clara=33g, 1 entero=50g, 1 yema=17g */
    const _ft=normFood(foodText);
    if(/\bclara[s]?\b/.test(_ft)&&!items.some(it=>normFood(it.name).includes("clara"))){
      items=items.map(it=>{
        if(!normFood(it.name).includes("huevo"))return it;
        const g=+(it.grams)||100;
        const dC=Math.abs(g-Math.round(g/33)*33);
        const dE=Math.abs(g-Math.round(g/50)*50);
        if(dC<dE)return{...it,name:"Clara de huevo",estado:"Natural"};
        return it;
      });
    }
    if(/\byema[s]?\b/.test(_ft)&&!items.some(it=>normFood(it.name).includes("yema"))){
      items=items.map(it=>{
        if(!normFood(it.name).includes("huevo"))return it;
        const g=+(it.grams)||100;
        const dY=Math.abs(g-Math.round(g/17)*17);
        const dE=Math.abs(g-Math.round(g/50)*50);
        if(dY<dE)return{...it,name:"Yema huevo",estado:"Natural"};
        return it;
      });
    }

    setLoadStatus("ðŸ“Š Buscando en base de datos...");

    const food={cal:0,prot:0,fat:0,carbs:0,sugar:0,fiber:0,detail:""};
    const lines=[];
    const notFound=[];

    items.forEach(it=>{
      const grams=+(it.grams)||100;

      /* If AI explicitly says found:false, skip DB search â€” go straight to notFound */
      if(it.found===false){
        notFound.push(it.name+(it.grams?` ${it.grams}g`:""));
        return;
      }

      const result=searchFoodMatch(it.name, personalFoods);

      if(result){
        const entry=result.match;
        const factor=grams/100;
        const c=r1(entry.kcal*factor);
        const p=r1(entry.proteina_g*factor);
        const f=r1(entry.grasas_g*factor);
        const cb=r1(entry.carbs_g*factor);
        const s=r1(entry.azucar_g*factor);
        const fb=r1(entry.fibra_g*factor);
        food.cal+=c;food.prot+=p;food.fat+=f;food.carbs+=cb;food.sugar+=s;food.fiber+=fb;
        const srcTag=result.source==="personal"?"ðŸŸ¢":"ðŸ”µ";
        lines.push(`${srcTag} ${entry.alimento} (${entry.estado}) ${grams}g: ${c}cal, ${p}g P, ${f}g G, ${cb}g C, ${s}g S, ${fb}g F`);
      }else{
        notFound.push(it.name+(it.grams?` ${it.grams}g`:""));
      }
    });

    food.cal=r1(food.cal);food.prot=r1(food.prot);food.fat=r1(food.fat);food.carbs=r1(food.carbs);food.sugar=r1(food.sugar);food.fiber=r1(food.fiber);
    food.detail=lines.join("\n");

    if(lines.length>0){
      let msg=`ðŸ½ï¸ Desglose (datos exactos de tu DB):\n${lines.join("\n")}\n\nâœ… Totales: ${food.cal} kcal | ${food.prot}g P | ${food.fat}g G | ${food.carbs}g C | ${food.sugar}g S | ${food.fiber}g F`;
      msg+=`\n\nðŸ”µ = tabla referencia | ðŸŸ¢ = tu DB personal`;
      if(notFound.length>0){
        msg+=`\n\nâš ï¸ No encontrÃ© en la DB: ${notFound.join(", ")}\nðŸ’¡ Para agregar: "agregar [nombre] 100g [cal]cal [P]P [G]G [C]C"`;
      }
      setParsedFood(food);
      setMsgs(prev=>[...prev,{role:"ai",text:msg}]);
    }else if(notFound.length>0){
      setParsedFood(null);
      setMsgs(prev=>[...prev,{role:"ai",text:`âš ï¸ No encontrÃ© estos alimentos en la base de datos:\n${notFound.map(n=>`â€¢ ${n}`).join("\n")}\n\nðŸ’¡ Puedes agregarlos con:\n"agregar [nombre] 100g [cal]cal [P]P [G]G [C]C [S]S [F]F"\n\nO usa el tab ðŸ“¦ Alimentos para gestionar tu DB.`}]);
    }else{
      setParsedFood(null);
      setMsgs(prev=>[...prev,{role:"ai",text:`âš ï¸ No pude identificar alimentos en "${foodText}". Intenta con algo como: "200g arroz con 150g pollo"`}]);
    }
  }catch(e){
    if(e.message&&e.message.startsWith("QUOTA|")){
      const isGroq=provider==="groq";
      setMsgs(prev=>[...prev,{role:"ai",text:isGroq?`â³ Rate limit de Groq\n\nEspera unos segundos y presiona ðŸ”„`:`â³ Rate limit de Google (429)\n\nEspera 2-3 min y presiona ðŸ”„\nO cambia a Groq`,retry:true}]);
    }else if(e.message==="KEY_INVALID"){
      const isGroq=provider==="groq";
      setMsgs(prev=>[...prev,{role:"ai",text:isGroq?`âŒ API Key de Groq invÃ¡lida\n\nRevisa en console.groq.com`:`âŒ API Key invÃ¡lida\n\nGenera una nueva en aistudio.google.com/apikey`}]);
    }else if(e.message==="NO_PERMS"){
      setMsgs(prev=>[...prev,{role:"ai",text:`âŒ Sin permisos (403)\n\nHabilita "Generative Language API" en Google Cloud.\nO cambia a Groq.`}]);
    }else setMsgs(prev=>[...prev,{role:"ai",text:"âŒ "+e.message}]);
  }
  setLoading(false);setInput("");setLoadStatus("");
};

const addFoodToLog=()=>{
  if(!parsedFood)return;
  const targetDate=foodDate||todayS();
  const targetDateObj=new Date(targetDate+"T00:00:00");
  const startDateObj=new Date(S.startDate+"T00:00:00");
  const weekNum=Math.min(Math.ceil((Math.floor((targetDateObj-startDateObj)/86400000)+1)/7),S.cutWeeks);
  const entry={date:targetDate,week:`S${weekNum}`,dayType:"dt2",weight:"",waist:"",cal:parsedFood.cal,prot:parsedFood.prot,fat:parsedFood.fat,carbs:parsedFood.carbs,sugar:parsedFood.sugar,fiber:parsedFood.fiber,steps:"",sleep:"",notes:"DB: "+(parsedFood.detail||"comida")};
  const existing=fl.findIndex(e=>e.date===targetDate);
  const log=[...fl];
  const isToday=targetDate===todayS();
  const dateLabel=isToday?"hoy":targetDate;
  if(existing>=0){
    log[existing]={...log[existing],cal:(+log[existing].cal||0)+parsedFood.cal,prot:(+log[existing].prot||0)+parsedFood.prot,fat:(+log[existing].fat||0)+parsedFood.fat,carbs:(+log[existing].carbs||0)+parsedFood.carbs,sugar:(+log[existing].sugar||0)+parsedFood.sugar,fiber:(+log[existing].fiber||0)+parsedFood.fiber,notes:log[existing].notes?(log[existing].notes+"; AI: "+parsedFood.detail):("AI: "+parsedFood.detail)};
  } else { log.push(entry);log.sort((a,b)=>a.date.localeCompare(b.date)); }
  sv({...D,fitnessLog:log});
  setMsgs(prev=>[...prev,{role:"ai",text:`âœ… Registrado en fitness log (${dateLabel})`+(existing>=0?" â€” sumado al registro existente":"")}]);
  setParsedFood(null);
};

const askChat=async(retryInput)=>{
  const userMsg=retryInput||input.trim();
  if(!userMsg||!apiKey)return;
  setLoading(true);setLoadStatus("");
  setLastAction({type:"chat",input:userMsg});
  if(!retryInput){setInput("");setMsgs(prev=>[...prev,{role:"user",text:userMsg}])}
  try{
    const history=msgs.slice(-8).map(m=>`${m.role==="user"?"USUARIO":"ASISTENTE"}: ${m.text}`).join("\n");
    const prompt=`Eres el asistente inteligente del Life Dashboard, un sistema integral de productividad y fitness. Tu nombre es "Coach". Eres experto en:
- NutriciÃ³n deportiva y planes de alimentaciÃ³n
- Entrenamiento de fuerza y acondicionamiento
- GestiÃ³n de proyectos y productividad
- HÃ¡bitos y desarrollo personal
- Lectura y aprendizaje

PERSONALIDAD:
- Habla en espaÃ±ol, de forma natural y directa como un amigo que sabe mucho
- SÃ© especÃ­fico y usa los DATOS REALES del usuario (no genÃ©ricos)
- Cuando analices datos, menciona nÃºmeros concretos
- Da recomendaciones accionables y prÃ¡cticas
- Usa emojis con moderaciÃ³n para dar estructura visual
- Responde de forma concisa pero completa. No rellenes con texto genÃ©rico
- Si el usuario pregunta sobre algo del dashboard, CONSULTA los datos y responde con informaciÃ³n real

CAPACIDADES - Puedes responder sobre CUALQUIER secciÃ³n del dashboard:
1. FITNESS: progreso de peso/cintura, anÃ¡lisis de macros, compliance, tendencias, recomendaciones nutricionales
2. PROYECTOS: estado actual, tareas pendientes, prioridades, deadlines, recomendaciones de gestiÃ³n
3. HÃBITOS: seguimiento semanal, consistencia, sugerencias para mejorar adherencia
4. LECTURA: libros en progreso, recomendaciones, conexiones entre lecturas y objetivos
5. HORARIO: optimizaciÃ³n de rutina, distribuciÃ³n del tiempo
6. TAREAS: priorizaciÃ³n del dÃ­a, gestiÃ³n de pendientes
7. GENERAL: cualquier pregunta de fitness, nutriciÃ³n, productividad o desarrollo personal

${buildContext()}

${history?`CONVERSACIÃ“N PREVIA:\n${history}\n`:""}
USUARIO: ${userMsg}

Responde basÃ¡ndote en los datos REALES del usuario. Si pregunta sobre su progreso, usa los nÃºmeros. Si pide consejos, personalÃ­zalos a su situaciÃ³n. Si pregunta sobre proyectos/hÃ¡bitos/libros, consulta los datos del contexto.`;
    const resp=await callAI(prompt,provider,apiKey,s=>setLoadStatus(s));
    setMsgs(prev=>[...prev,{role:"ai",text:resp}]);
  }catch(e){
    if(e.message.startsWith("QUOTA|")){
      const isGroq=provider==="groq";
      setMsgs(prev=>[...prev,{role:"ai",text:isGroq?`â³ Rate limit de Groq. Espera unos segundos y presiona ðŸ”„`:`â³ Rate limit de Google (429)\n\nEspera 2-3 min y presiona ðŸ”„\nO cambia a Groq (sin restricciones regionales)`,retry:true}]);
    }else if(e.message==="KEY_INVALID"){
      const isGroq=provider==="groq";
      setMsgs(prev=>[...prev,{role:"ai",text:isGroq?`âŒ API Key de Groq invÃ¡lida. Revisa en console.groq.com`:`âŒ API Key invÃ¡lida. Genera una nueva en aistudio.google.com/apikey`}]);
    }else if(e.message==="NO_PERMS"){
      setMsgs(prev=>[...prev,{role:"ai",text:`âŒ Sin permisos. Habilita "Generative Language API" en Google Cloud.\nO cambia a Groq.`}]);
    }else setMsgs(prev=>[...prev,{role:"ai",text:"âŒ "+e.message}]);
  }
  setLoading(false);setLoadStatus("");
};

const retry=()=>{if(!lastAction)return;if(lastAction.type==="food")analyzeFood(lastAction.input);else askChat(lastAction.input)};

useEffect(()=>{if(chatRef.current)chatRef.current.scrollTop=chatRef.current.scrollHeight},[msgs]);

if(!open)return(<button onClick={()=>setOpen(true)} style={{position:"fixed",bottom:85,right:20,width:52,height:52,borderRadius:"50%",background:`linear-gradient(135deg,${C.purple},${C.blue})`,border:"none",color:"#fff",fontSize:"1.3rem",cursor:"pointer",boxShadow:"0 4px 20px rgba(91,157,245,0.4)",zIndex:50,display:"flex",alignItems:"center",justifyContent:"center",animation:"pulse 3s infinite"}}>ðŸ¤–</button>);

return(<div style={{position:"fixed",bottom:20,right:20,width:380,maxWidth:"calc(100vw - 24px)",height:520,maxHeight:"calc(100vh - 40px)",background:C.bg1,border:`1px solid ${C.b1}`,borderRadius:16,boxShadow:"0 8px 40px rgba(0,0,0,0.6)",zIndex:100,display:"flex",flexDirection:"column",overflow:"hidden"}}>
{/* Header */}
<div style={{padding:"12px 16px",borderBottom:`1px solid ${C.b1}`,display:"flex",alignItems:"center",gap:8,background:`linear-gradient(135deg,${C.bg2},${C.bg3})`}}>
<span style={{fontSize:"1.2rem"}}>ðŸ¤–</span>
<div style={{flex:1}}>
<div style={{fontSize:"0.82rem",fontWeight:700}}>AI Coach</div>
<div style={{fontSize:"0.55rem",color:C.t3}}>{provider==="groq"?"Groq / Llama 3 (gratis)":"Gemini (15 req/min)"} Â· {mode==="food"?"ðŸ½ï¸ Comida (DB local)":mode==="foods"?"ðŸ“¦ GestiÃ³n alimentos":"ðŸ’¬ Consulta libre"}</div>
</div>
<button onClick={()=>setShowKey(!showKey)} style={{background:"none",border:"none",color:C.t3,cursor:"pointer",fontSize:"0.7rem"}}>ðŸ”‘</button>
<button onClick={()=>setOpen(false)} style={{background:"none",border:"none",color:C.t3,cursor:"pointer",fontSize:"1rem"}}>âœ•</button>
</div>

{/* API Key config */}
{showKey&&<div style={{padding:"10px 14px",background:C.bg2,borderBottom:`1px solid ${C.b1}`}}>
<div style={{display:"flex",gap:4,marginBottom:8}}>
{[["gemini","Gemini"],["groq","Groq (Recomendado)"]].map(([p,l])=>(
<button key={p} onClick={()=>setProvider(p)} style={{flex:1,padding:"5px 8px",borderRadius:8,border:`1px solid ${provider===p?C.purple:C.b1}`,background:provider===p?C.purple+"25":"transparent",color:provider===p?C.t0:C.t3,fontSize:"0.62rem",fontWeight:600,cursor:"pointer",fontFamily:"inherit"}}>{l}</button>
))}
</div>
{provider==="groq"?<div style={{fontSize:"0.65rem",color:C.t2,marginBottom:6}}>API Key de Groq (<a href="https://console.groq.com/keys" target="_blank" style={{color:C.cyan}}>obtener gratis aquÃ­</a>) â€” Sin restricciones regionales</div>
:<div style={{fontSize:"0.65rem",color:C.t2,marginBottom:6}}>API Key de Google Gemini (<a href="https://aistudio.google.com/apikey" target="_blank" style={{color:C.cyan}}>obtener gratis aquÃ­</a>)</div>}
<div style={{display:"flex",gap:6}}>
<input style={{...z.inpM,fontSize:"0.7rem",flex:1}} type="password" value={keyInput} onChange={e=>setKeyInput(e.target.value)} placeholder={provider==="groq"?"gsk_...":"AIzaSy..."}/>
<button style={z.btnS(true)} onClick={()=>saveKey(keyInput)}>âœ“</button>
<button style={{...z.btnS(false),fontSize:"0.6rem",whiteSpace:"nowrap"}} onClick={async()=>{setTestResult("testing");const r=await testAIKey(provider,keyInput||apiKey,s=>setTestResult(s));setTestResult(r)}}>ðŸ§ª Test</button>
</div>
{testResult==="testing"||typeof testResult==="string"&&testResult!=="testing"?<div style={{fontSize:"0.6rem",color:C.cyan,marginTop:6}}>{typeof testResult==="string"?testResult:"Probando..."}</div>:null}
{testResult&&typeof testResult==="object"&&<div style={{fontSize:"0.6rem",marginTop:6,padding:8,background:C.bg3,borderRadius:6}}>
{testResult.results.map((r,i)=><div key={i} style={{color:r.startsWith("âœ…")?C.green:r.startsWith("â³")||r.startsWith("ðŸ’¡")?C.orange:r.startsWith("Espera")?C.t2:C.red,marginBottom:3}}>{r}</div>)}
</div>}
</div>}

{/* Mode tabs */}
<div style={{display:"flex",borderBottom:`1px solid ${C.b1}`}}>
{[["food","ðŸ½ï¸ Comida"],["foods","ðŸ“¦ Alimentos"],["chat","ðŸ’¬ Consultar"],["prompt","ðŸ“ Mi Contexto"]].map(([m,l])=>(
<button key={m} onClick={()=>{setMode(m);setParsedFood(null)}} style={{flex:1,padding:"8px",background:mode===m?C.bg3:"transparent",border:"none",borderBottom:mode===m?`2px solid ${C.purple}`:"2px solid transparent",color:mode===m?C.t0:C.t3,fontSize:"0.62rem",fontWeight:600,cursor:"pointer",fontFamily:"inherit"}}>{l}</button>
))}
</div>

{/* Food DB manager */}
{mode==="foods"?<FoodDBManager personalFoods={personalFoods} onSave={(foods)=>sv({...D,personalFoods:foods})}/>:null}
{/* Prompt editor */}
{mode==="prompt"?<div style={{flex:1,overflowY:"auto",padding:"12px 14px",display:"flex",flexDirection:"column",gap:10}}>
<div style={{fontSize:"0.75rem",color:C.t1,fontWeight:600}}>ðŸ“ Tu contexto personalizado</div>
<div style={{fontSize:"0.68rem",color:C.t2,lineHeight:1.5}}>Escribe aquÃ­ todo lo que quieras que el AI Coach sepa sobre ti, o carga un archivo (.txt, .csv, .pdf). Esto se incluirÃ¡ en cada consulta automÃ¡ticamente.</div>
<textarea style={{...z.inp,flex:1,minHeight:180,fontSize:"0.76rem",lineHeight:1.6,fontFamily:"'IBM Plex Mono',monospace",resize:"none"}} value={S.aiPrompt||""} onChange={e=>sv({...D,settings:{...S,aiPrompt:e.target.value}})}
placeholder={"Ejemplo:\n- Tengo 24 aÃ±os, hombre, 1.75m\n- Mi objetivo es bajar de 20% a 15% de grasa corporal en 6 semanas\n- Entreno pesas 5x/semana (PPL) y juego tenis/pÃ¡del 2x\n- No me gusta el brÃ³coli ni las espinacas\n- Prefiero comer mÃ¡s carbos antes de entrenar\n- Tengo molestia en el hombro derecho\n- Quiero mantener la masa muscular mientras bajo grasa\n- Mi presupuesto de comida es moderado\n- Vivo en Colombia"}/>
<div style={{display:"flex",gap:6,alignItems:"center"}}>
<button style={{...z.btn(false),fontSize:"0.68rem",padding:"6px 12px"}} onClick={()=>{const inp=document.createElement("input");inp.type="file";inp.accept=".txt,.csv,.pdf";inp.onchange=async(ev)=>{
const file=ev.target.files[0];if(!file)return;
const name=file.name.toLowerCase();
try{
let text="";
if(name.endsWith(".pdf")){
const buf=await file.arrayBuffer();const bytes=new Uint8Array(buf);
let raw="";for(let i=0;i<bytes.length;i++)raw+=String.fromCharCode(bytes[i]);
const texts=[];const streamRe=/stream\s*\n?([\s\S]*?)endstream/g;let m;
while((m=streamRe.exec(raw))!==null){const s=m[1].replace(/\r/g,"");
const lines=s.split("\n").filter(l=>/^\(.*\)\s*Tj/.test(l)||/\[(.*)\]\s*TJ/.test(l));
for(const l of lines){const parens=[...l.matchAll(/\(([^)]*)\)/g)].map(x=>x[1]);if(parens.length)texts.push(parens.join(""))}}
text=texts.join("\n").trim();
if(!text){const fallback=raw.replace(/[^\x20-\x7E\n\rÃ€-Ã¿]/g," ").replace(/ {3,}/g,"\n").replace(/\n{3,}/g,"\n\n").trim();
const useful=fallback.split("\n").filter(l=>l.trim().length>3&&!/^(%|obj|endobj|stream|endstream|xref|trailer|startxref)/.test(l.trim()));
text=useful.join("\n").slice(0,5000)}
if(!text)text="(No se pudo extraer texto del PDF. Intenta copiar y pegar manualmente.)"
}else{text=await file.text()}
const current=S.aiPrompt||"";
const separator=current?"\n\n--- Archivo: "+file.name+" ---\n":"";
sv({...D,settings:{...S,aiPrompt:current+separator+text.slice(0,8000)}});
}catch(e){alert("Error al leer archivo: "+e.message)}
};inp.click()}}>ðŸ“Ž Cargar archivo</button>
<span style={{fontSize:"0.55rem",color:C.t3}}>.txt, .csv, .pdf</span>
{(S.aiPrompt||"").length>0&&<button style={{...z.btn(false),fontSize:"0.68rem",padding:"6px 12px",marginLeft:"auto"}} onClick={()=>{if(confirm("Â¿Borrar todo el contexto personalizado?"))sv({...D,settings:{...S,aiPrompt:""}})}}>ðŸ—‘ Limpiar</button>}
</div>
<div style={{padding:"10px",background:C.bg3,borderRadius:8,border:`1px solid ${C.b1}`}}>
<div style={{fontSize:"0.6rem",fontWeight:600,color:C.cyan,marginBottom:4}}>ðŸ“Š Contexto automÃ¡tico (siempre incluido):</div>
<pre style={{fontSize:"0.58rem",color:C.t3,whiteSpace:"pre-wrap",lineHeight:1.5,maxHeight:100,overflowY:"auto"}}>{buildContext().split("\nINSTRUCCIONES")[0]}</pre>
</div>
</div>:null}
{/* Messages */}
{mode!=="prompt"&&mode!=="foods"&&<div ref={chatRef} style={{flex:1,overflowY:"auto",padding:"10px 14px",display:"flex",flexDirection:"column",gap:8}}>
{msgs.length===0&&<div style={{textAlign:"center",padding:"30px 10px",color:C.t3,fontSize:"0.75rem"}}>
{mode==="food"?`ðŸ½ï¸ Escribe lo que comiste y busco los macros exactos en tu base de datos.\n\nEjemplo: "200g pollo con arroz y ensalada"\n\nðŸ“¦ Comandos especiales:\nâ€¢ "agregar [nombre] 100g [cal]cal [P]P [G]G [C]C"\nâ€¢ "eliminar [nombre]"\nâ€¢ "mis alimentos"`:`ðŸ’¬ PregÃºntame lo que quieras: fitness, nutriciÃ³n, proyectos, hÃ¡bitos, libros, horario, productividad...`}
</div>}
{msgs.map((m,i)=>(<div key={i} style={{alignSelf:m.role==="user"?"flex-end":"flex-start",maxWidth:"85%"}}>
<div style={{padding:"8px 12px",borderRadius:m.role==="user"?"12px 12px 4px 12px":"12px 12px 12px 4px",background:m.role==="user"?C.purple+"25":m.retry?C.orange+"15":C.bg3,border:`1px solid ${m.role==="user"?C.purple+"40":m.retry?C.orange+"40":C.b1}`,fontSize:"0.76rem",color:C.t1,whiteSpace:"pre-wrap",lineHeight:1.5}}>
{m.text}
</div>
{m.retry&&!loading&&<button style={{...z.btnS(false),marginTop:4,fontSize:"0.65rem",color:C.cyan}} onClick={retry}>ðŸ”„ Reintentar</button>}
</div>))}
{loading&&<div style={{alignSelf:"flex-start",padding:"8px 12px",borderRadius:12,background:C.bg3,fontSize:"0.76rem",color:C.t3,animation:"pulse 1s infinite"}}>{loadStatus||( mode==="food"?"ðŸ” Analizando comida...":"ðŸ¤” Pensando...")}</div>}
{parsedFood&&<div style={{padding:"10px",background:C.green+"15",border:`1px solid ${C.green}30`,borderRadius:10}}>
<div style={{fontSize:"0.68rem",fontWeight:600,color:C.green,marginBottom:6}}>ðŸ“Š Macros detectados:</div>
<div style={{display:"grid",gridTemplateColumns:"repeat(6,1fr)",gap:4,marginBottom:8}}>
{[["Cal",parsedFood.cal,C.orange],["Prot",parsedFood.prot+"g",C.blue],["Grasa",parsedFood.fat+"g",C.red],["Carbos",parsedFood.carbs+"g",C.green],["AzÃºcar",parsedFood.sugar+"g",C.pink],["Fibra",parsedFood.fiber+"g",C.amber]].map(([l,v,c])=>(
<div key={l} style={{textAlign:"center"}}><div style={{fontSize:"0.5rem",color:c,fontWeight:600}}>{l}</div><div style={{fontFamily:"monospace",fontSize:"0.78rem",fontWeight:700}}>{v}</div></div>
))}
</div>
<div style={{display:"flex",alignItems:"center",gap:6,marginBottom:6}}>
<span style={{fontSize:"0.62rem",color:C.t2,fontWeight:600}}>ðŸ“… Fecha:</span>
<input type="date" style={{...z.inpM,padding:"3px 6px",fontSize:"0.68rem",flex:1,colorScheme:"dark"}} value={foodDate} onChange={e=>setFoodDate(e.target.value)}/>
</div>
<button style={{...z.btn(true),width:"100%",padding:"6px"}} onClick={addFoodToLog}>âœ… Agregar al registro {foodDate===todayS()?"de hoy":`del ${foodDate}`}</button>
</div>}
</div>}

{/* Input */}
{mode!=="prompt"&&mode!=="foods"&&<div style={{padding:"10px 14px",borderTop:`1px solid ${C.b1}`,background:C.bg2}}>
{!apiKey&&mode==="food"?<div style={{fontSize:"0.7rem",color:C.orange,textAlign:"center",padding:6}}>ðŸ”‘ Configura tu API Key de {provider==="groq"?"Groq":"Gemini"} arriba para empezar</div>:
<div style={{display:"flex",gap:6}}>
<input style={{...z.inp,flex:1,fontSize:"0.78rem",padding:"8px 12px"}} value={input} onChange={e=>setInput(e.target.value)}
  placeholder={mode==="food"?"Â¿QuÃ© comiste? Ej: 150g pollo con arroz...":"Pregunta lo que quieras: fitness, proyectos, hÃ¡bitos..."}
  onKeyDown={e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();mode==="food"?analyzeFood():askChat()}}}
  disabled={loading}/>
<button style={{...z.btn(true),padding:"8px 14px"}} onClick={mode==="food"?analyzeFood:askChat} disabled={loading||!input.trim()}>
{loading?"...":mode==="food"?"ðŸ”":"ðŸ“¨"}</button>
</div>}
</div>}
</div>);
};

/* === SETTINGS === */
const SettingsModal=({onClose})=>{const[f,setF]=useState({...S});
return(<Mdl title="âš™ ConfiguraciÃ³n" onClose={onClose} ch={<div style={{display:"flex",flexDirection:"column",gap:10}}>
{[["Plan","planName","t"],["Meta","planGoal","t"],["Peso inicial","startWeight","n"],["Peso meta","goalWeight","n"],["Cintura inicial","startWaist","n"],["Semanas","cutWeeks","n"],["Entrenos/sem","trainingPerWeek","n"]].map(([l,k,t])=>(<div key={k} style={{display:"flex",alignItems:"center",gap:10}}>
<span style={{flex:1,fontSize:"0.8rem",color:C.t2}}>{l}</span>
{t==="n"?<input style={{...z.inpM,maxWidth:100,textAlign:"right"}} type="number" step={k.includes("Weight")||k.includes("Waist")?"0.1":"1"} value={f[k]} onChange={e=>setF({...f,[k]:+e.target.value})}/>:
<input style={{...z.inp,maxWidth:200}} value={f[k]} onChange={e=>setF({...f,[k]:e.target.value})}/>}</div>))}
<div style={{display:"flex",alignItems:"center",gap:10}}><span style={{flex:1,fontSize:"0.8rem",color:C.t2}}>Fecha inicio</span><input style={{...z.inpM,maxWidth:155}} type="date" value={f.startDate} onChange={e=>setF({...f,startDate:e.target.value})}/></div>
<div style={{borderTop:`1px solid ${C.b1}`,marginTop:10,paddingTop:10}}>
<div style={{fontSize:"0.65rem",fontWeight:600,color:C.purple,marginBottom:6}}>ðŸ¤– AI Coach</div>
<div style={{display:"flex",alignItems:"center",gap:10,marginBottom:8}}>
<span style={{flex:1,fontSize:"0.8rem",color:C.t2}}>Proveedor</span>
<div style={{display:"flex",gap:4}}>
{[["gemini","Gemini"],["groq","Groq"]].map(([p,l])=>(
<button key={p} onClick={()=>setF({...f,aiProvider:p})} style={{padding:"4px 12px",borderRadius:6,border:`1px solid ${(f.aiProvider||"gemini")===p?C.purple:C.b1}`,background:(f.aiProvider||"gemini")===p?C.purple+"25":"transparent",color:(f.aiProvider||"gemini")===p?C.t0:C.t3,fontSize:"0.7rem",fontWeight:600,cursor:"pointer",fontFamily:"inherit"}}>{l}</button>
))}
</div>
</div>
{(f.aiProvider||"gemini")==="gemini"?<div>
<div style={{display:"flex",alignItems:"center",gap:10}}>
<span style={{flex:1,fontSize:"0.8rem",color:C.t2}}>Gemini API Key</span>
<input style={{...z.inpM,maxWidth:200}} type="password" value={f.geminiApiKey||""} onChange={e=>setF({...f,geminiApiKey:e.target.value})} placeholder="AIzaSy..."/>
</div>
<div style={{fontSize:"0.58rem",color:C.t3,marginTop:4}}>ObtÃ©n tu key gratis en <a href="https://aistudio.google.com/apikey" target="_blank" style={{color:C.cyan}}>aistudio.google.com/apikey</a></div>
</div>:<div>
<div style={{display:"flex",alignItems:"center",gap:10}}>
<span style={{flex:1,fontSize:"0.8rem",color:C.t2}}>Groq API Key</span>
<input style={{...z.inpM,maxWidth:200}} type="password" value={f.groqApiKey||""} onChange={e=>setF({...f,groqApiKey:e.target.value})} placeholder="gsk_..."/>
</div>
<div style={{fontSize:"0.58rem",color:C.t3,marginTop:4}}>ObtÃ©n tu key gratis en <a href="https://console.groq.com/keys" target="_blank" style={{color:C.cyan}}>console.groq.com/keys</a> â€” Sin restricciones regionales</div>
</div>}
<div style={{marginTop:10,padding:"10px 12px",background:C.bg2,borderRadius:8,border:`1px solid ${C.b1}`}}>
<div style={{display:"flex",alignItems:"center",gap:6,marginBottom:4}}>
<span style={{fontSize:"0.65rem",fontWeight:600,color:C.green}}>ðŸ“¦ Base de datos de alimentos</span>
</div>
<div style={{fontSize:"0.58rem",color:C.t2}}>Los macros ahora vienen de tu base de datos local ({FOOD_DB.length} alimentos de referencia). Gestiona tus alimentos personales desde el botÃ³n ðŸ¤– â†’ pestaÃ±a ðŸ“¦ Alimentos.</div>
</div>
<div style={{marginTop:10}}>
<div style={{display:"flex",alignItems:"center",gap:6,marginBottom:4}}>
<span style={{fontSize:"0.8rem",color:C.t2}}>Prompt personalizado</span>
<span style={{fontSize:"0.55rem",color:C.t3}}>(contexto que el AI siempre tendrÃ¡)</span>
</div>
<textarea style={{...z.inp,minHeight:120,fontSize:"0.76rem",lineHeight:1.5,fontFamily:"'IBM Plex Mono',monospace"}} value={f.aiPrompt||""} onChange={e=>setF({...f,aiPrompt:e.target.value})} placeholder="Ej: Tengo 24 aÃ±os, mido 1.75m. Quiero bajar grasa manteniendo mÃºsculo. No como mariscos. Entreno PPL 5x/semana..."/>
</div>
</div>
<div style={{display:"flex",gap:8,marginTop:10}}><button style={z.btn(true)} onClick={()=>{sv({...D,settings:f});onClose()}}>Guardar</button><button style={z.btn(false)} onClick={onClose}>Cancelar</button></div>
</div>}/>)};

/* === DAY TYPE EDITOR (grams, not multipliers) === */
const DayTypeEditor=({onClose})=>{
const[types,setTypes]=useState([...dayTypes]);const[ed,setEd]=useState(null);
const[f,setF]=useState({name:"",emoji:"ðŸ‹ï¸",color:"#b8f000",cal:2250,prot:170,carbs:220,fat:65,sugar:40,fiber:25,calMin:2250,calMax:2350});
return(<Mdl title="ðŸ”§ Tipos de DÃ­a" onClose={onClose} wide ch={!ed?(<div>
{types.map(t=>(<div key={t.id} style={{display:"flex",alignItems:"center",gap:6,padding:"8px 0",borderBottom:`1px solid ${C.b1}`,flexWrap:"wrap"}}>
<span style={{fontSize:"1rem"}}>{t.emoji}</span><span style={{flex:1,fontWeight:500,minWidth:80}}>{t.name}</span>
<span style={{fontFamily:"monospace",fontSize:"0.58rem",color:C.t2}}>{t.cal}kcal {t.prot}P {t.carbs}C {t.fat}G â‰¤{t.sugar}S {t.fiber||0}F [{t.calMin}-{t.calMax}]</span>
<button style={z.btnS(false)} onClick={()=>{setEd(t.id);setF({...t})}}>âœï¸</button>
<button style={z.btnD} onClick={()=>setTypes(types.filter(x=>x.id!==t.id))}>âœ•</button></div>))}
<div style={{display:"flex",gap:8,marginTop:12,flexWrap:"wrap"}}>
<button style={z.btn(false)} onClick={()=>{setEd("new");setF({name:"",emoji:"ðŸ‹ï¸",color:"#b8f000",cal:2250,prot:170,carbs:220,fat:65,sugar:40,fiber:25,calMin:2250,calMax:2350})}}>+ Nuevo</button>
<button style={z.btn(true)} onClick={()=>{sv({...D,dayTypes:types});onClose()}}>Guardar</button></div>
</div>):(<div style={{display:"flex",flexDirection:"column",gap:8}}>
<div style={{fontSize:"0.85rem",fontWeight:600,color:C.t1}}>{ed==="new"?"Crear":"Editando: "+f.name}</div>
{[["Nombre","name","text"],["Emoji","emoji","text"],["Color","color","color"]].map(([l,k,t])=>(<div key={k} style={{display:"flex",alignItems:"center",gap:8}}><span style={{width:110,fontSize:"0.76rem",color:C.t2}}>{l}</span><input style={{...z.inpM,maxWidth:t==="color"?55:160}} type={t} value={f[k]} onChange={e=>setF({...f,[k]:e.target.value})}/></div>))}
<div style={{...z.lb,marginTop:6}}>Macros objetivo (gramos)</div>
<div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(90px,1fr))",gap:8}}>
{[["CalorÃ­as","cal"],["ProteÃ­na","prot"],["Carbos","carbs"],["Grasas","fat"],["AzÃºcar mÃ¡x","sugar"],["Fibra","fiber"]].map(([l,k])=>(<div key={k}><div style={{fontSize:"0.6rem",color:C.t3,marginBottom:3}}>{l}</div><input style={z.inpM} type="number" value={f[k]} onChange={e=>setF({...f,[k]:+e.target.value})}/></div>))}</div>
<div style={{...z.lb,marginTop:6}}>Rango CalorÃ­as para Compliance (Kâœ“)</div>
<div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
<div><div style={{fontSize:"0.6rem",color:C.t3,marginBottom:3}}>Min</div><input style={z.inpM} type="number" value={f.calMin} onChange={e=>setF({...f,calMin:+e.target.value})}/></div>
<div><div style={{fontSize:"0.6rem",color:C.t3,marginBottom:3}}>Max</div><input style={z.inpM} type="number" value={f.calMax} onChange={e=>setF({...f,calMax:+e.target.value})}/></div></div>
<div style={{display:"flex",gap:8,marginTop:8}}>
<button style={z.btn(true)} onClick={()=>{let nt;if(ed==="new")nt=[...types,{...f,id:uid()}];else nt=types.map(t=>t.id===ed?{...t,...f}:t);setTypes(nt);setEd(null)}}>Confirmar</button>
<button style={z.btn(false)} onClick={()=>setEd(null)}>Volver</button></div>
</div>)}/>)};

/* === LAYOUT === */
if(ld)return<div style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh",background:C.bg0}}><div style={{fontFamily:"'IBM Plex Mono',monospace",fontSize:"1.6rem",fontWeight:700,background:`linear-gradient(135deg,${C.t0},${C.lime})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>LIFE DASHBOARD</div></div>;

const nav=[{id:"dashboard",icon:"âš¡",lb:"Dashboard"},{id:"fitness",icon:"ðŸ‹ï¸",lb:"Fitness"},{id:"trends",icon:"ðŸ“ˆ",lb:"Tendencias"},{id:"report",icon:"ðŸ“‹",lb:"Reporte"},{id:"projects",icon:"ðŸ“‚",lb:"Proyectos"},{id:"habits",icon:"ðŸŽ¯",lb:"HÃ¡bitos"},{id:"horario",icon:"ðŸ“…",lb:"Horario"},{id:"lectura",icon:"ðŸ“š",lb:"Lectura"}];
const mobNav=[{id:"dashboard",icon:"âš¡"},{id:"fitness",icon:"ðŸ‹ï¸"},{id:"habits",icon:"ðŸŽ¯"},{id:"projects",icon:"ðŸ“‚"},{id:"lectura",icon:"ðŸ“š"}];

return(
<div style={{display:"flex",minHeight:"100vh",background:C.bg0,fontFamily:"'DM Sans',sans-serif",color:C.t0}}>
{/* Mobile hamburger */}
<button className="mob-btn" onClick={()=>setSideOpen(!sideOpen)}>â˜°</button>
{/* Overlay */}
<div className={`sidebar-overlay ${sideOpen?"open":""}`} onClick={()=>setSideOpen(false)}/>
{/* Sidebar */}
<div className={`sidebar ${sideOpen?"open":""}`}>
<div style={{padding:"0 16px 16px",borderBottom:`1px solid ${C.b1}`,marginBottom:10}}>
<div style={{fontFamily:"'IBM Plex Mono',monospace",fontSize:"1.05rem",fontWeight:700,background:`linear-gradient(135deg,${C.t0},${C.lime})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>LIFE DASHBOARD</div>
<div style={{fontFamily:"monospace",fontSize:"0.5rem",color:C.t3,letterSpacing:2,marginTop:2}}>FITNESS OS v6</div></div>
<div style={{flex:1,padding:"4px 10px",overflowY:"auto"}}>
<div style={{fontSize:"0.48rem",textTransform:"uppercase",letterSpacing:2,color:C.t3,padding:"6px 4px 4px",fontWeight:600}}>NavegaciÃ³n</div>
{nav.map(n=><div key={n.id} style={z.navI(pg===n.id)} onClick={()=>go(n.id)}><span style={{width:16,textAlign:"center"}}>{n.icon}</span>{n.lb}</div>)}
<div style={{fontSize:"0.48rem",textTransform:"uppercase",letterSpacing:2,color:C.t3,padding:"12px 4px 4px",fontWeight:600}}>Configurar</div>
<div style={z.navI(false)} onClick={()=>{setModal("dayTypes");setSideOpen(false)}}>ðŸ”§ Tipos de DÃ­a</div>
<div style={z.navI(false)} onClick={()=>{setModal("settings");setSideOpen(false)}}>âš™ Config</div>
</div>
<div style={{padding:"12px 14px",borderTop:`1px solid ${C.b1}`,display:"flex",flexDirection:"column",gap:8}}>
<div style={{display:"flex",alignItems:"center",gap:8,padding:"7px 10px",background:C.lime+"12",border:`1px solid ${C.lime}20`,borderRadius:8,fontSize:"0.65rem",fontWeight:600,color:C.lime}}>
<span style={{width:6,height:6,background:C.lime,borderRadius:"50%",animation:"pulse 2s infinite"}}/> Sem {completedWeek}/{S.cutWeeks} <span style={{fontSize:"0.5rem",color:C.t3}}>(en curso: {currentWeek})</span>
</div>
{/* Sync & Auth */}
{user?(<div style={{display:"flex",flexDirection:"column",gap:6}}>
<div style={{display:"flex",alignItems:"center",gap:6,padding:"6px 10px",background:C.bg2,borderRadius:8,fontSize:"0.62rem"}}>
<img src={user.photoURL||""} style={{width:18,height:18,borderRadius:"50%",border:`1px solid ${C.b1}`}} referrerPolicy="no-referrer"/>
<span style={{flex:1,color:C.t1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{user.displayName||user.email}</span>
</div>
<div style={{display:"flex",alignItems:"center",gap:6,padding:"5px 10px",background:C.bg2,borderRadius:8}}>
<span style={{width:6,height:6,borderRadius:"50%",background:syncStatus==="synced"?C.green:syncStatus==="syncing"?C.orange:syncStatus==="error"?C.red:C.t3,animation:syncStatus==="syncing"?"pulse 1s infinite":"none"}}/>
<span style={{flex:1,fontSize:"0.58rem",color:C.t2}}>{syncStatus==="synced"?"Sincronizado":syncStatus==="syncing"?"Guardando...":syncStatus==="error"?"Error sync":"Local"}</span>
<span onClick={signOut} style={{fontSize:"0.58rem",color:C.t3,cursor:"pointer",textDecoration:"underline"}}>Salir</span>
</div>
</div>):(<div onClick={signIn} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 10px",background:C.bg2,border:`1px solid ${C.b1}`,borderRadius:8,fontSize:"0.68rem",fontWeight:600,color:C.t1,cursor:"pointer"}}>
<span style={{fontSize:"1rem"}}>ðŸ”</span> Iniciar sesiÃ³n
<span style={{fontSize:"0.5rem",color:C.t3,marginLeft:"auto"}}>Sync</span>
</div>)}
</div></div>

{/* Main */}
<div className="main">
{/* Sync error banner - visible on all devices */}
{syncError&&<div onClick={()=>setSyncError("")} style={{display:"flex",alignItems:"center",gap:8,padding:"10px 14px",margin:"0 0 12px",background:C.red+"18",border:`1px solid ${C.red}40`,borderRadius:10,cursor:"pointer"}}>
<span style={{fontSize:"1rem"}}>âš ï¸</span>
<div style={{flex:1,fontSize:"0.7rem",color:C.red,wordBreak:"break-word"}}>{syncError}</div>
<span style={{fontSize:"0.6rem",color:C.t3}}>âœ•</span>
</div>}
{/* Mobile login banner - visible only on mobile when not logged in */}
{!user&&!authLoading&&<div className="mob-login-banner" onClick={signIn} style={{display:"none",alignItems:"center",gap:10,padding:"10px 14px",margin:"0 0 12px",background:`linear-gradient(135deg,${C.bg2},${C.bg3})`,border:`1px solid ${C.lime}30`,borderRadius:10,cursor:"pointer"}}>
<span style={{fontSize:"1.4rem"}}>ðŸ”</span>
<div style={{flex:1}}>
<div style={{fontSize:"0.8rem",fontWeight:700,color:C.t0}}>Iniciar sesiÃ³n</div>
<div style={{fontSize:"0.6rem",color:C.t2}}>Sincroniza tus datos con Google</div>
</div>
<span style={{fontSize:"0.7rem",color:C.lime,fontWeight:600}}>Entrar â†’</span>
</div>}
{pg==="dashboard"&&<DashboardPage/>}
{pg==="fitness"&&<FitnessPage/>}
{pg==="trends"&&<TrendsPage/>}
{pg==="report"&&<ReportPage/>}
{pg==="projects"&&<ProjectsPage/>}
{pg==="habits"&&<HabitsPage/>}
{pg==="horario"&&<HorarioPage/>}
{pg==="lectura"&&<LecturaPage/>}
</div>

{/* AI Assistant */}
<AIAssistant/>

{/* Mobile bottom nav */}
<div className="mob-bar">
{mobNav.map(n=><div key={n.id} onClick={()=>go(n.id)} style={{display:"flex",flexDirection:"column",alignItems:"center",padding:"6px 12px",cursor:"pointer",color:pg===n.id?C.lime:C.t3,fontSize:"1.1rem"}}>
<span>{n.icon}</span><span style={{fontSize:"0.5rem",marginTop:2,fontWeight:600}}>{n.id.slice(0,4)}</span></div>)}
{user?<div onClick={()=>setSideOpen(true)} style={{display:"flex",flexDirection:"column",alignItems:"center",padding:"6px 12px",cursor:"pointer",color:C.t3,fontSize:"1.1rem",position:"relative"}}>
<img src={user.photoURL||""} style={{width:22,height:22,borderRadius:"50%",border:`2px solid ${syncStatus==="synced"?C.green:syncStatus==="syncing"?C.orange:C.t3}`}} referrerPolicy="no-referrer"/>
<span style={{fontSize:"0.5rem",marginTop:2,fontWeight:600,color:syncStatus==="synced"?C.green:C.t2}}>{syncStatus==="synced"?"sync":"..."}</span>
</div>:<div onClick={signIn} style={{display:"flex",flexDirection:"column",alignItems:"center",padding:"6px 12px",cursor:"pointer",color:C.lime,fontSize:"1.1rem"}}>
<span>ðŸ”</span><span style={{fontSize:"0.5rem",marginTop:2,fontWeight:600}}>login</span></div>}
<div onClick={()=>setSideOpen(true)} style={{display:"flex",flexDirection:"column",alignItems:"center",padding:"6px 12px",cursor:"pointer",color:C.t3,fontSize:"1.1rem"}}>
<span>â˜°</span><span style={{fontSize:"0.5rem",marginTop:2,fontWeight:600}}>mÃ¡s</span></div>
</div>

{modal==="settings"&&<SettingsModal onClose={()=>setModal(null)}/>}
{modal==="dayTypes"&&<DayTypeEditor onClose={()=>setModal(null)}/>}
</div>);
}
ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
</script>
</body>
</html>
